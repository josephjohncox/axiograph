(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const f of a)if(f.type==="childList")for(const d of f.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function r(a){const f={};return a.integrity&&(f.integrity=a.integrity),a.referrerPolicy&&(f.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?f.credentials="include":a.crossOrigin==="anonymous"?f.credentials="omit":f.credentials="same-origin",f}function o(a){if(a.ep)return;a.ep=!0;const f=r(a);fetch(a.href,f)}})();function en(){return{nodesEl:document.getElementById("nodes"),detailEl:document.getElementById("detail"),searchEl:document.getElementById("search"),svg:document.getElementById("svg"),serverControlsEl:document.getElementById("server_controls"),show_plane_accepted:document.getElementById("show_plane_accepted"),show_plane_evidence:document.getElementById("show_plane_evidence"),show_plane_data:document.getElementById("show_plane_data"),runFilterEl:document.getElementById("run_filter"),runOnlyEl:document.getElementById("show_only_run"),runClearBtn:document.getElementById("run_clear"),layoutAlgoEl:document.getElementById("layout_algo"),layoutCenterEl:document.getElementById("layout_center"),layoutRefreshBtn:document.getElementById("layout_refresh"),layoutFitBtn:document.getElementById("layout_fit"),layoutResetViewBtn:document.getElementById("layout_reset_view"),labelDensityEl:document.getElementById("label_density"),navHelpEl:document.getElementById("nav_help"),contextFilterEl:document.getElementById("context_filter"),contextBadgeEl:document.getElementById("context_badge"),componentJumpBtn:document.getElementById("jump_component"),componentStatusEl:document.getElementById("component_status"),llmQuestionEl:document.getElementById("llm_question"),llmAutoCommitEl:document.getElementById("llm_auto_commit"),llmCertifyEl:document.getElementById("llm_certify"),llmVerifyEl:document.getElementById("llm_verify"),llmRequireVerifiedEl:document.getElementById("llm_require_verified"),llmAskBtn:document.getElementById("llm_ask"),llmToQueryBtn:document.getElementById("llm_to_query"),llmClearBtn:document.getElementById("llm_clear"),llmStatusEl:document.getElementById("llm_status"),llmChatEl:document.getElementById("llm_chat"),llmCitationsEl:document.getElementById("llm_citations"),llmDebugEl:document.getElementById("llm_debug"),wmGoalsEl:document.getElementById("wm_goals"),wmMaxNewEl:document.getElementById("wm_max_new"),wmSeedEl:document.getElementById("wm_seed"),wmStepsEl:document.getElementById("wm_steps"),wmRolloutsEl:document.getElementById("wm_rollouts"),wmGuardrailProfileEl:document.getElementById("wm_guardrail_profile"),wmGuardrailPlaneEl:document.getElementById("wm_guardrail_plane"),wmIncludeGuardrailEl:document.getElementById("wm_include_guardrail"),wmTaskCostsEl:document.getElementById("wm_task_costs"),wmAutoCommitEl:document.getElementById("wm_auto_commit"),wmCommitStepwiseEl:document.getElementById("wm_commit_stepwise"),wmProposeBtn:document.getElementById("wm_propose"),wmPlanBtn:document.getElementById("wm_plan"),wmStatusEl:document.getElementById("wm_status"),wmOutputEl:document.getElementById("wm_output"),axqlQueryEl:document.getElementById("axql_query"),axqlRunBtn:document.getElementById("axql_run"),axqlCertBtn:document.getElementById("axql_cert"),axqlVerifyBtn:document.getElementById("axql_verify"),axqlStatusEl:document.getElementById("axql_status"),axqlOutputEl:document.getElementById("axql_output"),certOutputEl:document.getElementById("cert_output"),addRelTypeEl:document.getElementById("add_rel_type"),addSourceNameEl:document.getElementById("add_source_name"),addTargetNameEl:document.getElementById("add_target_name"),addPairingEl:document.getElementById("add_pairing"),addContextEl:document.getElementById("add_context"),addCtxFromFilterBtn:document.getElementById("add_ctx_from_filter"),addEvidenceTextEl:document.getElementById("add_evidence_text"),addConfidenceEl:document.getElementById("add_confidence"),addConfidenceValEl:document.getElementById("add_confidence_val"),addMessageEl:document.getElementById("add_message"),addAdminTokenEl:document.getElementById("add_admin_token"),addGenerateBtn:document.getElementById("add_generate"),addCommitBtn:document.getElementById("add_commit"),addStatusEl:document.getElementById("add_status"),addOutputEl:document.getElementById("add_output"),addCommitOutputEl:document.getElementById("add_commit_output"),addDraftAxiBtn:document.getElementById("add_draft_axi"),addPromoteAxiBtn:document.getElementById("add_promote_axi"),addPromoteStatusEl:document.getElementById("add_promote_status"),addAxiTextEl:document.getElementById("add_axi_text"),addPromoteOutputEl:document.getElementById("add_promote_output"),reviewFilterEl:document.getElementById("review_filter"),reviewSelectAllBtn:document.getElementById("review_select_all"),reviewSelectNoneBtn:document.getElementById("review_select_none"),reviewClearBtn:document.getElementById("review_clear"),reviewStatusEl:document.getElementById("review_status"),reviewMessageEl:document.getElementById("review_message"),reviewAdminTokenEl:document.getElementById("review_admin_token"),reviewCommitBtn:document.getElementById("review_commit"),reviewDraftAxiBtn:document.getElementById("review_draft_axi"),reviewPromoteAxiBtn:document.getElementById("review_promote_axi"),reviewListEl:document.getElementById("review_list"),reviewValidationEl:document.getElementById("review_validation"),reviewAxiTextEl:document.getElementById("review_axi_text"),reviewCommitOutputEl:document.getElementById("review_commit_output"),reviewPromoteOutputEl:document.getElementById("review_promote_output"),reviewOverlayRawEl:document.getElementById("review_overlay_raw"),show_entity:document.getElementById("show_entity"),show_fact:document.getElementById("show_fact"),show_morphism:document.getElementById("show_morphism"),show_homotopy:document.getElementById("show_homotopy"),show_meta:document.getElementById("show_meta"),show_edge_relation:document.getElementById("show_edge_relation"),show_edge_equivalence:document.getElementById("show_edge_equivalence"),show_edge_meta:document.getElementById("show_edge_meta"),clearPathBtn:document.getElementById("clear_path"),certifyPathBtn:document.getElementById("certify_path"),verifyPathBtn:document.getElementById("verify_path"),pathStatusEl:document.getElementById("path_status"),minConfidenceEl:document.getElementById("min_confidence"),minConfidenceValEl:document.getElementById("min_confidence_val"),opacityByConfidenceEl:document.getElementById("opacity_by_confidence")}}function nn(t){const e=new Map(t.nodes.map(a=>[a.id,a])),r=new Map,o=new Map;for(const a of t.edges)r.has(a.source)||r.set(a.source,[]),r.get(a.source).push(a),o.has(a.target)||o.set(a.target,[]),o.get(a.target).push(a);return{nodeById:e,outEdgesBySource:r,inEdgesByTarget:o}}function ae(t){return t?t.display_name?String(t.display_name):t.name?String(t.name):t.attrs&&t.attrs.name?String(t.attrs.name):"":""}function on(t){const e=ae(t);return e&&e!==`${t.entity_type}#${t.id}`?`${t.entity_type}#${t.id} — ${e}`:`${t.entity_type}#${t.id}`}function rn(t){return t?t.type_label?String(t.type_label):(t.kind==="fact"||t.kind==="morphism"||t.kind==="homotopy")&&t.attrs&&t.attrs.axi_relation?String(t.attrs.axi_relation):t.entity_type||"(unknown)":"(unknown)"}function an(t){return t.kind==="meta"?"#d6d6d6":t.kind==="morphism"?"#c6f6d5":t.kind==="homotopy"?"#e9d8fd":t.kind==="fact"?"#ffe08a":"#9ec5ff"}function sn(t){const e=t&&t.plane?String(t.plane):"";return e==="accepted"?"#1b5e20":e==="evidence"?"#b85c00":e==="data"?"#2b7fff":e==="meta"?"#777":"#666"}function ln(t){const e=se(t);return!e||!e.fields||!e.fields.length?null:e.fields.map(r=>r.name)}function se(t){if(!t)return null;const e=String(t),r=e.indexOf("("),o=e.lastIndexOf(")");if(r<0||o<=r)return null;const a=e.slice(0,r).trim()||null,f=e.slice(r+1,o).trim();if(!f)return{relation:a,fields:[]};const d=[];for(const E of f.split(",")){const l=E.trim();if(!l)continue;const[H,C]=l.split(":"),I=(H||"").trim(),p=(C||"").trim();I&&d.push({name:I,ty:p||null})}return{relation:a,fields:d}}function cn(t){return t?t.name?String(t.name):`${t.entity_type}#${t.id}`:"(unknown)"}function dn(t){return t?t.kind==="fact"||t.kind==="morphism"||t.kind==="homotopy":!1}function un(t){if(!t||!t.attrs)return"";const e=t.attrs.meta_axiograph_world_model_trace_id||t.attrs.axiograph_world_model_trace_id;return e?String(e):""}function mn(t){return String(t).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function fn(t){return!Number.isFinite(t)||t<0?0:t>1?1:t}function pn(t,e){const{graph:r,ui:o,nodesEl:a,isNodeVisible:f,nodeDisplayName:d,effectiveTypeLabel:E,escapeHtml:l,selectNode:H,selectedIdRef:C}=t;a.innerHTML="",a.classList.remove("node-list-virtual");const I=(e||"").trim().toLowerCase(),p=[];for(const $ of r.nodes){if(!f($))continue;const T=d($),S=`${$.id} ${$.entity_type} ${$.kind||""} ${T}`.toLowerCase();if(I&&!S.includes(I))continue;const P=$.kind||"entity",v=E($);p.push({node:$,disp:T,kind:P,entityType:v})}if(!p.length){a.innerHTML='<div class="muted" style="margin-top:8px;">(no matching nodes)</div>';return}const c=2e3,V=64,ot=6,i=new Map([["entity",0],["fact",1],["morphism",2],["homotopy",3],["meta",4]]);function h($,T){const S=i.has($.kind)?i.get($.kind):99,P=i.has(T.kind)?i.get(T.kind):99;if(S!==P)return S-P;if($.entityType!==T.entityType)return $.entityType.localeCompare(T.entityType);const v=$.disp||"",tt=T.disp||"";return v!==tt?v.localeCompare(tt):$.node.id-T.node.id}if(p.length>c){let $=function(){const st=S.scrollTop||0,lt=S.clientHeight||320,et=Math.max(0,Math.floor(st/V)-ot),pt=Math.min(p.length,et+Math.ceil(lt/V)+ot*2);v.style.transform=`translateY(${et*V}px)`,v.innerHTML="";const at=C?C():null;for(let k=et;k<pt;k++){const O=p[k],w=O.node,K=o.highlightIds&&o.highlightIds.has(w.id),L=document.createElement("div");L.className="node",L.dataset.id=String(w.id),K&&L.classList.add("highlighted"),at!=null&&at===w.id&&L.classList.add("selected"),L.innerHTML=`<div><strong>${l(O.entityType)}</strong> <span class="muted">#${w.id} • ${l(O.kind)}</span></div>`+(O.disp?`<div>${K?"★ ":""}${l(O.disp)}</div>`:'<div class="muted">(no name)</div>'),L.addEventListener("click",Y=>H(w.id,Y.shiftKey)),v.appendChild(L)}};p.sort(h);const T=document.createElement("div");T.className="muted",T.style.marginTop="6px",T.textContent=`showing ${p.length} nodes (virtualized)`,a.appendChild(T);const S=document.createElement("div");S.className="node-list-virtual",a.appendChild(S);const P=document.createElement("div");P.className="node-list-spacer",P.style.height=`${p.length*V}px`,S.appendChild(P);const v=document.createElement("div");v.className="node-list-viewport",S.appendChild(v);let tt=null;S.addEventListener("scroll",()=>{tt&&cancelAnimationFrame(tt),tt=requestAnimationFrame($)}),$();return}const _=new Map;for(const $ of p){const T=`${$.kind}::${$.entityType}`;_.has(T)||_.set(T,{kind:$.kind,entityType:$.entityType,nodes:[]}),_.get(T).nodes.push($.node)}const b=Array.from(_.values()).sort(($,T)=>{const S=i.has($.kind)?i.get($.kind):99,P=i.has(T.kind)?i.get(T.kind):99;return S!==P?S-P:$.entityType.localeCompare(T.entityType)}),W=C?C():null;for(const $ of b){$.nodes.sort((P,v)=>h({node:P,disp:d(P),kind:P.kind||"entity",entityType:E(P)},{node:v,disp:d(v),kind:v.kind||"entity",entityType:E(v)}));const T=document.createElement("details");T.className="nodegroup",T.open=!!I||$.nodes.length<=20;const S=document.createElement("summary");S.innerHTML=`<strong>${l($.entityType)}</strong><span class="muted">${l($.kind)} • ${$.nodes.length}</span>`,T.appendChild(S);for(const P of $.nodes){const v=d(P),tt=document.createElement("div");tt.className="node",tt.dataset.id=String(P.id);const st=o.highlightIds&&o.highlightIds.has(P.id);st&&tt.classList.add("highlighted"),W!=null&&W===P.id&&tt.classList.add("selected"),tt.innerHTML=`<div><strong>${l(E(P))}</strong> <span class="muted">#${P.id} • ${l(P.kind||"entity")}</span></div>`+(v?`<div>${st?"★ ":""}${l(v)}</div>`:'<div class="muted">(no name)</div>'),tt.addEventListener("click",lt=>H(P.id,lt.shiftKey)),T.appendChild(tt)}a.appendChild(T)}}function hn(t){const{graph:e,ui:r,nodeById:o,outEdgesBySource:a,inEdgesByTarget:f,isEdgeVisible:d,detailEl:E,nodeDisplayName:l,effectiveTypeLabel:H,nodeTitle:C,nodeShortLabel:I,isTupleLike:p,escapeHtml:c,parseRelationSignature:V,parseRelationSignatureFieldOrder:ot,factSummary:i,morphismSummary:h,homotopySummary:_,proposalRunSummary:b,documentSummary:W,docChunkSummary:$,categorizeAttrs:T,setActiveDetailTab:S,firstOutTargetId:P,shortenHash:v,isServerMode:tt,selectNode:st}=t;function lt(O,w){const K=new Map;for(const it of O){const X=String(it.label||"");K.has(X)||K.set(X,[]),K.get(X).push(it)}const L=Array.from(K.keys()).sort((it,X)=>it.localeCompare(X));if(!L.length)return'<div class="muted">(none)</div>';const Y=[];for(const it of L){const X=K.get(it)||[];X.sort((N,A)=>{const D=w==="out"?N.target:N.source,j=w==="out"?A.target:A.source;return D-j});const z=X.length<=5,G=X.map(N=>{const A=w==="out"?N.target:N.source,D=o.get(A),j=D?C(D):String(A),B=N.confidence!=null?Number(N.confidence).toFixed(3):"",x=D?`<a class="link" href="#" data-id="${A}">${c(j)}</a>`:c(j),u=c(N.kind||"");return`<tr><td>${x}</td><td class="muted">${u}</td><td class="muted">${B}</td></tr>`}).join("");Y.push(`
      <details ${z?"open":""} style="margin-top:10px;">
        <summary><code>${c(it)}</code><span class="muted" style="margin-left:6px;">${X.length} edge${X.length===1?"":"s"}</span></summary>
        <table style="margin-top:8px;">
          <thead><tr><th>${w==="out"?"to":"from"}</th><th>kind</th><th>conf</th></tr></thead>
          <tbody>${G||'<tr><td class="muted">(none)</td><td></td><td></td></tr>'}</tbody>
        </table>
      </details>
    `)}return Y.join("")}function et(O,w){const K=w&&Number(w.limit)||120,L=w&&w.title?String(w.title):"",Y=w&&w.empty?String(w.empty):"(none)",it=[];for(const A of O||[]){const D=o.get(A);D&&it.push(D)}if(!it.length)return`<div class="muted">${c(Y)}</div>`;const X=new Map;for(const A of it){const D=A.kind||"entity",j=H(A),B=`${D}::${j}`;X.has(B)||X.set(B,{kind:D,entityType:j,nodes:[]}),X.get(B).nodes.push(A)}const z=new Map([["entity",0],["fact",1],["morphism",2],["homotopy",3],["meta",4]]),G=Array.from(X.values()).sort((A,D)=>{const j=z.has(A.kind)?z.get(A.kind):99,B=z.has(D.kind)?z.get(D.kind):99;return j!==B?j-B:A.entityType.localeCompare(D.entityType)}),N=[];L&&N.push(`<h3>${c(L)}</h3>`);for(const A of G){A.nodes.sort((x,u)=>{const n=l(x)||"",g=l(u)||"";return n!==g?n.localeCompare(g):x.id-u.id});const j=A.nodes.slice(0,K).map(x=>{const u=l(x)||C(x);return`<tr><td><a class="link" href="#" data-id="${x.id}">${c(u)}</a></td><td class="muted">${c(x.kind||"entity")}</td></tr>`}).join(""),B=A.nodes.length>K?`<div class="muted" style="margin-top:6px;">showing ${K} of ${A.nodes.length} (increase viz max_nodes/hops for more)</div>`:"";N.push(`
      <details open style="margin-top:10px;">
        <summary><strong>${c(A.entityType)}</strong><span class="muted" style="margin-left:6px;">${c(A.kind)} • ${A.nodes.length}</span></summary>
        <table style="margin-top:8px;"><thead><tr><th>node</th><th>kind</th></tr></thead><tbody>${j}</tbody></table>
        ${B}
      </details>
    `)}return N.join("")}function pt(O){const w=(O||[]).filter(K=>K&&K.length>=2).map(([K,L])=>{if(L==null)return"";const Y=String(L);return Y.trim()?`<tr><td><code>${c(K)}</code></td><td>${c(Y)}</td></tr>`:""}).filter(K=>K.length>0).join("");return w?`<table><tbody>${w}</tbody></table>`:'<div class="muted">(no details)</div>'}function at(O){const w=V(O.attrs&&O.attrs.axi_overlay_relation_signature),K=w&&w.fields?w.fields:null,L=new Map;if(K)for(let G=0;G<K.length;G++)L.set(K[G].name,G);const Y=a.get(O.id)||[],it=[];for(const G of Y){if(!G||G.kind!=="relation")continue;const N=String(G.label||"");if(!N||N==="axi_fact_of"||N==="axi_fact_in_context"||N.startsWith("axi_"))continue;const A=o.get(G.target);it.push({label:N,targetId:G.target,targetNode:A||null})}if(!it.length)return'<div class="muted">(no fields)</div>';it.sort((G,N)=>{const A=L.has(G.label)?L.get(G.label):1e4,D=L.has(N.label)?L.get(N.label):1e4;return A!==D?A-D:G.label.localeCompare(N.label)});const X=new Map;if(K)for(const G of K)X.set(G.name,G.ty||"");return`
    <table>
      <thead><tr><th>field</th><th>type</th><th>value</th></tr></thead>
      <tbody>${it.map(G=>{const N=X.get(G.label)||"",A=G.targetNode?C(G.targetNode):String(G.targetId),D=G.targetNode?`<a class="link" href="#" data-id="${G.targetId}">${c(I(G.targetNode))}</a>`:c(A);return`<tr><td><code>${c(G.label)}</code></td><td>${N?`<span class="muted">${c(N)}</span>`:""}</td><td>${D}</td></tr>`}).join("")}</tbody>
    </table>
  `}function k(O){const w=o.get(O);if(!w)return;E.classList.remove("muted");const K=(a.get(O)||[]).filter(d),L=(f.get(O)||[]).filter(d),Y=w.kind==="fact"?i(w):w.kind==="morphism"?h(w):w.kind==="homotopy"?_(w):null,it=Y||(w.entity_type==="ProposalRun"?b(w):null)||(w.entity_type==="Document"?W(w):null)||(w.entity_type==="DocChunk"?$(w):null),X=w.attrs||{},z=T(X),G=new Map;if(!p(w))for(const u of L){const n=o.get(u.source);if(!n||!p(n))continue;const g=n.attrs&&n.attrs.axi_relation?String(n.attrs.axi_relation):String(n.entity_type||"Fact");G.has(g)||G.set(g,[]),G.get(g).push({field:String(u.label||""),factId:n.id,factNode:n})}const N=(()=>{if(w.entity_type==="ProposalRun"){const g=K.filter(m=>String(m.label||"")==="run_has_proposal").map(m=>m.target);return`
        <div class="muted" style="margin-bottom:10px;">Evidence-plane proposals imported in this run.</div>
        ${et(g,{title:"Proposals (visible in this view)",empty:"(no proposals in this view)",limit:200})}
      `}if(w.entity_type==="Document"){const g=K.filter(m=>String(m.label||"")==="document_has_chunk").map(m=>m.target);return`
        <div class="muted" style="margin-bottom:10px;">Document evidence chunks (extension layer).</div>
        ${et(g,{title:"Chunks (visible in this view)",empty:"(no chunks in this view)",limit:80})}
      `}if(w.entity_type==="DocChunk"){const g=P(w.id,"doc_chunk_about"),m=P(w.id,"chunk_in_document"),s=g!=null?o.get(g):null,F=m!=null?o.get(m):null,R=String(X.text||"").trim(),J=R.length>280?R.slice(0,280)+"…":R;return`
        ${s?`<div class="muted" style="margin-bottom:6px;">about: <a class="link" href="#" data-id="${g}">${c(C(s))}</a></div>`:""}
        ${F?`<div class="muted" style="margin-bottom:10px;">document: <a class="link" href="#" data-id="${m}">${c(C(F))}</a></div>`:""}
        ${J?`<pre style="white-space:pre-wrap; max-height:260px; overflow:auto; margin:0;">${c(J)}</pre>`:'<div class="muted">(no text)</div>'}
      `}if(p(w)){const g=X.axi_overlay_relation_signature?String(X.axi_overlay_relation_signature):"",m=X.axi_overlay_constraints?String(X.axi_overlay_constraints):"";return`
        <div style="margin-bottom:10px;">
          ${Y?`<div><code>${c(Y)}</code></div>`:""}
          <div class="muted" style="margin-top:6px;">Tuple nodes are reified n-ary facts. Some are additionally tagged as <code>Morphism</code> or <code>Homotopy</code> (so arrows/equivalences are first-class objects). This is how we attach context/time/provenance/constraints and later certificates to the *assertion itself*.</div>
        </div>
        ${g?`<div class="muted" style="margin-bottom:6px;">signature: <code>${c(g)}</code></div>`:""}
        ${m?`<div class="muted" style="margin-bottom:10px;">constraints: <code>${c(m)}</code></div>`:""}
        ${at(w)}
      `}const u=Array.from(G.keys()).sort((g,m)=>g.localeCompare(m));if(!u.length)return'<div class="muted">(no fact nodes mention this)</div>';const n=[];for(const g of u){const m=G.get(g)||[];m.sort((F,R)=>F.factId-R.factId);const s=m.map(F=>{const R=F.factNode,J=R?C(R):`Fact#${F.factId}`,Q=R?`<a class="link" href="#" data-id="${F.factId}">${c(i(R)||J)}</a>`:c(J);return`<tr><td><code>${c(F.field)}</code></td><td>${Q}</td></tr>`}).join("");n.push(`
        <details open style="margin-top:10px;">
          <summary><strong>${c(g)}</strong> <span class="muted">(${m.length})</span></summary>
          <table style="margin-top:8px;">
            <thead><tr><th>as field</th><th>fact</th></tr></thead>
            <tbody>${s}</tbody>
          </table>
        </details>
      `)}return n.join("")})(),A=(()=>{if(!tt())return'<div class="muted">DB describe requires server mode (<code>axiograph db serve</code>).</div>';const u=r.describeCache?r.describeCache.get(O):null;if(!u||u.status==="loading")return'<div class="muted">Loading…</div>';if(u.status==="error")return`<pre style="white-space:pre-wrap; max-height:340px; overflow:auto; margin:0;">${c(JSON.stringify(u.data||{error:"unknown"},null,2))}</pre>`;const n=u.data&&u.data.result?u.data.result:u.data;if(!n)return'<div class="muted">(no data)</div>';const g=Array.isArray(n.contexts)?n.contexts:[],m=Array.isArray(n.equivalences)?n.equivalences:[],s=Array.isArray(n.outgoing)?n.outgoing:[],F=Array.isArray(n.incoming)?n.incoming:[];function R(U){if(!U||U.id==null)return"";const ft=Number(U.id),wt=String(U.name||U.id);return o.has(ft)?`<a class="link" href="#" data-id="${ft}">${c(wt)}</a>`:`<a class="link" href="#" data-focus-id="${ft}">${c(wt)}</a>`}function J(U){if(!U.length)return'<div class="muted">(none)</div>';const ft=[];for(const wt of U){if(!wt)continue;const nt=String(wt.rel||""),ut=Number(wt.count||0),M=(Array.isArray(wt.edges)?wt.edges:[]).map(rt=>{const yt=rt&&rt.confidence!=null?Number(rt.confidence).toFixed(3):"1.000",vt=rt&&rt.entity?rt.entity:null,It=R(vt);return`<li><code>${c(yt)}</code> ${It||c(String(vt&&vt.id||""))}</li>`}).join("");ft.push(`
          <details style="margin-top:10px;">
            <summary><code>${c(nt)}</code> <span class="muted">(${ut})</span></summary>
            <ul style="margin-top:8px; padding-left:18px;">${M||'<li class="muted">(no samples)</li>'}</ul>
          </details>
        `)}return ft.join("")}const Q=g.length?`<ul style="margin:0; padding-left:18px;">${g.map(U=>`<li>${R(U)}</li>`).join("")}</ul>`:'<div class="muted">(none)</div>',ct=m.length?`<ul style="margin:0; padding-left:18px;">${m.map(U=>{const ft=U&&U.other?U.other:null,wt=U&&U.kind?String(U.kind):"";return`<li>${R(ft)} ${wt?`<span class="muted">(${c(wt)})</span>`:""}</li>`}).join("")}</ul>`:'<div class="muted">(none)</div>';return`
      <div class="muted" style="margin-bottom:10px;">Full-snapshot details (on-demand; not limited to this neighborhood view).</div>
      <h3>Contexts</h3>
      ${Q}
      <h3 style="margin-top:14px;">Equivalences</h3>
      ${ct}
      <h3 style="margin-top:14px;">Outgoing</h3>
      ${J(s)}
      <h3 style="margin-top:14px;">Incoming</h3>
      ${J(F)}
    `})(),D=(()=>{function u(F){return F.map(([R,J])=>{const Q=String(J),U=R==="text"||R==="search_text"||R==="markdown"?`<pre style="white-space:pre-wrap; max-height:240px; overflow:auto; margin:0;">${c(Q)}</pre>`:c(Q);return`<tr><td><code>${c(R)}</code></td><td>${U}</td></tr>`}).join("")}const n=u(z.other),g=u(z.content),m=u(z.overlay),s=u(z.axi);return`
      ${z.content.length?`<h3>Content</h3><table><tbody>${g}</tbody></table>`:'<div class="muted">(no content fields)</div>'}
      <details style="margin-top:12px;" ${z.other.length?"open":""}>
        <summary>Other attributes <span class="muted">(${z.other.length})</span></summary>
        <table style="margin-top:8px;"><tbody>${n||'<tr><td class="muted">(none)</td><td></td></tr>'}</tbody></table>
      </details>
      <details style="margin-top:12px;">
        <summary>Axi metadata <span class="muted">(${z.axi.length})</span></summary>
        <table style="margin-top:8px;"><tbody>${s||'<tr><td class="muted">(none)</td><td></td></tr>'}</tbody></table>
      </details>
      <details style="margin-top:12px;">
        <summary>Overlay attributes <span class="muted">(${z.overlay.length})</span></summary>
        <table style="margin-top:8px;"><tbody>${m||'<tr><td class="muted">(none)</td><td></td></tr>'}</tbody></table>
      </details>
    `})(),j=(()=>{const u=w.plane?String(w.plane):"",n=w.kind?String(w.kind):"entity",g=(()=>{if(w.entity_type==="ProposalRun"){const m=K.filter(s=>String(s.label||"")==="run_has_proposal").length;return pt([["schema_hint",X.schema_hint],["source_type",X.source_type],["source_locator",X.source_locator],["generated_at",X.generated_at],["proposals_digest",X.proposals_digest?v(X.proposals_digest):""],["visible_proposals",String(m)]])}if(w.entity_type==="Document"){const m=K.filter(s=>String(s.label||"")==="document_has_chunk").length;return pt([["document_id",X.document_id],["visible_chunks",String(m)]])}if(w.entity_type==="DocChunk")return pt([["chunk_id",X.chunk_id],["document_id",X.document_id],["span_id",X.span_id],["page",X.page]]);if(w.entity_type==="AxiMetaTheory"){const m=K.filter(R=>String(R.label||"")==="axi_theory_has_constraint").map(R=>R.target),s=[];for(const R of m){const J=o.get(R);!J||(J.attrs&&J.attrs.axi_constraint_kind?String(J.attrs.axi_constraint_kind):"")!=="named_block"||s.push(J)}return s.sort((R,J)=>String(R.attrs&&R.attrs.axi_constraint_name||R.display_name||"").localeCompare(String(J.attrs&&J.attrs.axi_constraint_name||J.display_name||""))),s.length?`
          <div class="muted" style="margin-bottom:8px;">Named-block constraints are preserved as structured (but opaque) theory content.</div>
          <table><thead><tr><th>named blocks</th></tr></thead><tbody>${s.map(R=>{const J=R.attrs&&R.attrs.axi_constraint_name?String(R.attrs.axi_constraint_name):R.display_name||"";return`<tr><td><a class="link" href="#" data-id="${R.id}">${c(J)}</a></td></tr>`}).join("")}</tbody></table>
        `:'<div class="muted">(no named-block constraints in this view)</div>'}return""})();return`
      <div style="margin-bottom:10px;">
        <div class="muted">type: <code>${c(w.entity_type)}</code> • id: <code>${w.id}</code> • kind: <code>${c(n)}</code>${u?` • plane: <code>${c(u)}</code>`:""}</div>
        ${it?`<div class="muted" style="margin-top:6px;">summary: <code>${c(it)}</code></div>`:""}
      </div>
      ${g||""}
      ${r.pathStart!=null&&r.pathEnd!=null?`<h3>Selected path</h3>
           <div class="muted">Shift-click two nodes (in list or graph) to highlight a shortest path (within the current filtered subgraph).</div>
           <table style="margin-top:8px;"><thead><tr><th>step</th><th>edge</th><th>between</th></tr></thead><tbody>${r.pathEdgeIdxs.length?r.pathEdgeIdxs.map((m,s)=>{const F=e.edges[m],R=o.get(F.source),J=o.get(F.target),Q=R?C(R):String(F.source),ct=J?C(J):String(F.target);return`<tr><td>${s}</td><td><code>${c(F.label)}</code></td><td>${c(Q)} → ${c(ct)}</td></tr>`}).join(""):'<tr><td class="muted">(no path found)</td><td></td><td></td></tr>'}</tbody></table>`:'<div class="muted">(tip: shift-click 2 nodes to highlight a path)</div>'}
    `})();E.innerHTML=`
    <h2 style="margin:0 0 6px 0;">${c(C(w))}</h2>

    <div class="detailtabs">
      <button class="detailtabbtn" data-dtab="overview" type="button">overview</button>
      <button class="detailtabbtn" data-dtab="facts" type="button">${p(w)?"tuple":"facts"}</button>
      <button class="detailtabbtn" data-dtab="edges" type="button">edges</button>
      <button class="detailtabbtn" data-dtab="attrs" type="button">attrs</button>
      <button class="detailtabbtn" data-dtab="db" type="button">db</button>
    </div>

    <div class="detailtabpanel" data-dtab="overview">${j}</div>
    <div class="detailtabpanel" data-dtab="facts">${N}</div>
    <div class="detailtabpanel" data-dtab="edges">
      <h3>Outgoing</h3>
      ${lt(K,"out")}
      <h3 style="margin-top:16px;">Incoming</h3>
      ${lt(L,"in")}
    </div>
    <div class="detailtabpanel" data-dtab="attrs">${D}</div>
    <div class="detailtabpanel" data-dtab="db">${A}</div>
  `;const B=p(w)?"facts":"overview",x=r.detailTab||B;S(x);for(const u of E.querySelectorAll(".detailtabbtn"))u.addEventListener("click",()=>S(u.dataset&&u.dataset.dtab||"overview"));for(const u of E.querySelectorAll("a.link"))u.addEventListener("click",n=>{n.preventDefault();const g=Number(u.dataset.id||"0"),m=Number(u.dataset.focusId||"0");if(g){st(g,!1);return}if(m&&tt()){const s=new URLSearchParams(window.location.search||"");s.set("focus_id",String(m)),s.delete("focus_name"),window.location.search=s.toString()}})}return{renderDetail:k}}function gn(t){const{graph:e,ui:r,svg:o,nodeById:a,outEdgesBySource:f,inEdgesByTarget:d,isNodeVisible:E,isEdgeVisible:l,nodeDisplayName:H,nodeTitle:C,nodeColor:I,planeStrokeColor:p,edgeColor:c,edgeConfidence:V,selectNode:ot,visibleEdgeIdxsAll:i,opacityByConfidenceEl:h,labelDensityEl:_,bfsDepths:b,showContextMenu:W}=t;function $(T){const S=e.summary&&e.summary.focus_ids&&e.summary.focus_ids.length?e.summary.focus_ids:e.nodes.length?[e.nodes[0].id]:[],P=r.layoutCenter==="selected"&&T!=null?[T]:S;if(!P.length)return;const v=i(),tt=r.layoutAlgo||"radial";let st=new Map,lt=1e3,et=800;if(tt==="type_columns"){const N=new Map;for(const u of e.nodes){if(!E(u))continue;const n=String(u.entity_type||"Entity");N.has(n)||N.set(n,[]),N.get(n).push(u)}const A=Array.from(N.keys()).sort((u,n)=>u.localeCompare(n));for(const u of A)N.get(u).sort((n,g)=>n.id-g.id);const D=80,j=220,B=70,x=Math.max(1,...A.map(u=>N.get(u).length));lt=Math.max(1e3,D*2+A.length*j),et=Math.max(800,D*2+x*B);for(let u=0;u<A.length;u++){const n=A[u],g=N.get(n);for(let m=0;m<g.length;m++){const s=D+u*j+j/2,F=D+m*B+B/2;st.set(g[m].id,{x:s,y:F,d:0})}}}else if(tt==="random"){let N=function(j){let B=(j^A)>>>0;return B^=B<<13,B>>>=0,B^=B>>>17,B>>>=0,B^=B<<5,B>>>=0,B>>>0};const A=(Number(r.layoutSeed||0)^2654435769)>>>0,D=80;lt=1e3,et=800;for(const j of e.nodes){if(!E(j))continue;const B=N(j.id*2654435761),x=N(j.id*1597334677+1013904223),u=D+B/4294967295*(lt-2*D),n=D+x/4294967295*(et-2*D);st.set(j.id,{x:u,y:n,d:0})}}else{const N=b(P,v),A=Math.max(...Array.from(N.values()),0),D=[];for(let B=0;B<=A;B++)D.push([]);for(const B of e.nodes){if(!E(B))continue;const x=N.has(B.id)?N.get(B.id):A+1;D[x]||(D[x]=[]),D[x].push(B)}for(const B of D)B.sort((x,u)=>x.id-u.id);const j=80;if(tt==="grid"){const u=Math.max(1,...D.map(n=>n?n.length:0));lt=Math.max(1e3,j*2+u*90),et=Math.max(800,j*2+D.length*90);for(let n=0;n<D.length;n++){const g=D[n];if(!g||!g.length)continue;const m=g.length,s=lt-2*j,F=Math.max(0,(m-1)*90),R=j+Math.max(0,(s-F)/2);for(let J=0;J<m;J++){const Q=R+J*90,ct=j+n*90+90/2;st.set(g[J].id,{x:Q,y:ct,d:n})}}}else{lt=1e3,et=800;const B=lt/2,x=et/2,u=120,n=40;for(let g=0;g<D.length;g++){const m=D[g];if(!m||!m.length)continue;const s=n+g*u,F=m.length,R=(Number(r.layoutSeed||0)+g*97)%Math.max(1,F);for(let J=0;J<F;J++){const Q=(J+R)%F,ct=2*Math.PI*Q/F-Math.PI/2,U=B+s*Math.cos(ct),ft=x+s*Math.sin(ct);st.set(m[J].id,{x:U,y:ft,d:g})}}}}r.nodePos=st,o.getAttribute("viewBox")||o.setAttribute("viewBox",`0 0 ${lt} ${et}`),o.innerHTML="";const pt=document.createElementNS("http://www.w3.org/2000/svg","defs");pt.innerHTML=`
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#666"></path>
    </marker>
  `,o.appendChild(pt);let at=1/0,k=1/0,O=-1/0,w=-1/0,K=0;const L=_?String(_.value||"smart"):"smart",Y=L==="all"?!0:L==="none"?!1:K<=900;for(const N of e.nodes){if(!E(N))continue;const A=st.get(N.id);A&&(at=Math.min(at,A.x),k=Math.min(k,A.y),O=Math.max(O,A.x),w=Math.max(w,A.y),K++)}Number.isFinite(at)&&Number.isFinite(k)&&Number.isFinite(O)&&Number.isFinite(w)?r.layoutBounds={minX:at,minY:k,maxX:O,maxY:w,W:lt,H:et}:r.layoutBounds={minX:0,minY:0,maxX:lt,maxY:et,W:lt,H:et};const it=2200,X=new Set(r.pathEdgeIdxs||[]);let z=v.slice();if(z.length>it){const N=new Set(z.slice(0,it));for(const A of X)N.add(A);z=Array.from(N).sort((A,D)=>A-D)}const G=new Set;if(T!=null)for(const N of v){const A=e.edges[N];A.source===T&&G.add(A.target),A.target===T&&G.add(A.source)}for(const N of z){const A=e.edges[N],D=st.get(A.source),j=st.get(A.target);if(!D||!j)continue;const B=document.createElementNS("http://www.w3.org/2000/svg","line");B.setAttribute("x1",D.x),B.setAttribute("y1",D.y),B.setAttribute("x2",j.x),B.setAttribute("y2",j.y);const x=X.has(N),u=T!=null&&(A.source===T||A.target===T),n=V(A);B.setAttribute("stroke",x?"#ff006e":c(A));const m=(x?2.8:u?2.1:A.kind==="equivalence"?1.5:1.2)*(.85+.3*n);B.setAttribute("stroke-width",String(m.toFixed(2)));const s=x?.95:T!=null&&!u?.45:.85,F=h&&h.checked?.2+.8*n:1;B.setAttribute("opacity",String((s*F).toFixed(3))),A.kind==="equivalence"&&B.setAttribute("stroke-dasharray","4 4"),(A.kind==="meta_relation"||A.kind==="meta_virtual")&&B.setAttribute("stroke-dasharray","2 4"),B.setAttribute("marker-end","url(#arrow)");const R=document.createElementNS("http://www.w3.org/2000/svg","title"),J=A.confidence!=null?` (${Number(A.confidence).toFixed(3)})`:"";R.textContent=`${A.label}${J}`,B.appendChild(R),o.appendChild(B)}for(const N of e.nodes){if(!E(N))continue;const A=st.get(N.id);if(!A)continue;const D=document.createElementNS("http://www.w3.org/2000/svg","g");D.setAttribute("data-id",String(N.id)),D.style.cursor="pointer";const j=document.createElementNS("http://www.w3.org/2000/svg","circle");j.setAttribute("cx",A.x),j.setAttribute("cy",A.y);const B=N.id===T,x=G.has(N.id),u=r.highlightIds&&r.highlightIds.has(N.id),n=B?12:x||u?10:9;if(j.setAttribute("r",String(n)),j.setAttribute("fill",I(N)),j.setAttribute("stroke",p(N)),j.setAttribute("stroke-width","2.0"),j.setAttribute("opacity",T!=null&&!B&&!x?"0.65":"1.0"),B||x||u){const s=document.createElementNS("http://www.w3.org/2000/svg","circle");s.setAttribute("cx",A.x),s.setAttribute("cy",A.y),s.setAttribute("r",String(n+3)),s.setAttribute("fill","none"),s.setAttribute("stroke",B?"#2b7fff":x?"#ff006e":"#ff9800"),s.setAttribute("stroke-width","2.2"),s.setAttribute("opacity",T!=null&&!B&&!x?"0.55":"0.95"),D.appendChild(s)}if(D.appendChild(j),L==="none"?B||x||u:Y||B||x||u){const s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",A.x),s.setAttribute("y",A.y-14),s.setAttribute("text-anchor","middle"),s.setAttribute("font-size","10"),s.setAttribute("fill","#333"),s.setAttribute("stroke","#fff"),s.setAttribute("stroke-width","3.5"),s.setAttribute("paint-order","stroke"),s.setAttribute("stroke-linejoin","round");const F=H(N)||`${N.entity_type}#${N.id}`;s.textContent=F.length>24?F.slice(0,24)+"…":F,s.setAttribute("opacity",T!=null&&!B&&!x?"0.65":"1.0"),D.appendChild(s)}D.addEventListener("click",s=>ot(N.id,s.shiftKey)),W&&D.addEventListener("contextmenu",s=>{s.preventDefault(),s.stopPropagation(),W({kind:"node",nodeId:N.id,x:s.clientX,y:s.clientY})});const m=document.createElementNS("http://www.w3.org/2000/svg","title");m.textContent=C?C(N):`${N.entity_type}#${N.id}`,D.appendChild(m),o.appendChild(D)}}return{renderGraph:$}}async function yn(t){const{serverControlsEl:e,graph:r,ui:o,selectedIdRef:a,setLlmStatus:f,setWorldModelStatus:d,llmHistoryStorageKey:E,loadLlmHistoryForKey:l,renderLlmChat:H,draftOverlayStorageKey:C,loadDraftOverlayForKey:I,saveDraftOverlay:p,renderDraftOverlayReview:c,getLlmHistory:V,setLlmHistory:ot,getLlmHistoryKey:i,setLlmHistoryKey:h,getDraftOverlayKey:_,setDraftOverlayKey:b,pickRandomComponentNode:W,llmStatusEl:$,wmStatusEl:T}=t;if(!e)return;const S=window.location&&window.location.protocol;if(S==="http:"||S==="https:")try{let P=function(M){const rt=new URLSearchParams(window.location.search||"");M?rt.set("snapshot",M):rt.delete("snapshot"),window.location.search=rt.toString()},v=function(M){const rt=new URLSearchParams(window.location.search||"");for(const[yt,vt]of Object.entries(M))vt==null||vt===""?rt.delete(yt):rt.set(yt,String(vt));window.location.search=rt.toString()};const[tt,st,lt]=await Promise.all([fetch("/status",{cache:"no-store"}),fetch("/snapshots",{cache:"no-store"}),fetch("/contexts",{cache:"no-store"})]);if(!tt.ok||!st.ok)return;const et=await tt.json(),pt=await st.json(),at=lt&&lt.ok?await lt.json():null;try{const M=et&&et.snapshot&&et.snapshot.accepted_snapshot_id?String(et.snapshot.accepted_snapshot_id):"";M&&localStorage.setItem("axiograph_server_accepted_snapshot_id",M)}catch{}try{const M=E(),rt=i();if(M&&M!==rt){const yt=l(M),vt=V();yt.length?ot(yt):vt.length&&localStorage.setItem(M,JSON.stringify(vt)),h(M),H()}}catch{}try{const M=C(),rt=_();if(M&&M!==rt){const yt=I(M);yt&&yt.proposals_json?(o.draftOverlay=yt,Array.isArray(yt.proposals_json.proposals)?o.draftSelected=new Set(yt.proposals_json.proposals.map(vt=>String(vt&&vt.proposal_id||"")).filter(Boolean)):o.draftSelected=new Set):o.draftOverlay&&localStorage.setItem(M,JSON.stringify(o.draftOverlay)),b(M),p(),c()}}catch{}et&&et.llm&&$&&(et.llm.enabled?f(`ready (${et.llm.backend})`):f("disabled")),et&&et.world_model&&T&&(et.world_model.enabled?d(`ready (${et.world_model.backend})`):d("disabled"));const k=Array.isArray(pt.snapshots)?pt.snapshots:[];if(!k.length)return;const O=pt.layer||"",w=O==="pathdb"?et.snapshot&&et.snapshot.pathdb_snapshot_id:et.snapshot&&et.snapshot.accepted_snapshot_id,L=new URLSearchParams(window.location.search||"").get("snapshot")||w||k[0].snapshot_id,Y=k.findIndex(M=>M.snapshot_id===L),it=document.createElement("span");it.textContent="snapshot:";const X=document.createElement("button");X.className="btn",X.textContent="Head",X.addEventListener("click",()=>P(null));const z=document.createElement("button");z.className="btn",z.textContent="Newer",z.disabled=!(Y>0),z.addEventListener("click",()=>{Y>0&&P(k[Y-1].snapshot_id)});const G=document.createElement("button");G.className="btn",G.textContent="Older",G.disabled=!(Y>=0&&Y+1<k.length),G.addEventListener("click",()=>{Y>=0&&Y+1<k.length&&P(k[Y+1].snapshot_id)});const N=document.createElement("select");for(const M of k){const rt=document.createElement("option"),yt=M.message?` — ${M.message}`:"";rt.value=M.snapshot_id,rt.textContent=`${M.snapshot_id}${yt}`,N.appendChild(rt)}N.value=L,N.addEventListener("change",()=>P(N.value));const A=document.createElement("span");A.className="muted",A.textContent=`layer=${O} snapshots=${k.length}`,e.innerHTML="";const D=document.createElement("div");D.className="server-row",D.appendChild(it),D.appendChild(X),D.appendChild(z),D.appendChild(G),D.appendChild(N),D.appendChild(A),e.appendChild(D);const j=new URLSearchParams(window.location.search||""),B=j.get("focus_name")||"",x=j.get("focus_id")||"",u=["1","true","yes","on"].includes(String(j.get("all")||"").toLowerCase()),n=document.createElement("span");n.textContent="focus:";const g=document.createElement("input");g.placeholder="name",g.value=B||"";const m=document.createElement("input");m.placeholder="id",m.value=x||"",m.style.width="90px";const s=document.createElement("button");s.className="btn",s.textContent="go name",s.addEventListener("click",()=>{const M=(g.value||"").trim();M&&v({focus_name:M,focus_id:null,all:null})});const F=document.createElement("button");F.className="btn",F.textContent="go id",F.addEventListener("click",()=>{const M=(m.value||"").trim();M&&v({focus_id:M,focus_name:null,all:null})});const R=document.createElement("button");R.className="btn",R.textContent="focus selected",R.addEventListener("click",()=>{const M=a();M!=null&&v({focus_id:M,focus_name:null,all:null})});const J=document.createElement("button");J.className="btn",J.textContent=u?"all ✓":"all",J.addEventListener("click",()=>{v({all:"1",focus_name:null,focus_id:null})});const Q=document.createElement("button");Q.className="btn",Q.textContent="neighborhood",Q.disabled=!u,Q.addEventListener("click",()=>{v({all:null})});const ct=o.components?o.components.length:0,U=document.createElement("button");U.className="btn",U.textContent=ct>1?`other component (${ct})`:"other component",U.disabled=ct<2,U.title=ct<2?"No other components (try all view).":"Jump to a different connected component.",U.addEventListener("click",()=>{let M=null;if(x){const vt=Number(x);Number.isFinite(vt)&&(M=vt)}const rt=a();if(M==null&&rt!=null&&(M=rt),M==null&&r.summary&&Array.isArray(r.summary.focus_ids)&&r.summary.focus_ids.length){const vt=Number(r.summary.focus_ids[0]);Number.isFinite(vt)&&(M=vt)}const yt=W(M);yt!=null&&v({focus_id:yt,focus_name:null,all:null})});const ft=document.createElement("select"),wt=document.createElement("span");wt.textContent="context:";const nt=document.createElement("option");nt.value="",nt.textContent="(focus)",ft.appendChild(nt);const ut=at&&Array.isArray(at.contexts)?at.contexts:Array.isArray(r.contexts)?r.contexts:[];for(const M of ut){const rt=document.createElement("option");rt.value=String(M.id),rt.textContent=M.name?`${M.name} (#${M.id})`:`Context#${M.id}`,ft.appendChild(rt)}ft.addEventListener("change",()=>{const M=String(ft.value||"");M&&v({focus_id:M,focus_name:null,all:null})});const gt=document.createElement("div");gt.className="server-row",gt.appendChild(n),gt.appendChild(g),gt.appendChild(s),gt.appendChild(m),gt.appendChild(F),gt.appendChild(R),gt.appendChild(J),gt.appendChild(Q),gt.appendChild(U),ut.length&&(gt.appendChild(wt),gt.appendChild(ft)),e.appendChild(gt)}catch{}}function vn(t){const{ui:e,llmStatusEl:r,llmQuestionEl:o,llmAutoCommitEl:a,llmCertifyEl:f,llmVerifyEl:d,llmRequireVerifiedEl:E,llmAskBtn:l,llmToQueryBtn:H,llmClearBtn:C,llmChatEl:I,llmCitationsEl:p,llmDebugEl:c,axqlQueryEl:V,addMessageEl:ot,addAdminTokenEl:i,selectedContextFilter:h,setActiveTab:_,setAxqlStatus:b,rerender:W,prefillAddFromToolLoop:$,clearHighlights:T,highlightFromToolLoop:S}=t;function P(n){r&&(r.textContent=n||"")}function v(){const n=window.location&&window.location.host?window.location.host:"offline";let g="";try{const m=(localStorage.getItem("axiograph_server_accepted_snapshot_id")||"").trim();m&&(g=m)}catch{}return g||(g=(new URLSearchParams(window.location.search||"").get("snapshot")||"").trim()),g||(g="default"),`axiograph_llm_history_v2:${n}:${g}`}let tt=v();function st(){return tt}function lt(n){tt=n}function et(n){try{let g=localStorage.getItem(n)||"";if(!g.trim()){const s=window.location&&window.location.host?window.location.host:"offline";g=localStorage.getItem(`axiograph_llm_history_v1:${s}`)||""}if(!g.trim())return[];const m=JSON.parse(g);return Array.isArray(m)?m.map(s=>({role:String(s&&s.role||""),content:String(s&&s.content||""),public_rationale:String(s&&s.public_rationale||""),citations:Array.isArray(s&&s.citations)?s.citations.map(F=>String(F)):[],queries:Array.isArray(s&&s.queries)?s.queries.map(F=>String(F)):[],notes:Array.isArray(s&&s.notes)?s.notes.map(F=>String(F)):[]})).filter(s=>s.role&&s.content):[]}catch{return[]}}function pt(){try{localStorage.setItem(tt,JSON.stringify(at))}catch{}}let at=et(tt);function k(){return at}function O(n){at=n||[]}function w(n){if(p){if(n==null){p.textContent="";return}try{typeof n=="string"?p.textContent=n:p.textContent=JSON.stringify(n,null,2)}catch{p.textContent=String(n)}}}async function K(n){const g=window.location&&window.location.protocol;if(!(g==="http:"||g==="https:")){w("DocChunk lookup requires server mode (open via `axiograph db serve`).");return}const m=String(n||"").trim();if(m){w(`loading ${m}…`);try{const F=new URLSearchParams(window.location.search||"").get("snapshot"),R=new URLSearchParams;R.set("chunk_id",m),R.set("max_chars","4000"),F&&R.set("snapshot",F);const J=await fetch(`/docchunk/get?${R.toString()}`),Q=await J.json();if(!J.ok){w(Q);return}w(Q);const ct=Q&&Q.result&&typeof Q.result.id=="number"?Q.result.id:null;typeof ct=="number"&&(e.highlightIds=new Set([ct]),W())}catch(s){w(String(s))}}}function L(){if(I){if(I.innerHTML="",!at.length){const n=document.createElement("div");n.className="muted",n.textContent="Ask a question to start a conversation.",I.appendChild(n);return}for(const n of at){const g=document.createElement("div");g.className=`llmmsg ${n.role||"unknown"}`;const m=document.createElement("div");m.className="role",m.textContent=(n.role||"unknown")+":";const s=document.createElement("div");s.className="text",s.textContent=String(n.content||""),g.appendChild(m),g.appendChild(s);const F=n&&typeof n.public_rationale=="string"?n.public_rationale.trim():"";if(F){const Q=document.createElement("details");Q.style.marginTop="6px";const ct=document.createElement("summary");ct.className="muted",ct.textContent="rationale";const U=document.createElement("pre");U.style.whiteSpace="pre-wrap",U.style.maxHeight="160px",U.style.overflow="auto",U.style.margin="6px 0 0 0",U.textContent=F,Q.appendChild(ct),Q.appendChild(U),g.appendChild(Q)}const R=Array.isArray(n.citations)?n.citations.filter(Boolean):[];if(R.length){const Q=document.createElement("div");Q.className="muted",Q.style.marginTop="6px",Q.textContent=`citations (${R.length}): `;for(const ct of R.slice(0,8)){const U=String(ct),ft=document.createElement("button");ft.type="button",ft.className="btn",ft.style.padding="2px 8px",ft.style.marginLeft="6px",ft.textContent=U,ft.title="Open DocChunk",ft.addEventListener("click",()=>K(U)),Q.appendChild(ft)}if(R.length>8){const ct=document.createElement("span");ct.className="muted",ct.textContent=` +${R.length-8} more`,Q.appendChild(ct)}g.appendChild(Q)}const J=Array.isArray(n.queries)?n.queries.filter(Boolean):[];if(J.length){const Q=document.createElement("details");Q.style.marginTop="6px";const ct=document.createElement("summary");ct.className="muted",ct.textContent=`queries (${J.length})`;const U=document.createElement("pre");U.style.whiteSpace="pre-wrap",U.style.maxHeight="200px",U.style.overflow="auto",U.style.margin="6px 0 0 0",U.textContent=J.join(`
`),Q.appendChild(ct),Q.appendChild(U),g.appendChild(Q)}I.appendChild(g)}I.scrollTop=I.scrollHeight}}function Y(n,g,m){const s=m&&typeof m=="object"?m:{};at.push({role:n,content:String(g||""),public_rationale:String(s.public_rationale||""),citations:Array.isArray(s.citations)?s.citations.map(F=>String(F)):[],queries:Array.isArray(s.queries)?s.queries.map(F=>String(F)):[],notes:Array.isArray(s.notes)?s.notes.map(F=>String(F)):[]}),at.length>40&&at.splice(0,at.length-40);for(const F of at)F&&typeof F.content=="string"&&F.content.length>2800&&(F.content=F.content.slice(0,2800)+"…");pt(),L()}L();function it(){try{const n=localStorage.getItem("axiograph_llm_auto_commit")||"";a&&(a.checked=n==="1"||n==="true"||n==="yes"||n==="on")}catch{}}function X(){try{if(!a)return;localStorage.setItem("axiograph_llm_auto_commit",a.checked?"1":"0")}catch{}}it(),a&&a.addEventListener("change",X);function z(){try{const n=localStorage.getItem("axiograph_llm_certify")||"";f&&(f.checked=n==="1"||n==="true"||n==="yes"||n==="on")}catch{}}function G(){try{if(!f)return;localStorage.setItem("axiograph_llm_certify",f.checked?"1":"0")}catch{}}function N(){try{const n=localStorage.getItem("axiograph_llm_verify")||"";d&&(d.checked=n==="1"||n==="true"||n==="yes"||n==="on")}catch{}}function A(){try{if(!d)return;localStorage.setItem("axiograph_llm_verify",d.checked?"1":"0")}catch{}}function D(){try{const n=localStorage.getItem("axiograph_llm_require_verified")||"";E&&(E.checked=n==="1"||n==="true"||n==="yes"||n==="on")}catch{}}function j(){try{if(!E)return;localStorage.setItem("axiograph_llm_require_verified",E.checked?"1":"0")}catch{}}z(),N(),D(),f&&f.addEventListener("change",G),d&&d.addEventListener("change",A),E&&E.addEventListener("change",j);function B(n){if(c)try{c.textContent=n?JSON.stringify(n,null,2):""}catch{c.textContent=String(n||"")}}async function x(){if(!o)return;const n=String(o.value||"").trim();if(!n)return;const g=window.location&&window.location.protocol;if(!(g==="http:"||g==="https:")){P("LLM requires server mode (open via `axiograph db serve`).");return}const m=at.slice(-40).map(R=>({role:String(R&&R.role||""),content:String(R&&R.content||"")}));Y("user",n),P("asking…"),B(null),w(null);const s=h(),F=[];s!=="*"&&s!=="__none__"&&F.push(s);try{const J=new URLSearchParams(window.location.search||"").get("snapshot"),Q=a&&a.checked,ct=(i&&i.value||"").trim(),U={question:n,contexts:F,history:m};J&&(U.snapshot=J),f&&f.checked&&(U.certify_queries=!0),d&&d.checked&&(U.verify_queries=!0,U.certify_queries=!0),E&&E.checked&&(U.require_verified_queries=!0,U.verify_queries=!0,U.certify_queries=!0),Q&&(U.auto_commit=!0,ot&&String(ot.value||"").trim()?U.commit_message=String(ot.value||"").trim():U.commit_message=`llm: ${n}`);const ft={"content-type":"application/json"};ct&&(ft.authorization=`Bearer ${ct}`);const wt=await fetch("/llm/agent",{method:"POST",headers:ft,body:JSON.stringify(U)}),nt=await wt.json();if(!wt.ok){P(`error (${wt.status})`),B(nt),Y("assistant",nt&&nt.error?nt.error:"LLM request failed.");return}P("ok"),B(nt);const ut=nt&&nt.outcome?nt.outcome:null;if(ut&&ut.final_answer&&ut.final_answer.answer?Y("assistant",ut.final_answer.answer,{public_rationale:ut.final_answer.public_rationale||"",citations:ut.final_answer.citations||[],queries:ut.final_answer.queries||[],notes:ut.final_answer.notes||[]}):Y("assistant","No answer."),$(ut))if(Q){const M=nt&&nt.commit?nt.commit:null;if(M&&M.ok&&M.snapshot_id){Y("assistant",`Committed WAL snapshot ${M.snapshot_id}. Reloading…`);const rt=new URLSearchParams(window.location.search||"");rt.set("snapshot",M.snapshot_id),window.location.search=rt.toString();return}M&&M.error?Y("assistant",`Auto-commit failed: ${M.error}`):Y("assistant","Auto-commit did not apply any changes (no generated overlay).")}else Y("assistant","Review the generated overlay in the Add tab, then click commit to apply it (requires master/admin token).");s.clearHighlights(),S(ut),W()}catch(R){P("error"),Y("assistant",String(R))}}l&&l.addEventListener("click",x);async function u(){if(!o||!V)return;const n=String(o.value||"").trim();if(!n)return;const g=window.location&&window.location.protocol;if(!(g==="http:"||g==="https:")){P("LLM requires server mode (open via `axiograph db serve`).");return}P("to_query…"),B(null);try{const s=new URLSearchParams(window.location.search||"").get("snapshot"),F={question:n};s&&(F.snapshot=s);const R=await fetch("/llm/to_query",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(F)}),J=await R.json();if(!R.ok){P(`error (${R.status})`),B(J);return}J&&typeof J.axql=="string"&&J.axql.trim()?(V.value=J.axql,b("filled from llm"),_("query")):b("LLM returned no query"),P("ok"),B(J)}catch(m){P("error"),B(String(m))}}return H&&H.addEventListener("click",u),o&&o.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),x())}),C&&C.addEventListener("click",()=>{P(""),at.splice(0,at.length),pt(),L(),B(null),w(null),t.clearHighlights(),W()}),{setLlmStatus:P,renderLlmChat:L,llmHistoryStorageKey:v,loadLlmHistoryForKey:et,saveLlmHistory:pt,getLlmHistory:k,setLlmHistory:O,getLlmHistoryKey:st,setLlmHistoryKey:lt,setLlmDebug:B,setLlmCitations:w,highlightFromToolLoop:S}}function wn(t){const{ui:e,axqlStatusEl:r,axqlOutputEl:o,certOutputEl:a,axqlQueryEl:f,axqlRunBtn:d,axqlCertBtn:E,axqlVerifyBtn:l,selectedContextFilter:H,clearHighlights:C,highlightFromQueryResponse:I,rerender:p}=t;function c(h){r&&(r.textContent=h||"")}function V(h){if(o){if(h==null){o.textContent="";return}try{typeof h=="string"?o.textContent=h:o.textContent=JSON.stringify(h,null,2)}catch{o.textContent=String(h)}}}function ot(h){if(a){if(h==null){a.textContent="";return}try{typeof h=="string"?a.textContent=h:a.textContent=JSON.stringify(h,null,2)}catch{a.textContent=String(h)}}}async function i(h,_){if(!f)return;const b=String(f.value||"").trim();if(!b)return;const W=window.location&&window.location.protocol;if(!(W==="http:"||W==="https:")){c("AxQL requires server mode (open via `axiograph db serve`).");return}c(_?"certifying+verifying…":h?"certifying…":"running…"),V(""),ot("");const $=H(),T=[];$!=="*"&&$!=="__none__"&&T.push($);try{const P=new URLSearchParams(window.location.search||"").get("snapshot"),v={query:b,lang:"axql",show_elaboration:!0,contexts:T,certify:!!h,verify:!!_,include_anchor:!1};P&&(v.snapshot=P);const tt=await fetch("/query",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(v)}),st=await tt.json();if(!tt.ok){c(`error (${tt.status})`),V(st);return}c("ok"),V(st),st&&st.certificate&&ot(st.certificate),C(),I(st),p()}catch(S){c("error"),V(String(S))}}return d&&d.addEventListener("click",()=>i(!1,!1)),E&&E.addEventListener("click",()=>i(!0,!1)),l&&l.addEventListener("click",()=>i(!0,!0)),f&&f.addEventListener("keydown",h=>{(h.ctrlKey||h.metaKey)&&h.key==="Enter"&&(h.preventDefault(),i(!1,!1))}),{setAxqlStatus:c,setAxqlOutput:V,setCertOutput:ot}}function Zt(t){const r=String(t||"").split(/[\n,;]+/g).map(f=>f.trim()).filter(f=>f.length>0),o=new Set,a=[];for(const f of r){const d=f.toLowerCase();o.has(d)||(o.add(d),a.push(f))}return a}function _n(t){const{ui:e,wmGoalsEl:r,wmMaxNewEl:o,wmSeedEl:a,wmStepsEl:f,wmRolloutsEl:d,wmGuardrailProfileEl:E,wmGuardrailPlaneEl:l,wmIncludeGuardrailEl:H,wmTaskCostsEl:C,wmAutoCommitEl:I,wmCommitStepwiseEl:p,wmProposeBtn:c,wmPlanBtn:V,reviewAdminTokenEl:ot,addAdminTokenEl:i,reviewMessageEl:h,addMessageEl:_,setDraftOverlay:b,setAddCommitOutput:W,setReviewCommitOutput:$,setWorldModelOutput:T,setWorldModelStatus:S,clearDraftOverlay:P,isServerMode:v}=t;function tt(k){const O=String(k||"").trim();if(!O)return[];const w=O.split(/\n+/g).map(L=>L.trim()).filter(Boolean),K=[];for(const L of w){const Y=L.indexOf("=");if(Y<=0)continue;const it=L.slice(0,Y).trim(),X=L.slice(Y+1).trim();if(!it||!X)continue;const z=X.split(":").map(D=>D.trim()).filter(Boolean),G=Number(z[0]);if(!Number.isFinite(G))continue;const N=z.length>1?Number(z[1]):1,A=z.length>2?z.slice(2).join(":"):null;K.push({name:it,value:G,weight:Number.isFinite(N)?N:1,unit:A||null})}return K}function st(){const k=Zt(r&&r.value||""),O=o?String(o.value||"").trim():"",w=a?String(a.value||"").trim():"",K=O?Number(O):NaN,L=w?Number(w):NaN,Y=E?String(E.value||"fast"):"fast",it=l?String(l.value||"both"):"both",X=H?!!H.checked:!0,z=tt(C&&C.value||""),G={goals:k,guardrail_profile:Y,guardrail_plane:it,include_guardrail:X,task_costs:z};return Number.isFinite(K)&&(G.max_new_proposals=Math.max(0,Math.floor(K))),Number.isFinite(L)&&(G.seed=Math.max(0,Math.floor(L))),G}function lt(){const k={"content-type":"application/json"},O=(ot&&ot.value||i&&i.value||"").trim();return O&&(k.authorization=`Bearer ${O}`),k}function et(k){if(!k||!Array.isArray(k.steps))return null;const O=[];for(const L of k.steps){const Y=L&&L.proposals&&Array.isArray(L.proposals.proposals)?L.proposals.proposals:[];O.push(...Y)}if(!O.length)return null;const w=k.trace_id||"world_model_plan";return{version:1,generated_at:String(k.generated_at_unix_secs||Math.floor(Date.now()/1e3)),source:{source_type:"world_model_plan",locator:w},schema_hint:null,proposals:O}}async function pt(){if(S(""),T(null),W(null),$(null),e.reviewActionStatus="",!v()){S("requires server mode (`axiograph db serve`)");return}const k=st(),O=f?Number(f.value||""):NaN;if(Number.isFinite(O)&&(k.horizon_steps=Math.max(1,Math.floor(O))),I?!!I.checked:!1){if(!(ot&&ot.value||i&&i.value||"").trim()){S("auto-commit requires admin token");return}k.auto_commit=!0;const L=(h&&h.value||_&&_.value||"").trim();L&&(k.commit_message=L)}try{S("running…");const K=await fetch("/world_model/propose",{method:"POST",headers:lt(),body:JSON.stringify(k)}),L=await K.json();if(T(L),!K.ok){S(`error (${K.status})`);return}if(S("ok"),L&&L.commit&&$(L.commit),L&&L.commit_steps&&$(L.commit_steps),L&&L.commit_steps&&$(L.commit_steps),L&&L.proposals){const Y={proposals_json:L.proposals,chunks:[],summary:{source:"world_model_propose",trace_id:L.trace_id}};b(Y,{notePrefix:"generated from world model"})}}catch(K){S("error"),T(String(K))}}async function at(){if(S(""),T(null),W(null),$(null),e.reviewActionStatus="",!v()){S("requires server mode (`axiograph db serve`)");return}const k=st(),O=f?Number(f.value||""):NaN,w=d?Number(d.value||""):NaN;if(Number.isFinite(O)&&(k.horizon_steps=Math.max(1,Math.floor(O))),Number.isFinite(w)&&(k.rollouts=Math.max(1,Math.floor(w))),I?!!I.checked:!1){if(!(ot&&ot.value||i&&i.value||"").trim()){S("auto-commit requires admin token");return}k.auto_commit=!0,k.commit_stepwise=p?!!p.checked:!1;const Y=(h&&h.value||_&&_.value||"").trim();Y&&(k.commit_message=Y)}try{S("running…");const L=await fetch("/world_model/plan",{method:"POST",headers:lt(),body:JSON.stringify(k)}),Y=await L.json();if(T(Y),!L.ok){S(`error (${L.status})`);return}S("ok"),Y&&Y.commit&&$(Y.commit);const it=Y&&Y.report?et(Y.report):null;if(it&&it.proposals&&it.proposals.length){const X={proposals_json:it,chunks:[],summary:{source:"world_model_plan",trace_id:Y.report&&Y.report.trace_id}};b(X,{notePrefix:"generated from world model plan"})}}catch(L){S("error"),T(String(L))}}return c&&c.addEventListener("click",pt),V&&V.addEventListener("click",at),{setWorldModelStatus:S,setWorldModelOutput:T,mergeWorldModelPlanProposals:et}}function En(t){const{ui:e,addRelTypeEl:r,addSourceNameEl:o,addTargetNameEl:a,addPairingEl:f,addContextEl:d,addCtxFromFilterBtn:E,addEvidenceTextEl:l,addConfidenceEl:H,addConfidenceValEl:C,addMessageEl:I,addAdminTokenEl:p,addGenerateBtn:c,addCommitBtn:V,addDraftAxiBtn:ot,addPromoteAxiBtn:i,addAxiTextEl:h,addPromoteStatusEl:_,addStatusEl:b,reviewCommitOutputEl:W,reviewPromoteOutputEl:$,reviewMessageEl:T,reviewAdminTokenEl:S,addOutputEl:P,addCommitOutputEl:v,addPromoteOutputEl:tt,currentContextNameFromFilter:st,setReviewCommitOutput:lt,setReviewPromoteOutput:et,setAddCommitOutput:pt,setAddPromoteOutput:at,setAddPromoteStatus:k,setAddStatus:O,setAddOutput:w,setDraftOverlay:K,clearDraftOverlay:L,setReviewActionStatus:Y,isServerMode:it,updateAddConfidenceLabel:X,renderDraftOverlayReview:z}=t;async function G(){if(O(""),w(null),pt(null),lt(null),et(null),e.reviewActionStatus="",L(),!it()){O("requires server mode (`axiograph db serve`)");return}const j=(r&&r.value||"").trim(),B=Zt(o&&o.value||""),x=Zt(a&&a.value||""),u=(l&&l.value||"").trim();if(!j||!B.length||!x.length){O("missing rel/source/target");return}let n=(d&&d.value||"").trim();if(!n){const m=st();m&&(n=m,d&&(d.value=m))}const g=H?Number(H.value||"0.9"):.9;try{O("generating…");const m=B.length>1||x.length>1,s=(f&&f.value||"cartesian").trim()||"cartesian",F=m?"/proposals/relations":"/proposals/relation",R=m?{rel_type:j,source_names:B,target_names:x,pairing:s,context:n||null,confidence:g,evidence_text:u||null,evidence_locator:"viz_ui"}:{rel_type:j,source_name:B[0],target_name:x[0],context:n||null,confidence:g,evidence_text:u||null,evidence_locator:"viz_ui"},J=await fetch(F,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(R)}),Q=await J.json();if(!J.ok){O(`error (${J.status})`),w(Q);return}if(K(Q,{notePrefix:"generated"}),Q&&Q.validation&&Q.validation.ok===!1){const ct=Q.validation.axi_typecheck&&Array.isArray(Q.validation.axi_typecheck.errors)?Q.validation.axi_typecheck.errors.length:0,U=Q.validation.quality_delta&&Q.validation.quality_delta.summary?Number(Q.validation.quality_delta.summary.error_count||0):0;e.reviewActionStatus="validation failed",z(),O(`validation failed (typecheck_errors=${ct} quality_errors=${U})`)}else Q&&Q.validation&&Q.validation.ok===!0?(e.reviewActionStatus="validated",z(),O("ok (validated)")):O("ok")}catch(m){O("error"),w(String(m))}}async function N(){if(O(""),pt(null),lt(null),e.reviewActionStatus="",z(),!it()){O("requires server mode (`axiograph db serve`)");return}const j=currentDraftFiltered();if(!j||!j.proposals_json||!Array.isArray(j.proposals_json.proposals)||!j.proposals_json.proposals.length){O("no draft overlay selected (generate proposals first)");return}if(e.draftOverlay&&e.draftOverlay.validation&&e.draftOverlay.validation.ok===!1){O("refusing to commit: validation failed (fix proposals first)"),e.reviewActionStatus="refusing to commit: invalid",z();return}const B=(T&&T.value||I&&I.value||"").trim();let x=null;try{const m=await fetch("/status",{cache:"no-store"});if(m.ok){const s=await m.json();if(s&&s.snapshot&&s.snapshot.accepted_snapshot_id&&(x=s.snapshot.accepted_snapshot_id),s&&s.role&&String(s.role).toLowerCase()!=="master"){O("commit requires master server (role != master)"),e.reviewActionStatus="commit blocked (role != master)",z();return}}}catch{}const u={accepted_snapshot:x,chunks:Array.isArray(j.chunks)?j.chunks:[],proposals:j.proposals_json,message:B||null},n={"content-type":"application/json"},g=(S&&S.value||p&&p.value||"").trim();g&&(n.authorization=`Bearer ${g}`);try{O("committing…"),e.reviewActionStatus="committing…",z();const m=await fetch("/admin/accept/pathdb-commit",{method:"POST",headers:n,body:JSON.stringify(u)}),s=await m.json();if(pt(s),lt(s),!m.ok){O(`error (${m.status})`),e.reviewActionStatus=`commit error (${m.status})`,z();return}if(O("ok"),e.reviewActionStatus="committed",z(),s&&s.snapshot_id){L();const F=new URLSearchParams(window.location.search||"");F.set("snapshot",s.snapshot_id),window.location.search=F.toString()}}catch(m){O("error"),pt(String(m)),lt(String(m)),e.reviewActionStatus="commit error",z()}}c&&c.addEventListener("click",G),V&&V.addEventListener("click",N);async function A(){if(k(""),at(null),h&&(h.value=""),reviewAxiTextEl&&(reviewAxiTextEl.value=""),e.reviewActionStatus="",z(),!it()){k("requires server mode (`axiograph db serve`)");return}const j=currentDraftFiltered();if(!j||!j.proposals_json||!Array.isArray(j.proposals_json.proposals)||!j.proposals_json.proposals.length){k("no draft overlay selected (generate proposals first)"),e.reviewActionStatus="no draft overlay",z();return}try{k("drafting…"),e.reviewActionStatus="drafting .axi…",z();const B={proposals:j.proposals_json,infer_constraints:!0},x=await fetch("/discover/draft-axi",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(B)}),u=await x.json();if(at(u),et(u),!x.ok){k(`error (${x.status})`),e.reviewActionStatus=`draft error (${x.status})`,z();return}h&&u&&typeof u.axi_text=="string"&&(h.value=u.axi_text),reviewAxiTextEl&&u&&typeof u.axi_text=="string"&&(reviewAxiTextEl.value=u.axi_text),k("ok"),e.reviewActionStatus="drafted .axi",z()}catch(B){k("error"),at(String(B)),et(String(B)),e.reviewActionStatus="draft error",z()}}async function D(){if(k(""),at(null),et(null),e.reviewActionStatus="",z(),!it()){k("requires server mode (`axiograph db serve`)"),e.reviewActionStatus="requires server mode",z();return}const j=reviewAxiTextEl&&String(reviewAxiTextEl.value||"").trim()?String(reviewAxiTextEl.value||""):h?String(h.value||""):"";if(!String(j||"").trim()){k("draft .axi text is empty (click 'draft .axi' or paste)"),e.reviewActionStatus="promote blocked: empty .axi",z();return}const B=(S&&S.value||p&&p.value||"").trim();if(!B){k("promote requires admin token"),e.reviewActionStatus="promote blocked: missing token",z();return}try{const g=await fetch("/status",{cache:"no-store"});if(g.ok){const m=await g.json();if(m&&m.role&&String(m.role).toLowerCase()!=="master"){k("promote requires master server (role != master)"),e.reviewActionStatus="promote blocked (role != master)",z();return}}}catch{}const x=(T&&T.value||I&&I.value||"").trim(),u={axi_text:String(j||""),message:x||null,quality:"fast"},n={"content-type":"application/json",authorization:`Bearer ${B}`};try{k("promoting…"),e.reviewActionStatus="promoting…",z();const g=await fetch("/admin/accept/promote",{method:"POST",headers:n,body:JSON.stringify(u)}),m=await g.json();if(at(m),et(m),!g.ok){k(`error (${g.status})`),e.reviewActionStatus=`promote error (${g.status})`,z();return}k("ok"),e.reviewActionStatus="promoted",z()}catch(g){k("error"),at(String(g)),et(String(g)),e.reviewActionStatus="promote error",z()}}return ot&&ot.addEventListener("click",A),i&&i.addEventListener("click",D),{setAddStatus:O,setAddOutput:w,setAddCommitOutput:pt,setAddPromoteOutput:at,setAddPromoteStatus:k,setDraftOverlay:K,clearDraftOverlay:L,commitGeneratedOverlay:N,draftAxiFromGeneratedOverlay:A,promoteDraftAxiText:D}}function xn(t){const{addStatusEl:e,wmStatusEl:r,wmOutputEl:o,reviewStatusEl:a,reviewValidationEl:f,reviewOverlayRawEl:d,reviewCommitOutputEl:E,reviewPromoteOutputEl:l,addOutputEl:H,addCommitOutputEl:C,addPromoteOutputEl:I,addPromoteStatusEl:p}=t;function c(v){e&&(e.textContent=v||"")}function V(v){r&&(r.textContent=v||"")}function ot(v){o&&(v==null?o.textContent="":o.textContent=typeof v=="string"?v:JSON.stringify(v,null,2))}function i(v){a&&(a.innerHTML=v||"")}function h(v){f&&(v==null?f.textContent="":f.textContent=typeof v=="string"?v:JSON.stringify(v,null,2))}function _(v){d&&(v==null?d.textContent="":d.textContent=typeof v=="string"?v:JSON.stringify(v,null,2))}function b(v){E&&(v==null?E.textContent="":E.textContent=typeof v=="string"?v:JSON.stringify(v,null,2))}function W(v){l&&(v==null?l.textContent="":l.textContent=typeof v=="string"?v:JSON.stringify(v,null,2))}function $(v){H&&(v==null?H.textContent="":H.textContent=JSON.stringify(v,null,2))}function T(v){C&&(v==null?C.textContent="":C.textContent=JSON.stringify(v,null,2))}function S(v){p&&(p.textContent=v||"")}function P(v){I&&(v==null?I.textContent="":I.textContent=JSON.stringify(v,null,2))}return{setAddStatus:c,setAddOutput:$,setAddCommitOutput:T,setAddPromoteStatus:S,setAddPromoteOutput:P,setWorldModelStatus:V,setWorldModelOutput:ot,setReviewStatusHtml:i,setReviewValidation:h,setReviewOverlayRaw:_,setReviewCommitOutput:b,setReviewPromoteOutput:W}}function bn(t){const{ui:e,reviewFilterEl:r,reviewSelectAllBtn:o,reviewSelectNoneBtn:a,reviewClearBtn:f,reviewMessageEl:d,reviewAdminTokenEl:E,reviewCommitBtn:l,reviewDraftAxiBtn:H,reviewPromoteAxiBtn:C,reviewListEl:I,reviewValidationEl:p,reviewAxiTextEl:c,reviewCommitOutputEl:V,reviewPromoteOutputEl:ot,reviewOverlayRawEl:i,addAxiTextEl:h,addMessageEl:_,addAdminTokenEl:b,setReviewStatusHtml:W,setReviewValidation:$,setReviewOverlayRaw:T,setReviewCommitOutput:S,setReviewPromoteOutput:P,setAddPromoteOutput:v,setAddCommitOutput:tt,setAddPromoteStatus:st,setAddStatus:lt,isServerMode:et,commitGeneratedOverlay:pt,draftAxiFromGeneratedOverlay:at,promoteDraftAxiText:k}=t;function O(){const x=window.location&&window.location.host?window.location.host:"offline";let u="";try{const n=(localStorage.getItem("axiograph_server_accepted_snapshot_id")||"").trim();n&&(u=n)}catch{}return u||(u=(new URLSearchParams(window.location.search||"").get("snapshot")||"").trim()),u||(u="default"),`axiograph_draft_overlay_v1:${x}:${u}`}let w=O();function K(){return w}function L(x){w=x}function Y(x){try{const u=localStorage.getItem(x)||"";if(!u.trim())return null;const n=JSON.parse(u);return!n||typeof n!="object"||!n.proposals_json?null:n}catch{return null}}function it(){try{if(!e.draftOverlay){localStorage.removeItem(w);return}localStorage.setItem(w,JSON.stringify(e.draftOverlay))}catch{}}function X(){e.draftOverlay=null,e.draftSelected=new Set,it(),S(null),P(null),G()}function z(x,u){const n=x||null;if(!n||!n.proposals_json)return!1;e.draftOverlay=n;const g=n.proposals_json&&Array.isArray(n.proposals_json.proposals)?n.proposals_json.proposals:[];e.draftSelected=new Set(g.map(R=>String(R&&R.proposal_id||"")).filter(Boolean)),it(),G(),setAddOutput(n),tt(null),S(null),P(null),v(null),st(""),h&&(h.value=""),c&&(c.value="");const m=u&&u.notePrefix?String(u.notePrefix):"draft overlay ready",s=n.validation&&n.validation.ok===!0,F=n.validation&&n.validation.ok===!1;return lt(F?`${m} (validation failed; review before commit)`:s?`${m} (validated; review before commit)`:`${m} (review before commit)`),setActiveTab("review"),!0}function G(){if(!I)return;I.innerHTML="";const x=e.draftOverlay;if(!x||!x.proposals_json){W('<span class="muted">(no draft overlay)</span>'),T(""),$(""),c&&(c.value=""),I.innerHTML='<div class="proprow"><div class="main"><div class="muted">No draft overlay. Generate one in <strong>add</strong> or via <strong>llm</strong>, then review/commit here.</div></div></div>';return}const u=x.proposals_json&&Array.isArray(x.proposals_json.proposals)?x.proposals_json.proposals:[],n=e.draftSelected||new Set,g=x.validation&&x.validation.ok===!0,m=x.validation&&x.validation.ok===!1,s=g?'<span class="chip ok">validated</span>':m?'<span class="chip bad">invalid</span>':'<span class="chip">unvalidated</span>';function F(nt){return String(nt||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function R(){const nt=e.reviewActionStatus?` <span class="muted">— ${F(e.reviewActionStatus)}</span>`:"";W(`${n.size}/${u.length} selected ${s}${nt}`)}R(),T(x),$(x.validation||"");const J=r&&r.value?String(r.value).trim().toLowerCase():"";function Q(nt){const ut=String(nt&&nt.kind||""),gt=nt&&nt.confidence!=null?Number(nt.confidence):null,M=gt!=null&&Number.isFinite(gt)?` conf=${gt.toFixed(2)}`:"";if(ut.toLowerCase()==="entity"){const rt=nt.entity_type||"Entity",yt=nt.name||"";return`Entity ${rt} "${yt}"${M}`}if(ut.toLowerCase()==="relation"){const rt=nt.rel_type||"Relation",yt=nt.source||"?",vt=nt.target||"?";return`Relation ${rt}(${yt} -> ${vt})${M}`}return`${ut||"Proposal"}${M}`}function ct(nt){if(!J)return!0;const ut=[];for(const M of["kind","proposal_id","schema_hint","entity_type","name","entity_id","rel_type","relation_id","source","target"])nt&&nt[M]!=null&&ut.push(String(nt[M]));const gt=Array.isArray(nt&&nt.evidence)?nt.evidence:[];for(const M of gt.slice(0,4))M&&M.chunk_id&&ut.push(String(M.chunk_id)),M&&M.locator&&ut.push(String(M.locator));return ut.join(" ").toLowerCase().includes(J)}const U=u.filter(ct);if(!U.length){I.innerHTML='<div class="proprow"><div class="main"><div class="muted">No proposals match the current filter.</div></div></div>';return}const ft=250,wt=U.slice(0,ft);for(const nt of wt){const ut=String(nt&&nt.proposal_id||""),gt=document.createElement("div");gt.className="proprow";const M=document.createElement("input");M.type="checkbox",M.checked=ut?n.has(ut):!1,M.addEventListener("change",()=>{ut&&(M.checked?n.add(ut):n.delete(ut),e.draftSelected=n,R())});const rt=document.createElement("div");rt.className="main";const yt=document.createElement("div");yt.className="line",yt.textContent=Q(nt);const vt=document.createElement("div");vt.className="sub";const It=Array.isArray(nt&&nt.evidence)?nt.evidence:[],Ht=It.length;vt.textContent=`proposal_id=${ut||"?"}${Ht?` evidence=${Ht}`:""}`;const Pt=document.createElement("details"),qt=document.createElement("summary");qt.className="muted",qt.textContent="details";const Bt=document.createElement("pre");if(Bt.style.whiteSpace="pre-wrap",Bt.style.maxHeight="220px",Bt.style.overflow="auto",Bt.style.margin="8px 0 0 0",Bt.textContent=JSON.stringify(nt,null,2),Pt.appendChild(qt),Pt.appendChild(Bt),It.length){const Lt=document.createElement("div");Lt.className="muted",Lt.style.marginTop="6px",Lt.textContent="evidence:";for(const Rt of It.slice(0,6)){const Dt=Rt&&Rt.chunk_id?String(Rt.chunk_id):"";if(!Dt)continue;const Ct=document.createElement("button");Ct.type="button",Ct.className="btn",Ct.style.padding="2px 8px",Ct.style.marginLeft="6px",Ct.textContent=Dt,Ct.title="Open DocChunk",Ct.addEventListener("click",()=>openDocChunk(Dt)),Lt.appendChild(Ct)}rt.appendChild(Lt)}rt.appendChild(yt),rt.appendChild(vt),rt.appendChild(Pt),gt.appendChild(M),gt.appendChild(rt),I.appendChild(gt)}if(U.length>ft){const nt=document.createElement("div");nt.className="proprow",nt.innerHTML=`<div class="main"><div class="muted">Showing ${ft} of ${U.length} matching proposals. Narrow the filter to review more precisely.</div></div>`,I.appendChild(nt)}}function N(x){e.reviewActionStatus=x||"",G()}e.draftOverlay=Y(w),e.draftOverlay&&e.draftOverlay.proposals_json&&Array.isArray(e.draftOverlay.proposals_json.proposals)&&(e.draftSelected=new Set(e.draftOverlay.proposals_json.proposals.map(x=>String(x&&x.proposal_id||"")).filter(Boolean))),G();function A(){try{const x=localStorage.getItem("axiograph_admin_token")||"";b&&!b.value&&(b.value=x),E&&!E.value&&(E.value=x)}catch{}}function D(){try{const x=E&&E.value?E:b;if(!x)return;const u=(x.value||"").trim();localStorage.setItem("axiograph_admin_token",u),b&&b.value!==u&&(b.value=u),E&&E.value!==u&&(E.value=u)}catch{}}A(),b&&b.addEventListener("change",D),E&&E.addEventListener("change",D);function j(){try{const x=localStorage.getItem("axiograph_commit_message")||"";_&&!_.value&&(_.value=x),d&&!d.value&&(d.value=x)}catch{}}function B(){try{const x=d&&d.value?d:_;if(!x)return;const u=(x.value||"").trim();localStorage.setItem("axiograph_commit_message",u),_&&_.value!==u&&(_.value=u),d&&d.value!==u&&(d.value=u)}catch{}}return j(),_&&_.addEventListener("change",B),d&&d.addEventListener("change",B),r&&r.addEventListener("input",G),o&&o.addEventListener("click",()=>{!e.draftOverlay||!e.draftOverlay.proposals_json||!Array.isArray(e.draftOverlay.proposals_json.proposals)||(e.draftSelected=new Set(e.draftOverlay.proposals_json.proposals.map(x=>String(x&&x.proposal_id||"")).filter(Boolean)),G())}),a&&a.addEventListener("click",()=>{e.draftSelected=new Set,G()}),f&&f.addEventListener("click",X),l&&l.addEventListener("click",pt),H&&H.addEventListener("click",at),C&&C.addEventListener("click",k),{draftOverlayStorageKey:O,loadDraftOverlayForKey:Y,saveDraftOverlay:it,getDraftOverlayKey:K,setDraftOverlayKey:L,clearDraftOverlay:X,setDraftOverlay:z,setReviewActionStatus:N,renderDraftOverlayReview:G}}function Sn(t){const{ui:e,rerender:r,layoutAlgoEl:o,layoutCenterEl:a,layoutRefreshBtn:f,labelDensityEl:d}=t;function E(){try{const I=localStorage.getItem("axiograph_viz_layout_algo"),p=localStorage.getItem("axiograph_viz_layout_center");I&&(e.layoutAlgo=I),p&&(e.layoutCenter=p)}catch{}o&&(o.value=e.layoutAlgo||"radial"),a&&(a.value=e.layoutCenter||"focus")}function l(){try{localStorage.setItem("axiograph_viz_layout_algo",e.layoutAlgo||"radial"),localStorage.setItem("axiograph_viz_layout_center",e.layoutCenter||"focus")}catch{}}E(),o&&o.addEventListener("change",()=>{e.layoutAlgo=String(o.value||"radial"),l(),H(),r()}),a&&a.addEventListener("change",()=>{e.layoutCenter=String(a.value||"focus"),l(),r()}),f&&f.addEventListener("click",()=>{e.layoutSeed=Number(e.layoutSeed||0)+1>>>0,r()});function H(){const I=Array.from(document.querySelectorAll("[data-layout-preset]"));for(const p of I){const c=p.getAttribute("data-layout-preset")||"";p.classList.toggle("active",c===e.layoutAlgo)}}const C=Array.from(document.querySelectorAll("[data-layout-preset]"));for(const I of C)I.addEventListener("click",()=>{const p=I.getAttribute("data-layout-preset")||"";p&&(o&&(o.value=p),e.layoutAlgo=p,l(),H(),r())});if(H(),d){try{const I=localStorage.getItem("axiograph_viz_label_density");I&&(d.value=I)}catch{}d.addEventListener("change",()=>{try{localStorage.setItem("axiograph_viz_label_density",String(d.value||""))}catch{}r()})}}function kn(t){const{factContexts:e,contextNameById:r,contextFilterEl:o}=t;if(!o)return;if(o.innerHTML="",!(e.size>0)){const l=document.createElement("option");l.value="*",l.textContent="(no contexts)",o.appendChild(l),o.disabled=!0;return}function f(l,H){const C=document.createElement("option");C.value=l,C.textContent=H,o.appendChild(C)}f("*","(all)"),f("__none__","(no context)");const d=new Set;for(const l of e.values())for(const H of l.values())d.add(H);const E=Array.from(d).sort((l,H)=>l-H);for(const l of E){const H=r.get(l)||`Context#${l}`;f(String(l),H)}t.updateContextBadge&&t.updateContextBadge()}function Cn(t){const{contextFilterEl:e}=t;return!e||e.disabled?"*":String(e.value||"*")}function re(t){const{contextNameById:e,contextFilterEl:r}=t;if(!r)return null;const o=r.value||"*";if(o==="*"||o==="__none__")return null;const a=Number(o);return Number.isFinite(a)&&e.get(a)||null}function An(t){const{contextBadgeEl:e,contextFilterEl:r,contextNameById:o}=t;if(!e||!r)return;const a=String(r.value||"*");if(a==="*"){e.style.display="none",e.textContent="";return}let f="context";if(a==="__none__")f="context: none";else{const d=Number(a);f=`context: ${Number.isFinite(d)?o.get(d)||`Context#${d}`:String(a)}`}e.textContent=f,e.style.display="inline-flex"}function kt(t){const{ui:e,pathStatusEl:r}=t;if(!r)return;const o=e.pathMessage?` — ${e.pathMessage}`:"";if(e.pathStart==null){r.textContent="";return}if(e.pathEnd==null){r.textContent=`path: start=${e.pathStart}${o}`;return}if(!e.pathEdgeIdxs.length){r.textContent=`path: ${e.pathStart} → ${e.pathEnd} (no path)${o}`;return}r.textContent=`path: ${e.pathStart} → ${e.pathEnd} (${e.pathEdgeIdxs.length} edges)${o}`}function te(t){const{ui:e}=t;e.pathStart=null,e.pathEnd=null,e.pathEdgeIdxs=[],e.pathMessage="",kt(t)}function Bn(t,e,r){const{graph:o,isEdgeVisible:a}=t,f=[];for(let p=0;p<o.edges.length;p++)a(o.edges[p])&&f.push(p);const d=new Map;function E(p,c,V){d.has(p)||d.set(p,[]),d.get(p).push({to:c,edgeIdx:V})}for(const p of f){const c=o.edges[p];E(c.source,c.target,p),E(c.target,c.source,p)}const l=[],H=new Map;for(l.push(e),H.set(e,null);l.length;){const p=l.shift();if(p===r)break;const c=d.get(p)||[];for(const V of c)H.has(V.to)||(H.set(V.to,{node:p,edgeIdx:V.edgeIdx}),l.push(V.to))}if(!H.has(r))return[];const C=[];let I=r;for(;I!==e;){const p=H.get(I);if(!p)break;C.push(p.edgeIdx),I=p.node}return C.reverse(),C}function $n(t){const{rerender:e,clearPathBtn:r}=t;r&&r.addEventListener("click",()=>{te(t),e()}),kt(t)}function In(t){const{ui:e,graph:r,nodeById:o,runOnlyEl:a,contextFilterEl:f,show_plane_accepted:d,show_plane_evidence:E,show_plane_data:l,show_entity:H,show_fact:C,show_morphism:I,show_homotopy:p,show_meta:c,show_edge_relation:V,show_edge_equivalence:ot,show_edge_meta:i,minConfidenceEl:h,minConfidenceValEl:_,opacityByConfidenceEl:b,rerender:W,factContexts:$,isTupleLike:T,runIdForNode:S,clamp01:P}=t;function v(){return h?P(Number(h.value)):0}function tt(){_&&(_.textContent=v().toFixed(2))}function st(k){return k.confidence==null?1:P(Number(k.confidence))}function lt(k){return k?k.kind==="equivalence"?"equivalence":typeof k.kind=="string"&&k.kind.startsWith("meta")?"meta":"relation":"relation"}function et(k){if(!k)return!1;const O=k.plane?String(k.plane):"";if(O==="accepted"&&!d.checked||O==="evidence"&&!E.checked||O==="data"&&!l.checked||k.kind==="meta"&&!c.checked||k.kind==="fact"&&!C.checked||k.kind==="morphism"&&!I.checked||k.kind==="homotopy"&&!p.checked||(!k.kind||k.kind==="entity")&&!H.checked)return!1;if(a&&a.checked&&e.activeRunId){const K=S(k);if(!K||K!==e.activeRunId)return!1}const w=f?String(f.value||"*"):"*";if(w!=="*"){if(k.entity_type==="Context")return w==="__none__"?!1:String(k.id)===w;if(T(k)){const K=$.get(k.id);if(w==="__none__")return!K||!K.size;const L=Number(w);return Number.isFinite(L)?K?K.has(L):!1:!0}}return!0}function pt(k){const O=lt(k);if(O==="equivalence"&&!ot.checked||O==="meta"&&!i.checked||O==="relation"&&!V.checked||!et(o.get(k.source))||!et(o.get(k.target)))return!1;const w=v();return!(w>0&&st(k)<w)}function at(){const k=[];for(let O=0;O<r.edges.length;O++)pt(r.edges[O])&&k.push(O);return k}Object.assign(t,{edgeConfidence:st,isNodeVisible:et,isEdgeVisible:pt,visibleEdgeIdxsAll:at,updateMinConfidenceLabel:tt}),h&&(h.addEventListener("input",()=>{tt(),W()}),tt()),b&&b.addEventListener("change",W);for(const k of[d,E,l,H,C,I,p,c,a,V,ot,i])k&&k.addEventListener("change",W);f&&f.addEventListener("change",()=>{t.updateContextBadge&&t.updateContextBadge(),W()})}function Ln(t){let e=null;function r(){return e}function o(l){const H=t.nodesEl;if(H)for(const C of H.querySelectorAll(".node"))C.classList.toggle("selected",C.dataset.id===String(l))}function a(l,H){e=l,o(l),H&&(t.ui.pathStart==null||t.ui.pathStart!=null&&t.ui.pathEnd!=null?(t.ui.pathStart=l,t.ui.pathEnd=null,t.ui.pathEdgeIdxs=[],t.ui.pathMessage=""):t.ui.pathEnd==null&&(t.ui.pathEnd=l,t.shortestPathEdgeIdxs&&(t.ui.pathEdgeIdxs=t.shortestPathEdgeIdxs(t.ui.pathStart,t.ui.pathEnd)),t.ui.pathMessage=""),t.updatePathStatus&&t.updatePathStatus()),t.renderDetail&&t.renderDetail(l),t.renderGraph&&t.renderGraph(l),t.fetchDescribeEntity&&t.fetchDescribeEntity(l)}function f(){t.ui.highlightIds=new Set}function d(l){const H=new Set,C=l&&Array.isArray(l.rows)?l.rows:[];for(const I of C)if(!(!I||typeof I!="object"))for(const p of Object.keys(I)){const c=I[p];c&&typeof c.id=="number"&&H.add(c.id)}t.ui.highlightIds=H}function E(l){if(!(!l||typeof l!="object")){if(l.query_result){d(l.query_result);return}if(l.query){d(l.query);return}Array.isArray(l.rows)&&d({rows:l.rows})}}return Object.assign(t,{selectNode:a,selectedIdRef:r,clearHighlights:f,highlightFromQueryResponse:d,highlightFromToolLoop:E}),{selectNode:a,selectedIdRef:r,clearHighlights:f,highlightFromQueryResponse:d,highlightFromToolLoop:E}}function Nn(t){const{ui:e,detailEl:r}=t;function o(a){const f=String(a||"overview");e.detailTab=f;const d=Array.from(r.querySelectorAll(".detailtabbtn")),E=Array.from(r.querySelectorAll(".detailtabpanel"));for(const l of d)l.classList.toggle("active",(l.dataset&&l.dataset.dtab)===f);for(const l of E)l.classList.toggle("active",(l.dataset&&l.dataset.dtab)===f)}return Object.assign(t,{setActiveDetailTab:o}),{setActiveDetailTab:o}}function On(t){const{nodeById:e,outEdgesBySource:r,nodeShortLabel:o,parseRelationSignatureFieldOrder:a,isTupleLike:f}=t;function d(i,h){const _=r.get(i)||[];for(const b of _)if(!(!b||b.kind!=="relation")&&String(b.label||"")===h)return b.target;return null}function E(i){if(!i||!f(i))return null;const h=i.attrs&&i.attrs.axi_relation?String(i.attrs.axi_relation):String(i.entity_type||"Tuple"),_=a(i.attrs&&i.attrs.axi_overlay_relation_signature),b=new Map;if(_)for(let S=0;S<_.length;S++)b.set(_[S],S);const W=r.get(i.id)||[],$=[];for(const S of W){if(!S||S.kind!=="relation")continue;const P=String(S.label||"");if(!P||P==="axi_fact_of"||P==="axi_fact_in_context"||P.startsWith("axi_"))continue;const v=e.get(S.target),tt=v?o(v):String(S.target);$.push({label:P,value:tt})}if(!$.length)return h;$.sort((S,P)=>{const v=b.has(S.label)?b.get(S.label):1e4,tt=b.has(P.label)?b.get(P.label):1e4;return v!==tt?v-tt:S.label.localeCompare(P.label)});const T=$.map(S=>`${S.label}=${S.value}`);return`${h}(${T.join(", ")})`}function l(i){if(!i||i.kind!=="fact")return null;const h=i.attrs&&i.attrs.axi_relation?String(i.attrs.axi_relation):String(i.entity_type||"Fact"),_=a(i.attrs&&i.attrs.axi_overlay_relation_signature),b=new Map;if(_)for(let S=0;S<_.length;S++)b.set(_[S],S);const W=r.get(i.id)||[],$=[];for(const S of W){if(!S||S.kind!=="relation")continue;const P=String(S.label||"");if(!P||P==="axi_fact_of"||P==="axi_fact_in_context"||P.startsWith("axi_"))continue;const v=e.get(S.target),tt=v?o(v):String(S.target);$.push({label:P,value:tt})}if(!$.length)return h;$.sort((S,P)=>{const v=b.has(S.label)?b.get(S.label):1e4,tt=b.has(P.label)?b.get(P.label):1e4;return v!==tt?v-tt:S.label.localeCompare(P.label)});const T=$.map(S=>`${S.label}=${S.value}`);return`${h}(${T.join(", ")})`}function H(i){if(!i||i.kind!=="morphism")return null;const h=i.attrs&&i.attrs.axi_relation?String(i.attrs.axi_relation):String(i.entity_type||"Morphism"),_=d(i.id,"from"),b=d(i.id,"to"),W=_!=null?o(e.get(_)):"",$=b!=null?o(e.get(b)):"";return W&&$?`${h}: ${W} → ${$}`:E(i)||h}function C(i){if(!i||i.kind!=="homotopy")return null;const h=i.attrs&&i.attrs.axi_relation?String(i.attrs.axi_relation):String(i.entity_type||"Homotopy"),_=d(i.id,"lhs"),b=d(i.id,"rhs"),W=_!=null?o(e.get(_)):"",$=b!=null?o(e.get(b)):"";return W&&$?`${h}: ${W} ≃ ${$}`:E(i)||h}function I(i){const h=String(i||"").trim();return h?h.length<=10?h:h.slice(0,10)+"…":""}function p(i){const h=String(i||"").trim();if(!h)return"";const b=h.replace(/[?#].*$/,"").split(/[\\/]/g).filter(W=>W.length>0);return b.length>=1?b[b.length-1]:h.length>36?h.slice(0,36)+"…":h}function c(i){if(!i||i.entity_type!=="ProposalRun")return null;const h=i.attrs||{},_=I(h.proposals_digest),b=String(h.schema_hint||"").trim(),W=String(h.source_type||"").trim(),$=p(h.source_locator||h.source||""),T=b||W||"run";return _&&$?`${T} @ ${$} (${_})`:_?`${T} (${_})`:$?`${T} @ ${$}`:T}function V(i){if(!i||i.entity_type!=="Document")return null;const h=i.attrs||{},_=p(h.document_id||i.name||"");return _?`doc ${_}`:"Document"}function ot(i){if(!i||i.entity_type!=="DocChunk")return null;const h=i.attrs||{},_=p(h.chunk_id||i.name||""),b=d(i.id,"doc_chunk_about"),W=b!=null?o(e.get(b)):"";return _&&W?`chunk ${_} (about ${W})`:_?`chunk ${_}`:W?`chunk (about ${W})`:"chunk"}return{firstOutTargetId:d,factSummary:l,tupleFallbackSummary:E,morphismSummary:H,homotopySummary:C,shortenHash:I,shortLocator:p,proposalRunSummary:c,documentSummary:V,docChunkSummary:ot}}function Mn(t){const{graph:e,ui:r,runFilterEl:o,runOnlyEl:a,runClearBtn:f,runIdForNode:d,selectNode:E,rerender:l}=t;function H(I){if(r.activeRunId=I||null,!r.activeRunId)r.highlightIds=new Set;else{const p=r.runMap.get(r.activeRunId)||[];r.highlightIds=new Set(p),p.length&&E&&E(p[0],!1)}l()}function C(){if(!o)return;o.innerHTML="",r.runMap=new Map;for(const c of e.nodes||[]){const V=d(c);V&&(r.runMap.has(V)||r.runMap.set(V,[]),r.runMap.get(V).push(c.id))}const I=Array.from(r.runMap.keys());if(!I.length){const c=document.createElement("option");c.value="",c.textContent="(no runs)",o.appendChild(c),o.disabled=!0,a&&(a.disabled=!0),f&&(f.disabled=!0);return}I.sort((c,V)=>String(c).localeCompare(String(V)));const p=document.createElement("option");p.value="",p.textContent="(all runs)",o.appendChild(p);for(const c of I){const V=document.createElement("option");V.value=c;const ot=(r.runMap.get(c)||[]).length;V.textContent=ot?`${c} (${ot})`:c,o.appendChild(V)}o.disabled=!1,a&&(a.disabled=!1),f&&(f.disabled=!1),o.addEventListener("change",()=>{const c=String(o.value||"");H(c)}),f&&f.addEventListener("click",()=>{o.value="",H(null)})}return C(),Object.assign(t,{setActiveRun:H}),{setActiveRun:H}}function Tn(t){const{graph:e,ui:r,componentJumpBtn:o,componentStatusEl:a,selectedIdRef:f,selectNode:d,rerender:E}=t;function l(){const p=Array.isArray(e.nodes)?e.nodes:[],c=Array.isArray(e.edges)?e.edges:[];if(!p.length||p.length>8e4||c.length>25e4)return null;const V=new Map;for(const _ of p)V.set(_.id,[]);for(const _ of c)!V.has(_.source)||!V.has(_.target)||(V.get(_.source).push(_.target),V.get(_.target).push(_.source));const ot=new Set,i=[],h=new Map;for(const _ of p){if(ot.has(_.id))continue;const b=[],W=[_.id];for(ot.add(_.id);W.length;){const $=W.pop();b.push($);const T=V.get($)||[];for(const S of T)ot.has(S)||(ot.add(S),W.push(S))}for(const $ of b)h.set($,i.length);i.push(b)}return i.sort((_,b)=>b.length-_.length),{components:i,componentByNode:h}}function H(p){if(!r.components||!r.components.length)return null;const c=p!=null&&r.componentByNode?r.componentByNode.get(p):null,V=[];for(let _=0;_<r.components.length;_++)c!=null&&_===c||V.push(_);const ot=V.length?V:r.components.map((_,b)=>b);if(!ot.length)return null;const i=ot[Math.floor(Math.random()*ot.length)],h=r.components[i];return!h||!h.length?null:h[Math.floor(Math.random()*h.length)]}const C=l();C&&(r.components=C.components,r.componentByNode=C.componentByNode);function I(){if(!o||!a)return;const p=r.components?r.components.length:0;o.disabled=p<2,o.textContent=p>1?`other component (${p})`:"other component",a.textContent=p>1?"jump to another connected component":"single component"}return o&&(o.addEventListener("click",()=>{let p=null;const c=f?f():null;c!=null&&(p=c);const V=H(p);V!=null&&(d&&d(V,!1),E())}),I()),Object.assign(t,{pickRandomComponentNode:H}),{pickRandomComponentNode:H}}function Pn(t){const{ui:e,isServerMode:r,renderDetail:o,selectedIdRef:a}=t;e.describeCache=e.describeCache||new Map;async function f(d){if(!r()||!Number.isFinite(d)||d<=0)return;const E=e.describeCache.get(d);if(!(E&&(E.status==="ok"||E.status==="loading"))){e.describeCache.set(d,{status:"loading",data:null}),a&&a()===d&&o(d);try{const l=new AbortController,H=setTimeout(()=>l.abort(),8e3),C=await fetch(`/entity/describe?id=${encodeURIComponent(String(d))}`,{cache:"no-store",signal:l.signal});clearTimeout(H);const I=await C.json();C.ok?e.describeCache.set(d,{status:"ok",data:I}):e.describeCache.set(d,{status:"error",data:I})}catch(l){e.describeCache.set(d,{status:"error",data:{error:String(l&&l.name==="AbortError"?"timeout":l)}})}a&&a()===d&&o(d)}}return Object.assign(t,{fetchDescribeEntity:f}),{fetchDescribeEntity:f}}function qn(t){const{svg:e,ui:r,nodeById:o,nodeDisplayName:a,nodeTitle:f,searchEl:d}=t,E=document.createElement("div");E.id="context_menu",E.className="context-menu",E.style.display="none",document.body.appendChild(E);function l(){E.style.display="none",E.innerHTML=""}function H(i){if(i==null)return;const h=String(i);if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(h).catch(()=>{});return}const _=document.createElement("textarea");_.value=h,_.style.position="fixed",_.style.opacity="0",document.body.appendChild(_),_.select();try{document.execCommand("copy")}catch{}document.body.removeChild(_)}function C(i,h,_={}){if(_.separator){const W=document.createElement("div");W.className="context-menu-sep",E.appendChild(W);return}const b=document.createElement("button");b.type="button",b.className="context-menu-item",b.textContent=i,_.disabled&&(b.disabled=!0),_.danger&&b.classList.add("danger"),b.addEventListener("click",W=>{W.preventDefault(),W.stopPropagation(),l(),!_.disabled&&h&&h()}),E.appendChild(b)}function I(i,h){E.style.display="block";const b=E.getBoundingClientRect(),W=window.innerWidth-b.width-8,$=window.innerHeight-b.height-8,T=Math.max(8,Math.min(i,W)),S=Math.max(8,Math.min(h,$));E.style.left=`${T}px`,E.style.top=`${S}px`}function p(i,h){i&&(i.value=h,i.dispatchEvent(new Event("change",{bubbles:!0})))}function c(i,h,_){const b=o?o.get(i):null,W=b?a?a(b):b.name||"":"",$=b?f?f(b):`${b.entity_type||"Entity"}#${b.id}`:`#${i}`;C($,null,{disabled:!0}),C("Select node",()=>t.selectNode&&t.selectNode(i,!1)),C("Center view",()=>t.centerViewOnNode&&t.centerViewOnNode(i),{disabled:!t.centerViewOnNode}),C("Set as path start",()=>{r.pathStart=i,r.pathMessage="",t.updatePathStatus&&t.updatePathStatus(),t.rerender&&t.rerender()}),C("Set as path end",()=>{r.pathEnd=i,r.pathMessage="",t.updatePathStatus&&t.updatePathStatus(),t.rerender&&t.rerender()}),C("",null,{separator:!0}),C("Clear path",()=>{t.clearPath&&t.clearPath(t),t.rerender&&t.rerender()},{danger:!0}),C("Certify path",()=>t.certifySelectedPath&&t.certifySelectedPath(!1),{disabled:!t.certifySelectedPath}),C("Verify path",()=>t.certifySelectedPath&&t.certifySelectedPath(!0),{disabled:!t.certifySelectedPath}),C("",null,{separator:!0}),C("Focus search on name",()=>{d&&(d.value=W||"",t.rerender&&t.rerender())},{disabled:!d}),C("Copy name",()=>H(W),{disabled:!W}),C("Copy type",()=>H(b?b.entity_type:""),{disabled:!b||!b.entity_type}),C("Copy id",()=>H(i)),I(h,_)}function V(i,h){C("Fit view",()=>t.fitViewToLayoutBounds&&t.fitViewToLayoutBounds(),{disabled:!t.fitViewToLayoutBounds}),C("Reset view",()=>t.resetViewToDefault&&t.resetViewToDefault(),{disabled:!t.resetViewToDefault}),C("Clear path",()=>{t.clearPath&&t.clearPath(t),t.rerender&&t.rerender()},{danger:!0}),C("",null,{separator:!0}),C("Labels: smart",()=>p(t.labelDensityEl,"smart"),{disabled:!t.labelDensityEl}),C("Labels: all",()=>p(t.labelDensityEl,"all"),{disabled:!t.labelDensityEl}),C("Labels: none",()=>p(t.labelDensityEl,"none"),{disabled:!t.labelDensityEl}),C("",null,{separator:!0}),C("Layout: radial",()=>p(t.layoutAlgoEl,"radial"),{disabled:!t.layoutAlgoEl}),C("Layout: grid",()=>p(t.layoutAlgoEl,"grid"),{disabled:!t.layoutAlgoEl}),C("Layout: type columns",()=>p(t.layoutAlgoEl,"type_columns"),{disabled:!t.layoutAlgoEl}),C("Layout: random",()=>p(t.layoutAlgoEl,"random"),{disabled:!t.layoutAlgoEl}),C("",null,{separator:!0}),C("Other component",()=>{if(!t.pickRandomComponentNode||!t.selectNode)return;const _=t.selectedIdRef?t.selectedIdRef():null,b=t.pickRandomComponentNode(_);b!=null&&t.selectNode(b,!1),t.rerender&&t.rerender()},{disabled:!t.pickRandomComponentNode}),I(i,h)}function ot(i){i&&(E.innerHTML="",i.kind==="node"?c(i.nodeId,i.x,i.y):V(i.x,i.y))}return document.addEventListener("click",l),window.addEventListener("blur",l),window.addEventListener("resize",l),document.addEventListener("keydown",i=>{i.key==="Escape"&&l()}),e&&e.addEventListener("contextmenu",i=>{i&&(i.preventDefault(),ot({kind:"panel",x:i.clientX,y:i.clientY}))}),Object.assign(t,{showContextMenu:ot,hideContextMenu:l}),{showContextMenu:ot,hideContextMenu:l}}function Rn(t){return function(r,o){const a=new Map,f=[];for(const E of r||[])a.set(E,0),f.push(E);const d=new Map;for(const E of t.nodes)d.set(E.id,[]);for(const E of o||[]){const l=t.edges[E];l&&(!d.has(l.source)||!d.has(l.target)||(d.get(l.source).push(l.target),d.get(l.target).push(l.source)))}for(;f.length;){const E=f.shift(),l=a.get(E)||0,H=d.get(E)||[];for(const C of H)a.has(C)||(a.set(C,l+1),f.push(C))}return a}}function Dn(t){return function(r){if(r.kind==="equivalence")return"#999";if(r.kind&&String(r.kind).startsWith("meta"))return"#bbb";const o=t.get(r.source);return o&&o.kind==="morphism"?"#2f855a":o&&o.kind==="homotopy"?"#6b46c1":o&&o.kind==="fact"?"#8a5a00":"#666"}}function Fn(){const t=window.location&&window.location.protocol;return t==="http:"||t==="https:"}function Hn(t){const e={content:[],overlay:[],axi:[],other:[]};for(const[r,o]of Object.entries(t||{}))r==="text"||r==="search_text"||r==="markdown"?e.content.push([r,o]):r.startsWith("axi_overlay_")?e.overlay.push([r,o]):r.startsWith("axi_")?e.axi.push([r,o]):e.other.push([r,o]);return e}function jn(t){const e=en(),{nodesEl:r,detailEl:o,searchEl:a,svg:f,serverControlsEl:d,show_plane_accepted:E,show_plane_evidence:l,show_plane_data:H,runFilterEl:C,runOnlyEl:I,runClearBtn:p,layoutAlgoEl:c,layoutCenterEl:V,layoutRefreshBtn:ot,layoutFitBtn:i,layoutResetViewBtn:h,labelDensityEl:_,navHelpEl:b,contextFilterEl:W,contextBadgeEl:$,componentJumpBtn:T,componentStatusEl:S,llmQuestionEl:P,llmAutoCommitEl:v,llmCertifyEl:tt,llmVerifyEl:st,llmRequireVerifiedEl:lt,llmAskBtn:et,llmToQueryBtn:pt,llmClearBtn:at,llmStatusEl:k,llmChatEl:O,llmCitationsEl:w,llmDebugEl:K,wmGoalsEl:L,wmMaxNewEl:Y,wmSeedEl:it,wmStepsEl:X,wmRolloutsEl:z,wmGuardrailProfileEl:G,wmGuardrailPlaneEl:N,wmIncludeGuardrailEl:A,wmTaskCostsEl:D,wmAutoCommitEl:j,wmCommitStepwiseEl:B,wmProposeBtn:x,wmPlanBtn:u,wmStatusEl:n,wmOutputEl:g,axqlQueryEl:m,axqlRunBtn:s,axqlCertBtn:F,axqlVerifyBtn:R,axqlStatusEl:J,axqlOutputEl:Q,certOutputEl:ct,addRelTypeEl:U,addSourceNameEl:ft,addTargetNameEl:wt,addPairingEl:nt,addContextEl:ut,addCtxFromFilterBtn:gt,addEvidenceTextEl:M,addConfidenceEl:rt,addConfidenceValEl:yt,addMessageEl:vt,addAdminTokenEl:It,addGenerateBtn:Ht,addCommitBtn:Pt,addStatusEl:qt,addOutputEl:Bt,addCommitOutputEl:Lt,addDraftAxiBtn:Rt,addPromoteAxiBtn:Dt,addPromoteStatusEl:Ct,addAxiTextEl:le,addPromoteOutputEl:ce,reviewFilterEl:de,reviewSelectAllBtn:ue,reviewSelectNoneBtn:me,reviewClearBtn:fe,reviewStatusEl:pe,reviewMessageEl:he,reviewAdminTokenEl:ge,reviewCommitBtn:ye,reviewDraftAxiBtn:ve,reviewPromoteAxiBtn:we,reviewListEl:_e,reviewValidationEl:Ee,reviewAxiTextEl:xe,reviewCommitOutputEl:be,reviewPromoteOutputEl:Se,reviewOverlayRawEl:ke,show_entity:Ce,show_fact:Ae,show_morphism:Be,show_homotopy:$e,show_meta:Ie,show_edge_relation:Le,show_edge_equivalence:Ne,show_edge_meta:Oe,clearPathBtn:Me,certifyPathBtn:jt,verifyPathBtn:Vt,pathStatusEl:Te,minConfidenceEl:Pe,minConfidenceValEl:qe,opacityByConfidenceEl:Re}=e,{nodeById:ee,outEdgesBySource:De,inEdgesByTarget:Fe}=nn(t),He=Dn(ee),je=Rn(t);let Kt=()=>{},Gt=()=>{};const mt={pathStart:null,pathEnd:null,pathEdgeIdxs:[],pathMessage:"",highlightIds:new Set,activeRunId:null,runMap:new Map,draftOverlay:null,draftSelected:new Set,reviewActionStatus:"",layoutAlgo:"radial",layoutCenter:"focus",layoutSeed:0,layoutBounds:null,components:null,componentByNode:null},q={graph:t,ui:mt,nodesEl:r,detailEl:o,searchEl:a,svg:f,serverControlsEl:d,nodeById:ee,outEdgesBySource:De,inEdgesByTarget:Fe,factContexts:new Map,contextNameById:new Map,show_plane_accepted:E,show_plane_evidence:l,show_plane_data:H,runFilterEl:C,runOnlyEl:I,runClearBtn:p,layoutAlgoEl:c,layoutCenterEl:V,layoutRefreshBtn:ot,layoutFitBtn:i,layoutResetViewBtn:h,labelDensityEl:_,navHelpEl:b,contextFilterEl:W,contextBadgeEl:$,componentJumpBtn:T,componentStatusEl:S,llmQuestionEl:P,llmAutoCommitEl:v,llmCertifyEl:tt,llmVerifyEl:st,llmRequireVerifiedEl:lt,llmAskBtn:et,llmToQueryBtn:pt,llmClearBtn:at,llmStatusEl:k,llmChatEl:O,llmCitationsEl:w,llmDebugEl:K,wmGoalsEl:L,wmMaxNewEl:Y,wmSeedEl:it,wmStepsEl:X,wmRolloutsEl:z,wmGuardrailProfileEl:G,wmGuardrailPlaneEl:N,wmIncludeGuardrailEl:A,wmTaskCostsEl:D,wmAutoCommitEl:j,wmCommitStepwiseEl:B,wmProposeBtn:x,wmPlanBtn:u,wmStatusEl:n,wmOutputEl:g,axqlQueryEl:m,axqlRunBtn:s,axqlCertBtn:F,axqlVerifyBtn:R,axqlStatusEl:J,axqlOutputEl:Q,certOutputEl:ct,addRelTypeEl:U,addSourceNameEl:ft,addTargetNameEl:wt,addPairingEl:nt,addContextEl:ut,addCtxFromFilterBtn:gt,addEvidenceTextEl:M,addConfidenceEl:rt,addConfidenceValEl:yt,addMessageEl:vt,addAdminTokenEl:It,addGenerateBtn:Ht,addCommitBtn:Pt,addStatusEl:qt,addOutputEl:Bt,addCommitOutputEl:Lt,addDraftAxiBtn:Rt,addPromoteAxiBtn:Dt,addPromoteStatusEl:Ct,addAxiTextEl:le,addPromoteOutputEl:ce,reviewFilterEl:de,reviewSelectAllBtn:ue,reviewSelectNoneBtn:me,reviewClearBtn:fe,reviewStatusEl:pe,reviewMessageEl:he,reviewAdminTokenEl:ge,reviewCommitBtn:ye,reviewDraftAxiBtn:ve,reviewPromoteAxiBtn:we,reviewListEl:_e,reviewValidationEl:Ee,reviewAxiTextEl:xe,reviewCommitOutputEl:be,reviewPromoteOutputEl:Se,reviewOverlayRawEl:ke,show_entity:Ce,show_fact:Ae,show_morphism:Be,show_homotopy:$e,show_meta:Ie,show_edge_relation:Le,show_edge_equivalence:Ne,show_edge_meta:Oe,clearPathBtn:Me,certifyPathBtn:jt,verifyPathBtn:Vt,pathStatusEl:Te,minConfidenceEl:Pe,minConfidenceValEl:qe,opacityByConfidenceEl:Re,isTupleLike:dn,nodeShortLabel:cn,nodeTitle:on,nodeDisplayName:ae,effectiveTypeLabel:rn,nodeColor:an,edgeColor:He,planeStrokeColor:sn,parseRelationSignatureFieldOrder:ln,parseRelationSignature:se,runIdForNode:un,escapeHtml:mn,clamp01:fn};Object.assign(q,On(q)),Object.assign(q,Nn(q));const Jt=Array.from(document.querySelectorAll(".tabbtn")),ne={explore:document.getElementById("tab_explore"),query:document.getElementById("tab_query"),llm:document.getElementById("tab_llm"),world_model:document.getElementById("tab_world_model"),review:document.getElementById("tab_review"),add:document.getElementById("tab_add")};function Wt(y){const Z=y&&ne[y]?y:"explore";for(const ht of Jt)ht.classList.toggle("active",(ht.dataset&&ht.dataset.tab)===Z);for(const[ht,_t]of Object.entries(ne))_t&&_t.classList.toggle("active",ht===Z);try{localStorage.setItem("axiograph_viz_sidebar_tab",Z)}catch{}}function Ve(){if(!Jt.length)return;for(const Z of Jt)Z.addEventListener("click",()=>{const ht=Z.dataset&&Z.dataset.tab||"explore";Wt(ht)});let y="explore";try{const Z=localStorage.getItem("axiograph_viz_sidebar_tab");Z&&(y=Z)}catch{}Wt(y)}if(Ve(),Array.isArray(t.contexts))for(const y of t.contexts){if(!y)continue;const Z=Number(y.id);if(!Number.isFinite(Z))continue;const ht=String(y.name||`Context#${Z}`);q.contextNameById.set(Z,ht)}for(const y of t.nodes)y.entity_type==="Context"&&q.contextNameById.set(y.id,y.name||`Context#${y.id}`);if(t.tuple_contexts&&typeof t.tuple_contexts=="object")for(const[y,Z]of Object.entries(t.tuple_contexts)){const ht=Number(y);if(!Number.isFinite(ht))continue;const _t=Array.isArray(Z)?Z:[];for(const bt of _t){const Et=Number(bt);Number.isFinite(Et)&&(q.factContexts.has(ht)||q.factContexts.set(ht,new Set),q.factContexts.get(ht).add(Et))}}else for(const y of t.edges)y.label==="axi_fact_in_context"&&(q.factContexts.has(y.source)||q.factContexts.set(y.source,new Set),q.factContexts.get(y.source).add(y.target));q.isServerMode=Fn,q.bfsDepths=je;function oe(y){return pn(q,y)}q.categorizeAttrs=Hn;function Ft(){oe(a.value);const y=q.selectedIdRef?q.selectedIdRef():null;if(y!=null){for(const Z of r.querySelectorAll(".node"))Z.classList.toggle("selected",Z.dataset.id===String(y));Kt(y),Gt(y)}}q.rerender=Ft,Sn(q),In(q),Object.assign(q,qn(q)),q.shortestPathEdgeIdxs=(y,Z)=>Bn(q,y,Z),q.updatePathStatus=()=>kt(q);const Ke=Ln(q);Object.assign(q,Ke),Kt=hn(q).renderDetail,Gt=gn(q).renderGraph,q.renderDetail=Kt,q.renderGraph=Gt,Object.assign(q,Pn(q)),oe(a.value),t.summary&&t.summary.focus_ids&&t.summary.focus_ids.length?q.selectNode(t.summary.focus_ids[0],!1):t.nodes.length&&q.selectNode(t.nodes[0].id,!1),$n(q),kn(q),Object.assign(q,Mn(q)),Object.assign(q,Tn(q)),q.clearPath=te,Object.assign(q,{setActiveTab:Wt,selectedContextFilter:()=>Cn(q),currentContextNameFromFilter:()=>re(q),updateContextBadge:()=>An(q),prefillAddFromToolLoop:Ge,rerender:Ft}),gt&&gt.addEventListener("click",()=>{const y=re(q);y&&ut&&(ut.value=y)});function zt(){if(!rt||!yt)return;const y=Number(rt.value||"0");yt.textContent=y.toFixed(2)}rt&&rt.addEventListener("input",zt),zt(),q.updateAddConfidenceLabel=zt;function Ge(y){if(!y)return!1;const Z=y&&y.artifacts&&y.artifacts.generated_overlay?y.artifacts.generated_overlay:null;if(Z&&Z.proposals_json)return setDraftOverlay(Z,{notePrefix:"generated from LLM"});const ht=Array.isArray(y.steps)?y.steps:[];for(let _t=ht.length-1;_t>=0;_t--){const bt=ht[_t];if(!bt||bt.tool!=="propose_relation_proposals"&&bt.tool!=="propose_relations_proposals"&&bt.tool!=="world_model_propose"&&bt.tool!=="world_model_plan")continue;const Et=bt.result||null;if(!(!Et||!Et.proposals_json))return setDraftOverlay(Et,{notePrefix:"generated from LLM (fallback)"})}return!1}function Je(y,Z){const ht=q.visibleEdgeIdxsAll(),_t=new Map;function bt(xt,Ot,Tt){_t.has(xt)||_t.set(xt,[]),_t.get(xt).push({to:Ot,edgeIdx:Tt})}for(const xt of ht){const Ot=t.edges[xt];Ot.relation_id!=null&&bt(Ot.source,Ot.target,xt)}const Et=[],St=new Map;for(Et.push(y),St.set(y,null);Et.length;){const xt=Et.shift();if(xt===Z)break;const Ot=_t.get(xt)||[];for(const Tt of Ot)St.has(Tt.to)||(St.set(Tt.to,{node:xt,edgeIdx:Tt.edgeIdx}),Et.push(Tt.to))}if(!St.has(Z))return[];const $t=[];let At=Z;for(;At!==y;){const xt=St.get(At);if(!xt)break;$t.push(xt.edgeIdx),At=xt.node}return $t.reverse(),$t}async function Ut(y){if(mt.pathStart==null||mt.pathEnd==null){mt.pathMessage="shift-click 2 nodes first",kt(q);return}const Z=window.location&&window.location.protocol;if(!(Z==="http:"||Z==="https:")){mt.pathMessage="certification requires server mode",kt(q);return}const ht=Je(mt.pathStart,mt.pathEnd);if(!ht.length){mt.pathMessage="no directed relation path (certifiable)",kt(q);return}mt.pathEdgeIdxs=ht,kt(q),Ft();const _t=[];let bt=mt.pathStart;for(const Et of ht){const St=t.edges[Et];if(St.relation_id==null){mt.pathMessage="path contains non-relation edges",kt(q);return}if(St.source!==bt){mt.pathMessage="path direction mismatch (internal)",kt(q);return}_t.push(St.relation_id),bt=St.target}mt.pathMessage=y?"certifying+verifying…":"certifying…",kt(q),q.setCertOutput&&q.setCertOutput("");try{const St=new URLSearchParams(window.location.search||"").get("snapshot"),$t={start:mt.pathStart,relation_ids:_t,verify:!!y,include_anchor:!1};St&&($t.snapshot=St);const At=await fetch("/cert/reachability",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify($t)}),xt=await At.json();if(q.setCertOutput&&q.setCertOutput(xt),!At.ok){mt.pathMessage=`error (${At.status})`,kt(q);return}mt.pathMessage=y?xt.certificate_verified?"verified":"not verified":"ok",kt(q)}catch(Et){mt.pathMessage="error",kt(q),q.setCertOutput&&q.setCertOutput(String(Et))}}q.certifySelectedPath=Ut,jt&&jt.addEventListener("click",()=>Ut(!1)),Vt&&Vt.addEventListener("click",()=>Ut(!0));const We=xn(q);Object.assign(q,We);const ze=bn(q);Object.assign(q,ze);const Ue=wn(q);Object.assign(q,Ue);const Ye=vn(q);Object.assign(q,Ye);const Qe=_n(q);Object.assign(q,Qe);const Xe=En(q);Object.assign(q,Xe),yn(q);function Ze(){const y=f.getAttribute("viewBox");if(!y)return{x:0,y:0,w:1e3,h:800};const Z=y.trim().split(/\s+/).map(Number);return Z.length!==4||Z.some(ht=>!Number.isFinite(ht))?{x:0,y:0,w:1e3,h:800}:{x:Z[0],y:Z[1],w:Z[2],h:Z[3]}}const dt=Ze();function Mt(){f.setAttribute("viewBox",`${dt.x} ${dt.y} ${dt.w} ${dt.h}`)}Mt();let Yt=!1,Nt=null;f.addEventListener("wheel",y=>{y.preventDefault();const Z=f.getBoundingClientRect(),ht=dt.x+(y.clientX-Z.left)*(dt.w/Z.width),_t=dt.y+(y.clientY-Z.top)*(dt.h/Z.height),bt=y.deltaY<0?.9:1.1,Et=Math.min(8e3,Math.max(200,dt.w*bt)),St=Math.min(8e3,Math.max(200,dt.h*bt)),$t=(ht-dt.x)/dt.w,At=(_t-dt.y)/dt.h;dt.x=ht-$t*Et,dt.y=_t-At*St,dt.w=Et,dt.h=St,Mt()},{passive:!1}),f.addEventListener("mousedown",y=>{y.altKey&&(Yt=!0,Nt={x:y.clientX,y:y.clientY,vx:dt.x,vy:dt.y},y.preventDefault())}),window.addEventListener("mousemove",y=>{if(!Yt||!Nt)return;const Z=f.getBoundingClientRect(),ht=(y.clientX-Nt.x)*(dt.w/Z.width),_t=(y.clientY-Nt.y)*(dt.h/Z.height);dt.x=Nt.vx-ht,dt.y=Nt.vy-_t,Mt()}),window.addEventListener("mouseup",()=>{Yt=!1,Nt=null});function Qt(){if(!mt.layoutBounds)return;const y=90;dt.x=mt.layoutBounds.minX-y,dt.y=mt.layoutBounds.minY-y,dt.w=Math.max(200,mt.layoutBounds.maxX-mt.layoutBounds.minX+y*2),dt.h=Math.max(200,mt.layoutBounds.maxY-mt.layoutBounds.minY+y*2),Mt()}function Xt(){const y=mt.layoutBounds&&mt.layoutBounds.W?mt.layoutBounds.W:1e3,Z=mt.layoutBounds&&mt.layoutBounds.H?mt.layoutBounds.H:800;dt.x=0,dt.y=0,dt.w=y,dt.h=Z,Mt()}function tn(y){if(!mt.nodePos||!mt.nodePos.has(y))return;const Z=mt.nodePos.get(y);dt.x=Z.x-dt.w/2,dt.y=Z.y-dt.h/2,Mt()}i&&i.addEventListener("click",Qt),h&&h.addEventListener("click",Xt),q.fitViewToLayoutBounds=Qt,q.resetViewToDefault=Xt,q.centerViewOnNode=tn,window.addEventListener("keydown",y=>{const Z=y.target&&y.target.tagName?String(y.target.tagName).toLowerCase():"";if(!(Z==="input"||Z==="textarea"||y.isComposing)){if(y.key==="/"&&!y.ctrlKey&&!y.metaKey&&!y.altKey){a&&a.focus(),y.preventDefault();return}if(y.key==="?"&&!y.ctrlKey&&!y.metaKey&&!y.altKey){b&&(b.open=!b.open),y.preventDefault();return}if((y.key==="r"||y.key==="R")&&!y.ctrlKey&&!y.metaKey&&!y.altKey){mt.layoutSeed=Number(mt.layoutSeed||0)+1>>>0,Ft(),y.preventDefault();return}if((y.key==="f"||y.key==="F")&&!y.ctrlKey&&!y.metaKey&&!y.altKey){Qt(),y.preventDefault();return}if(y.key==="0"&&!y.ctrlKey&&!y.metaKey&&!y.altKey){Xt(),y.preventDefault();return}y.key==="Escape"&&(te(q),Ft())}})}function Vn(t){var a,f;const e=document.getElementById("graph_nodes"),r=document.getElementById("graph_edges"),o=document.getElementById("graph_truncated");e&&(e.textContent=String(((a=t.nodes)==null?void 0:a.length)??0)),r&&(r.textContent=String(((f=t.edges)==null?void 0:f.length)??0)),o&&(o.textContent=String(!!t.truncated))}async function ie(t){try{const e=await fetch(t,{cache:"no-store"});return e.ok?await e.json():null}catch{return null}}async function Kn(){const e=new URLSearchParams(window.location.search||"").get("data"),r=window.location.protocol==="http:"||window.location.protocol==="https:";let o=null;if(e?o=await ie(e):r&&(o=await ie("/viz.json"+window.location.search)),!o){console.error("Axiograph viz: missing graph JSON. Use ?data=graph.json or serve from /viz.");return}Vn(o),jn(o)}Kn();
