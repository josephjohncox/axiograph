(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const u of a)if(u.type==="childList")for(const l of u.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function r(a){const u={};return a.integrity&&(u.integrity=a.integrity),a.referrerPolicy&&(u.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?u.credentials="include":a.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function o(a){if(a.ep)return;a.ep=!0;const u=r(a);fetch(a.href,u)}})();function tn(){return{nodesEl:document.getElementById("nodes"),detailEl:document.getElementById("detail"),searchEl:document.getElementById("search"),svg:document.getElementById("svg"),serverControlsEl:document.getElementById("server_controls"),show_plane_accepted:document.getElementById("show_plane_accepted"),show_plane_evidence:document.getElementById("show_plane_evidence"),show_plane_data:document.getElementById("show_plane_data"),runFilterEl:document.getElementById("run_filter"),runOnlyEl:document.getElementById("show_only_run"),runClearBtn:document.getElementById("run_clear"),layoutAlgoEl:document.getElementById("layout_algo"),layoutCenterEl:document.getElementById("layout_center"),layoutRefreshBtn:document.getElementById("layout_refresh"),layoutFitBtn:document.getElementById("layout_fit"),layoutResetViewBtn:document.getElementById("layout_reset_view"),labelDensityEl:document.getElementById("label_density"),navHelpEl:document.getElementById("nav_help"),contextFilterEl:document.getElementById("context_filter"),contextBadgeEl:document.getElementById("context_badge"),componentJumpBtn:document.getElementById("jump_component"),componentStatusEl:document.getElementById("component_status"),llmQuestionEl:document.getElementById("llm_question"),llmAutoCommitEl:document.getElementById("llm_auto_commit"),llmCertifyEl:document.getElementById("llm_certify"),llmVerifyEl:document.getElementById("llm_verify"),llmRequireVerifiedEl:document.getElementById("llm_require_verified"),llmAskBtn:document.getElementById("llm_ask"),llmToQueryBtn:document.getElementById("llm_to_query"),llmClearBtn:document.getElementById("llm_clear"),llmStatusEl:document.getElementById("llm_status"),llmChatEl:document.getElementById("llm_chat"),llmCitationsEl:document.getElementById("llm_citations"),llmDebugEl:document.getElementById("llm_debug"),wmGoalsEl:document.getElementById("wm_goals"),wmMaxNewEl:document.getElementById("wm_max_new"),wmSeedEl:document.getElementById("wm_seed"),wmStepsEl:document.getElementById("wm_steps"),wmRolloutsEl:document.getElementById("wm_rollouts"),wmGuardrailProfileEl:document.getElementById("wm_guardrail_profile"),wmGuardrailPlaneEl:document.getElementById("wm_guardrail_plane"),wmIncludeGuardrailEl:document.getElementById("wm_include_guardrail"),wmTaskCostsEl:document.getElementById("wm_task_costs"),wmAutoCommitEl:document.getElementById("wm_auto_commit"),wmCommitStepwiseEl:document.getElementById("wm_commit_stepwise"),wmProposeBtn:document.getElementById("wm_propose"),wmPlanBtn:document.getElementById("wm_plan"),wmStatusEl:document.getElementById("wm_status"),wmOutputEl:document.getElementById("wm_output"),axqlQueryEl:document.getElementById("axql_query"),axqlRunBtn:document.getElementById("axql_run"),axqlCertBtn:document.getElementById("axql_cert"),axqlVerifyBtn:document.getElementById("axql_verify"),axqlStatusEl:document.getElementById("axql_status"),axqlOutputEl:document.getElementById("axql_output"),certOutputEl:document.getElementById("cert_output"),addRelTypeEl:document.getElementById("add_rel_type"),addSourceNameEl:document.getElementById("add_source_name"),addTargetNameEl:document.getElementById("add_target_name"),addPairingEl:document.getElementById("add_pairing"),addContextEl:document.getElementById("add_context"),addCtxFromFilterBtn:document.getElementById("add_ctx_from_filter"),addEvidenceTextEl:document.getElementById("add_evidence_text"),addConfidenceEl:document.getElementById("add_confidence"),addConfidenceValEl:document.getElementById("add_confidence_val"),addMessageEl:document.getElementById("add_message"),addAdminTokenEl:document.getElementById("add_admin_token"),addGenerateBtn:document.getElementById("add_generate"),addCommitBtn:document.getElementById("add_commit"),addStatusEl:document.getElementById("add_status"),addOutputEl:document.getElementById("add_output"),addCommitOutputEl:document.getElementById("add_commit_output"),addDraftAxiBtn:document.getElementById("add_draft_axi"),addPromoteAxiBtn:document.getElementById("add_promote_axi"),addPromoteStatusEl:document.getElementById("add_promote_status"),addAxiTextEl:document.getElementById("add_axi_text"),addPromoteOutputEl:document.getElementById("add_promote_output"),reviewFilterEl:document.getElementById("review_filter"),reviewSelectAllBtn:document.getElementById("review_select_all"),reviewSelectNoneBtn:document.getElementById("review_select_none"),reviewClearBtn:document.getElementById("review_clear"),reviewStatusEl:document.getElementById("review_status"),reviewMessageEl:document.getElementById("review_message"),reviewAdminTokenEl:document.getElementById("review_admin_token"),reviewCommitBtn:document.getElementById("review_commit"),reviewDraftAxiBtn:document.getElementById("review_draft_axi"),reviewPromoteAxiBtn:document.getElementById("review_promote_axi"),reviewListEl:document.getElementById("review_list"),reviewValidationEl:document.getElementById("review_validation"),reviewAxiTextEl:document.getElementById("review_axi_text"),reviewCommitOutputEl:document.getElementById("review_commit_output"),reviewPromoteOutputEl:document.getElementById("review_promote_output"),reviewOverlayRawEl:document.getElementById("review_overlay_raw"),show_entity:document.getElementById("show_entity"),show_fact:document.getElementById("show_fact"),show_morphism:document.getElementById("show_morphism"),show_homotopy:document.getElementById("show_homotopy"),show_meta:document.getElementById("show_meta"),show_edge_relation:document.getElementById("show_edge_relation"),show_edge_equivalence:document.getElementById("show_edge_equivalence"),show_edge_meta:document.getElementById("show_edge_meta"),clearPathBtn:document.getElementById("clear_path"),certifyPathBtn:document.getElementById("certify_path"),verifyPathBtn:document.getElementById("verify_path"),pathStatusEl:document.getElementById("path_status"),minConfidenceEl:document.getElementById("min_confidence"),minConfidenceValEl:document.getElementById("min_confidence_val"),opacityByConfidenceEl:document.getElementById("opacity_by_confidence")}}function en(e){const t=new Map(e.nodes.map(a=>[a.id,a])),r=new Map,o=new Map;for(const a of e.edges)r.has(a.source)||r.set(a.source,[]),r.get(a.source).push(a),o.has(a.target)||o.set(a.target,[]),o.get(a.target).push(a);return{nodeById:t,outEdgesBySource:r,inEdgesByTarget:o}}function ie(e){return e?e.display_name?String(e.display_name):e.name?String(e.name):e.attrs&&e.attrs.name?String(e.attrs.name):"":""}function nn(e){const t=ie(e);return t&&t!==`${e.entity_type}#${e.id}`?`${e.entity_type}#${e.id} — ${t}`:`${e.entity_type}#${e.id}`}function on(e){return e?e.type_label?String(e.type_label):(e.kind==="fact"||e.kind==="morphism"||e.kind==="homotopy")&&e.attrs&&e.attrs.axi_relation?String(e.attrs.axi_relation):e.entity_type||"(unknown)":"(unknown)"}function rn(e){return e.kind==="meta"?"#d6d6d6":e.kind==="morphism"?"#c6f6d5":e.kind==="homotopy"?"#e9d8fd":e.kind==="fact"?"#ffe08a":"#9ec5ff"}function an(e){const t=e&&e.plane?String(e.plane):"";return t==="accepted"?"#1b5e20":t==="evidence"?"#b85c00":t==="data"?"#2b7fff":t==="meta"?"#777":"#666"}function sn(e){const t=ae(e);return!t||!t.fields||!t.fields.length?null:t.fields.map(r=>r.name)}function ae(e){if(!e)return null;const t=String(e),r=t.indexOf("("),o=t.lastIndexOf(")");if(r<0||o<=r)return null;const a=t.slice(0,r).trim()||null,u=t.slice(r+1,o).trim();if(!u)return{relation:a,fields:[]};const l=[];for(const A of u.split(",")){const c=A.trim();if(!c)continue;const[R,D]=c.split(":"),M=(R||"").trim(),_=(D||"").trim();M&&l.push({name:M,ty:_||null})}return{relation:a,fields:l}}function ln(e){return e?e.name?String(e.name):`${e.entity_type}#${e.id}`:"(unknown)"}function cn(e){return e?e.kind==="fact"||e.kind==="morphism"||e.kind==="homotopy":!1}function dn(e){if(!e||!e.attrs)return"";const t=e.attrs.meta_axiograph_world_model_trace_id||e.attrs.axiograph_world_model_trace_id;return t?String(t):""}function un(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function mn(e){return!Number.isFinite(e)||e<0?0:e>1?1:e}function fn(e,t){const{graph:r,ui:o,nodesEl:a,isNodeVisible:u,nodeDisplayName:l,effectiveTypeLabel:A,escapeHtml:c,selectNode:R,selectedIdRef:D}=e;a.innerHTML="",a.classList.remove("node-list-virtual");const M=(t||"").trim().toLowerCase(),_=[];for(const b of r.nodes){if(!u(b))continue;const j=l(b),x=`${b.id} ${b.entity_type} ${b.kind||""} ${j}`.toLowerCase();if(M&&!x.includes(M))continue;const N=b.kind||"entity",p=A(b);_.push({node:b,disp:j,kind:N,entityType:p})}if(!_.length){a.innerHTML='<div class="muted" style="margin-top:8px;">(no matching nodes)</div>';return}const s=2e3,G=64,rt=6,f=new Map([["entity",0],["fact",1],["morphism",2],["homotopy",3],["meta",4]]);function S(b,j){const x=f.has(b.kind)?f.get(b.kind):99,N=f.has(j.kind)?f.get(j.kind):99;if(x!==N)return x-N;if(b.entityType!==j.entityType)return b.entityType.localeCompare(j.entityType);const p=b.disp||"",X=j.disp||"";return p!==X?p.localeCompare(X):b.node.id-j.node.id}if(_.length>s){let b=function(){const lt=x.scrollTop||0,ct=x.clientHeight||320,it=Math.max(0,Math.floor(lt/G)-rt),mt=Math.min(_.length,it+Math.ceil(ct/G)+rt*2);p.style.transform=`translateY(${it*G}px)`,p.innerHTML="";const at=D?D():null;for(let E=it;E<mt;E++){const I=_[E],g=I.node,K=o.highlightIds&&o.highlightIds.has(g.id),O=document.createElement("div");O.className="node",O.dataset.id=String(g.id),K&&O.classList.add("highlighted"),at!=null&&at===g.id&&O.classList.add("selected"),O.innerHTML=`<div><strong>${c(I.entityType)}</strong> <span class="muted">#${g.id} • ${c(I.kind)}</span></div>`+(I.disp?`<div>${K?"★ ":""}${c(I.disp)}</div>`:'<div class="muted">(no name)</div>'),O.addEventListener("click",J=>R(g.id,J.shiftKey)),p.appendChild(O)}};_.sort(S);const j=document.createElement("div");j.className="muted",j.style.marginTop="6px",j.textContent=`showing ${_.length} nodes (virtualized)`,a.appendChild(j);const x=document.createElement("div");x.className="node-list-virtual",a.appendChild(x);const N=document.createElement("div");N.className="node-list-spacer",N.style.height=`${_.length*G}px`,x.appendChild(N);const p=document.createElement("div");p.className="node-list-viewport",x.appendChild(p);let X=null;x.addEventListener("scroll",()=>{X&&cancelAnimationFrame(X),X=requestAnimationFrame(b)}),b();return}const B=new Map;for(const b of _){const j=`${b.kind}::${b.entityType}`;B.has(j)||B.set(j,{kind:b.kind,entityType:b.entityType,nodes:[]}),B.get(j).nodes.push(b.node)}const P=Array.from(B.values()).sort((b,j)=>{const x=f.has(b.kind)?f.get(b.kind):99,N=f.has(j.kind)?f.get(j.kind):99;return x!==N?x-N:b.entityType.localeCompare(j.entityType)}),Z=D?D():null;for(const b of P){b.nodes.sort((N,p)=>S({node:N,disp:l(N),kind:N.kind||"entity",entityType:A(N)},{node:p,disp:l(p),kind:p.kind||"entity",entityType:A(p)}));const j=document.createElement("details");j.className="nodegroup",j.open=!!M||b.nodes.length<=20;const x=document.createElement("summary");x.innerHTML=`<strong>${c(b.entityType)}</strong><span class="muted">${c(b.kind)} • ${b.nodes.length}</span>`,j.appendChild(x);for(const N of b.nodes){const p=l(N),X=document.createElement("div");X.className="node",X.dataset.id=String(N.id);const lt=o.highlightIds&&o.highlightIds.has(N.id);lt&&X.classList.add("highlighted"),Z!=null&&Z===N.id&&X.classList.add("selected"),X.innerHTML=`<div><strong>${c(A(N))}</strong> <span class="muted">#${N.id} • ${c(N.kind||"entity")}</span></div>`+(p?`<div>${lt?"★ ":""}${c(p)}</div>`:'<div class="muted">(no name)</div>'),X.addEventListener("click",ct=>R(N.id,ct.shiftKey)),j.appendChild(X)}a.appendChild(j)}}function pn(e){const{graph:t,ui:r,nodeById:o,outEdgesBySource:a,inEdgesByTarget:u,isEdgeVisible:l,detailEl:A,nodeDisplayName:c,effectiveTypeLabel:R,nodeTitle:D,nodeShortLabel:M,isTupleLike:_,escapeHtml:s,parseRelationSignature:G,parseRelationSignatureFieldOrder:rt,factSummary:f,morphismSummary:S,homotopySummary:B,proposalRunSummary:P,documentSummary:Z,docChunkSummary:b,categorizeAttrs:j,setActiveDetailTab:x,firstOutTargetId:N,shortenHash:p,isServerMode:X,selectNode:lt}=e;function ct(I,g){const K=new Map;for(const ot of I){const Q=String(ot.label||"");K.has(Q)||K.set(Q,[]),K.get(Q).push(ot)}const O=Array.from(K.keys()).sort((ot,Q)=>ot.localeCompare(Q));if(!O.length)return'<div class="muted">(none)</div>';const J=[];for(const ot of O){const Q=K.get(ot)||[];Q.sort((C,T)=>{const V=g==="out"?C.target:C.source,k=g==="out"?T.target:T.source;return V-k});const W=Q.length<=5,w=Q.map(C=>{const T=g==="out"?C.target:C.source,V=o.get(T),k=V?D(V):String(T),H=C.confidence!=null?Number(C.confidence).toFixed(3):"",h=V?`<a class="link" href="#" data-id="${T}">${s(k)}</a>`:s(k),d=s(C.kind||"");return`<tr><td>${h}</td><td class="muted">${d}</td><td class="muted">${H}</td></tr>`}).join("");J.push(`
      <details ${W?"open":""} style="margin-top:10px;">
        <summary><code>${s(ot)}</code><span class="muted" style="margin-left:6px;">${Q.length} edge${Q.length===1?"":"s"}</span></summary>
        <table style="margin-top:8px;">
          <thead><tr><th>${g==="out"?"to":"from"}</th><th>kind</th><th>conf</th></tr></thead>
          <tbody>${w||'<tr><td class="muted">(none)</td><td></td><td></td></tr>'}</tbody>
        </table>
      </details>
    `)}return J.join("")}function it(I,g){const K=g&&Number(g.limit)||120,O=g&&g.title?String(g.title):"",J=g&&g.empty?String(g.empty):"(none)",ot=[];for(const T of I||[]){const V=o.get(T);V&&ot.push(V)}if(!ot.length)return`<div class="muted">${s(J)}</div>`;const Q=new Map;for(const T of ot){const V=T.kind||"entity",k=R(T),H=`${V}::${k}`;Q.has(H)||Q.set(H,{kind:V,entityType:k,nodes:[]}),Q.get(H).nodes.push(T)}const W=new Map([["entity",0],["fact",1],["morphism",2],["homotopy",3],["meta",4]]),w=Array.from(Q.values()).sort((T,V)=>{const k=W.has(T.kind)?W.get(T.kind):99,H=W.has(V.kind)?W.get(V.kind):99;return k!==H?k-H:T.entityType.localeCompare(V.entityType)}),C=[];O&&C.push(`<h3>${s(O)}</h3>`);for(const T of w){T.nodes.sort((h,d)=>{const n=c(h)||"",m=c(d)||"";return n!==m?n.localeCompare(m):h.id-d.id});const k=T.nodes.slice(0,K).map(h=>{const d=c(h)||D(h);return`<tr><td><a class="link" href="#" data-id="${h.id}">${s(d)}</a></td><td class="muted">${s(h.kind||"entity")}</td></tr>`}).join(""),H=T.nodes.length>K?`<div class="muted" style="margin-top:6px;">showing ${K} of ${T.nodes.length} (increase viz max_nodes/hops for more)</div>`:"";C.push(`
      <details open style="margin-top:10px;">
        <summary><strong>${s(T.entityType)}</strong><span class="muted" style="margin-left:6px;">${s(T.kind)} • ${T.nodes.length}</span></summary>
        <table style="margin-top:8px;"><thead><tr><th>node</th><th>kind</th></tr></thead><tbody>${k}</tbody></table>
        ${H}
      </details>
    `)}return C.join("")}function mt(I){const g=(I||[]).filter(K=>K&&K.length>=2).map(([K,O])=>{if(O==null)return"";const J=String(O);return J.trim()?`<tr><td><code>${s(K)}</code></td><td>${s(J)}</td></tr>`:""}).filter(K=>K.length>0).join("");return g?`<table><tbody>${g}</tbody></table>`:'<div class="muted">(no details)</div>'}function at(I){const g=G(I.attrs&&I.attrs.axi_overlay_relation_signature),K=g&&g.fields?g.fields:null,O=new Map;if(K)for(let w=0;w<K.length;w++)O.set(K[w].name,w);const J=a.get(I.id)||[],ot=[];for(const w of J){if(!w||w.kind!=="relation")continue;const C=String(w.label||"");if(!C||C==="axi_fact_of"||C==="axi_fact_in_context"||C.startsWith("axi_"))continue;const T=o.get(w.target);ot.push({label:C,targetId:w.target,targetNode:T||null})}if(!ot.length)return'<div class="muted">(no fields)</div>';ot.sort((w,C)=>{const T=O.has(w.label)?O.get(w.label):1e4,V=O.has(C.label)?O.get(C.label):1e4;return T!==V?T-V:w.label.localeCompare(C.label)});const Q=new Map;if(K)for(const w of K)Q.set(w.name,w.ty||"");return`
    <table>
      <thead><tr><th>field</th><th>type</th><th>value</th></tr></thead>
      <tbody>${ot.map(w=>{const C=Q.get(w.label)||"",T=w.targetNode?D(w.targetNode):String(w.targetId),V=w.targetNode?`<a class="link" href="#" data-id="${w.targetId}">${s(M(w.targetNode))}</a>`:s(T);return`<tr><td><code>${s(w.label)}</code></td><td>${C?`<span class="muted">${s(C)}</span>`:""}</td><td>${V}</td></tr>`}).join("")}</tbody>
    </table>
  `}function E(I){const g=o.get(I);if(!g)return;A.classList.remove("muted");const K=(a.get(I)||[]).filter(l),O=(u.get(I)||[]).filter(l),J=g.kind==="fact"?f(g):g.kind==="morphism"?S(g):g.kind==="homotopy"?B(g):null,ot=J||(g.entity_type==="ProposalRun"?P(g):null)||(g.entity_type==="Document"?Z(g):null)||(g.entity_type==="DocChunk"?b(g):null),Q=g.attrs||{},W=j(Q),w=new Map;if(!_(g))for(const d of O){const n=o.get(d.source);if(!n||!_(n))continue;const m=n.attrs&&n.attrs.axi_relation?String(n.attrs.axi_relation):String(n.entity_type||"Fact");w.has(m)||w.set(m,[]),w.get(m).push({field:String(d.label||""),factId:n.id,factNode:n})}const C=(()=>{if(g.entity_type==="ProposalRun"){const m=K.filter(i=>String(i.label||"")==="run_has_proposal").map(i=>i.target);return`
        <div class="muted" style="margin-bottom:10px;">Evidence-plane proposals imported in this run.</div>
        ${it(m,{title:"Proposals (visible in this view)",empty:"(no proposals in this view)",limit:200})}
      `}if(g.entity_type==="Document"){const m=K.filter(i=>String(i.label||"")==="document_has_chunk").map(i=>i.target);return`
        <div class="muted" style="margin-bottom:10px;">Document evidence chunks (extension layer).</div>
        ${it(m,{title:"Chunks (visible in this view)",empty:"(no chunks in this view)",limit:80})}
      `}if(g.entity_type==="DocChunk"){const m=N(g.id,"doc_chunk_about"),i=N(g.id,"chunk_in_document"),y=m!=null?o.get(m):null,F=i!=null?o.get(i):null,$=String(Q.text||"").trim(),Y=$.length>280?$.slice(0,280)+"…":$;return`
        ${y?`<div class="muted" style="margin-bottom:6px;">about: <a class="link" href="#" data-id="${m}">${s(D(y))}</a></div>`:""}
        ${F?`<div class="muted" style="margin-bottom:10px;">document: <a class="link" href="#" data-id="${i}">${s(D(F))}</a></div>`:""}
        ${Y?`<pre style="white-space:pre-wrap; max-height:260px; overflow:auto; margin:0;">${s(Y)}</pre>`:'<div class="muted">(no text)</div>'}
      `}if(_(g)){const m=Q.axi_overlay_relation_signature?String(Q.axi_overlay_relation_signature):"",i=Q.axi_overlay_constraints?String(Q.axi_overlay_constraints):"";return`
        <div style="margin-bottom:10px;">
          ${J?`<div><code>${s(J)}</code></div>`:""}
          <div class="muted" style="margin-top:6px;">Tuple nodes are reified n-ary facts. Some are additionally tagged as <code>Morphism</code> or <code>Homotopy</code> (so arrows/equivalences are first-class objects). This is how we attach context/time/provenance/constraints and later certificates to the *assertion itself*.</div>
        </div>
        ${m?`<div class="muted" style="margin-bottom:6px;">signature: <code>${s(m)}</code></div>`:""}
        ${i?`<div class="muted" style="margin-bottom:10px;">constraints: <code>${s(i)}</code></div>`:""}
        ${at(g)}
      `}const d=Array.from(w.keys()).sort((m,i)=>m.localeCompare(i));if(!d.length)return'<div class="muted">(no fact nodes mention this)</div>';const n=[];for(const m of d){const i=w.get(m)||[];i.sort((F,$)=>F.factId-$.factId);const y=i.map(F=>{const $=F.factNode,Y=$?D($):`Fact#${F.factId}`,z=$?`<a class="link" href="#" data-id="${F.factId}">${s(f($)||Y)}</a>`:s(Y);return`<tr><td><code>${s(F.field)}</code></td><td>${z}</td></tr>`}).join("");n.push(`
        <details open style="margin-top:10px;">
          <summary><strong>${s(m)}</strong> <span class="muted">(${i.length})</span></summary>
          <table style="margin-top:8px;">
            <thead><tr><th>as field</th><th>fact</th></tr></thead>
            <tbody>${y}</tbody>
          </table>
        </details>
      `)}return n.join("")})(),T=(()=>{if(!X())return'<div class="muted">DB describe requires server mode (<code>axiograph db serve</code>).</div>';const d=r.describeCache?r.describeCache.get(I):null;if(!d||d.status==="loading")return'<div class="muted">Loading…</div>';if(d.status==="error")return`<pre style="white-space:pre-wrap; max-height:340px; overflow:auto; margin:0;">${s(JSON.stringify(d.data||{error:"unknown"},null,2))}</pre>`;const n=d.data&&d.data.result?d.data.result:d.data;if(!n)return'<div class="muted">(no data)</div>';const m=Array.isArray(n.contexts)?n.contexts:[],i=Array.isArray(n.equivalences)?n.equivalences:[],y=Array.isArray(n.outgoing)?n.outgoing:[],F=Array.isArray(n.incoming)?n.incoming:[];function $(U){if(!U||U.id==null)return"";const gt=Number(U.id),yt=String(U.name||U.id);return o.has(gt)?`<a class="link" href="#" data-id="${gt}">${s(yt)}</a>`:`<a class="link" href="#" data-focus-id="${gt}">${s(yt)}</a>`}function Y(U){if(!U.length)return'<div class="muted">(none)</div>';const gt=[];for(const yt of U){if(!yt)continue;const et=String(yt.rel||""),L=Number(yt.count||0),nt=(Array.isArray(yt.edges)?yt.edges:[]).map(st=>{const St=st&&st.confidence!=null?Number(st.confidence).toFixed(3):"1.000",kt=st&&st.entity?st.entity:null,It=$(kt);return`<li><code>${s(St)}</code> ${It||s(String(kt&&kt.id||""))}</li>`}).join("");gt.push(`
          <details style="margin-top:10px;">
            <summary><code>${s(et)}</code> <span class="muted">(${L})</span></summary>
            <ul style="margin-top:8px; padding-left:18px;">${nt||'<li class="muted">(no samples)</li>'}</ul>
          </details>
        `)}return gt.join("")}const z=m.length?`<ul style="margin:0; padding-left:18px;">${m.map(U=>`<li>${$(U)}</li>`).join("")}</ul>`:'<div class="muted">(none)</div>',dt=i.length?`<ul style="margin:0; padding-left:18px;">${i.map(U=>{const gt=U&&U.other?U.other:null,yt=U&&U.kind?String(U.kind):"";return`<li>${$(gt)} ${yt?`<span class="muted">(${s(yt)})</span>`:""}</li>`}).join("")}</ul>`:'<div class="muted">(none)</div>';return`
      <div class="muted" style="margin-bottom:10px;">Full-snapshot details (on-demand; not limited to this neighborhood view).</div>
      <h3>Contexts</h3>
      ${z}
      <h3 style="margin-top:14px;">Equivalences</h3>
      ${dt}
      <h3 style="margin-top:14px;">Outgoing</h3>
      ${Y(y)}
      <h3 style="margin-top:14px;">Incoming</h3>
      ${Y(F)}
    `})(),V=(()=>{function d(F){return F.map(([$,Y])=>{const z=String(Y),U=$==="text"||$==="search_text"||$==="markdown"?`<pre style="white-space:pre-wrap; max-height:240px; overflow:auto; margin:0;">${s(z)}</pre>`:s(z);return`<tr><td><code>${s($)}</code></td><td>${U}</td></tr>`}).join("")}const n=d(W.other),m=d(W.content),i=d(W.overlay),y=d(W.axi);return`
      ${W.content.length?`<h3>Content</h3><table><tbody>${m}</tbody></table>`:'<div class="muted">(no content fields)</div>'}
      <details style="margin-top:12px;" ${W.other.length?"open":""}>
        <summary>Other attributes <span class="muted">(${W.other.length})</span></summary>
        <table style="margin-top:8px;"><tbody>${n||'<tr><td class="muted">(none)</td><td></td></tr>'}</tbody></table>
      </details>
      <details style="margin-top:12px;">
        <summary>Axi metadata <span class="muted">(${W.axi.length})</span></summary>
        <table style="margin-top:8px;"><tbody>${y||'<tr><td class="muted">(none)</td><td></td></tr>'}</tbody></table>
      </details>
      <details style="margin-top:12px;">
        <summary>Overlay attributes <span class="muted">(${W.overlay.length})</span></summary>
        <table style="margin-top:8px;"><tbody>${i||'<tr><td class="muted">(none)</td><td></td></tr>'}</tbody></table>
      </details>
    `})(),k=(()=>{const d=g.plane?String(g.plane):"",n=g.kind?String(g.kind):"entity",m=(()=>{if(g.entity_type==="ProposalRun"){const i=K.filter(y=>String(y.label||"")==="run_has_proposal").length;return mt([["schema_hint",Q.schema_hint],["source_type",Q.source_type],["source_locator",Q.source_locator],["generated_at",Q.generated_at],["proposals_digest",Q.proposals_digest?p(Q.proposals_digest):""],["visible_proposals",String(i)]])}if(g.entity_type==="Document"){const i=K.filter(y=>String(y.label||"")==="document_has_chunk").length;return mt([["document_id",Q.document_id],["visible_chunks",String(i)]])}if(g.entity_type==="DocChunk")return mt([["chunk_id",Q.chunk_id],["document_id",Q.document_id],["span_id",Q.span_id],["page",Q.page]]);if(g.entity_type==="AxiMetaTheory"){const i=K.filter($=>String($.label||"")==="axi_theory_has_constraint").map($=>$.target),y=[];for(const $ of i){const Y=o.get($);!Y||(Y.attrs&&Y.attrs.axi_constraint_kind?String(Y.attrs.axi_constraint_kind):"")!=="named_block"||y.push(Y)}return y.sort(($,Y)=>String($.attrs&&$.attrs.axi_constraint_name||$.display_name||"").localeCompare(String(Y.attrs&&Y.attrs.axi_constraint_name||Y.display_name||""))),y.length?`
          <div class="muted" style="margin-bottom:8px;">Named-block constraints are preserved as structured (but opaque) theory content.</div>
          <table><thead><tr><th>named blocks</th></tr></thead><tbody>${y.map($=>{const Y=$.attrs&&$.attrs.axi_constraint_name?String($.attrs.axi_constraint_name):$.display_name||"";return`<tr><td><a class="link" href="#" data-id="${$.id}">${s(Y)}</a></td></tr>`}).join("")}</tbody></table>
        `:'<div class="muted">(no named-block constraints in this view)</div>'}return""})();return`
      <div style="margin-bottom:10px;">
        <div class="muted">type: <code>${s(g.entity_type)}</code> • id: <code>${g.id}</code> • kind: <code>${s(n)}</code>${d?` • plane: <code>${s(d)}</code>`:""}</div>
        ${ot?`<div class="muted" style="margin-top:6px;">summary: <code>${s(ot)}</code></div>`:""}
      </div>
      ${m||""}
      ${r.pathStart!=null&&r.pathEnd!=null?`<h3>Selected path</h3>
           <div class="muted">Shift-click two nodes (in list or graph) to highlight a shortest path (within the current filtered subgraph).</div>
           <table style="margin-top:8px;"><thead><tr><th>step</th><th>edge</th><th>between</th></tr></thead><tbody>${r.pathEdgeIdxs.length?r.pathEdgeIdxs.map((i,y)=>{const F=t.edges[i],$=o.get(F.source),Y=o.get(F.target),z=$?D($):String(F.source),dt=Y?D(Y):String(F.target);return`<tr><td>${y}</td><td><code>${s(F.label)}</code></td><td>${s(z)} → ${s(dt)}</td></tr>`}).join(""):'<tr><td class="muted">(no path found)</td><td></td><td></td></tr>'}</tbody></table>`:'<div class="muted">(tip: shift-click 2 nodes to highlight a path)</div>'}
    `})();A.innerHTML=`
    <h2 style="margin:0 0 6px 0;">${s(D(g))}</h2>

    <div class="detailtabs">
      <button class="detailtabbtn" data-dtab="overview" type="button">overview</button>
      <button class="detailtabbtn" data-dtab="facts" type="button">${_(g)?"tuple":"facts"}</button>
      <button class="detailtabbtn" data-dtab="edges" type="button">edges</button>
      <button class="detailtabbtn" data-dtab="attrs" type="button">attrs</button>
      <button class="detailtabbtn" data-dtab="db" type="button">db</button>
    </div>

    <div class="detailtabpanel" data-dtab="overview">${k}</div>
    <div class="detailtabpanel" data-dtab="facts">${C}</div>
    <div class="detailtabpanel" data-dtab="edges">
      <h3>Outgoing</h3>
      ${ct(K,"out")}
      <h3 style="margin-top:16px;">Incoming</h3>
      ${ct(O,"in")}
    </div>
    <div class="detailtabpanel" data-dtab="attrs">${V}</div>
    <div class="detailtabpanel" data-dtab="db">${T}</div>
  `;const H=_(g)?"facts":"overview",h=r.detailTab||H;x(h);for(const d of A.querySelectorAll(".detailtabbtn"))d.addEventListener("click",()=>x(d.dataset&&d.dataset.dtab||"overview"));for(const d of A.querySelectorAll("a.link"))d.addEventListener("click",n=>{n.preventDefault();const m=Number(d.dataset.id||"0"),i=Number(d.dataset.focusId||"0");if(m){lt(m,!1);return}if(i&&X()){const y=new URLSearchParams(window.location.search||"");y.set("focus_id",String(i)),y.delete("focus_name"),window.location.search=y.toString()}})}return{renderDetail:E}}function hn(e){const{graph:t,ui:r,svg:o,nodeById:a,outEdgesBySource:u,inEdgesByTarget:l,isNodeVisible:A,isEdgeVisible:c,nodeDisplayName:R,nodeTitle:D,nodeColor:M,planeStrokeColor:_,edgeColor:s,edgeConfidence:G,selectNode:rt,visibleEdgeIdxsAll:f,opacityByConfidenceEl:S,labelDensityEl:B,bfsDepths:P}=e;function Z(b){const j=t.summary&&t.summary.focus_ids&&t.summary.focus_ids.length?t.summary.focus_ids:t.nodes.length?[t.nodes[0].id]:[],x=r.layoutCenter==="selected"&&b!=null?[b]:j;if(!x.length)return;const N=f(),p=r.layoutAlgo||"radial";let X=new Map,lt=1e3,ct=800;if(p==="type_columns"){const w=new Map;for(const h of t.nodes){if(!A(h))continue;const d=String(h.entity_type||"Entity");w.has(d)||w.set(d,[]),w.get(d).push(h)}const C=Array.from(w.keys()).sort((h,d)=>h.localeCompare(d));for(const h of C)w.get(h).sort((d,n)=>d.id-n.id);const T=80,V=220,k=70,H=Math.max(1,...C.map(h=>w.get(h).length));lt=Math.max(1e3,T*2+C.length*V),ct=Math.max(800,T*2+H*k);for(let h=0;h<C.length;h++){const d=C[h],n=w.get(d);for(let m=0;m<n.length;m++){const i=T+h*V+V/2,y=T+m*k+k/2;X.set(n[m].id,{x:i,y,d:0})}}}else if(p==="random"){let w=function(V){let k=(V^C)>>>0;return k^=k<<13,k>>>=0,k^=k>>>17,k>>>=0,k^=k<<5,k>>>=0,k>>>0};const C=(Number(r.layoutSeed||0)^2654435769)>>>0,T=80;lt=1e3,ct=800;for(const V of t.nodes){if(!A(V))continue;const k=w(V.id*2654435761),H=w(V.id*1597334677+1013904223),h=T+k/4294967295*(lt-2*T),d=T+H/4294967295*(ct-2*T);X.set(V.id,{x:h,y:d,d:0})}}else{const w=P(x,N),C=Math.max(...Array.from(w.values()),0),T=[];for(let k=0;k<=C;k++)T.push([]);for(const k of t.nodes){if(!A(k))continue;const H=w.has(k.id)?w.get(k.id):C+1;T[H]||(T[H]=[]),T[H].push(k)}for(const k of T)k.sort((H,h)=>H.id-h.id);const V=80;if(p==="grid"){const h=Math.max(1,...T.map(d=>d?d.length:0));lt=Math.max(1e3,V*2+h*90),ct=Math.max(800,V*2+T.length*90);for(let d=0;d<T.length;d++){const n=T[d];if(!n||!n.length)continue;const m=n.length,i=lt-2*V,y=Math.max(0,(m-1)*90),F=V+Math.max(0,(i-y)/2);for(let $=0;$<m;$++){const Y=F+$*90,z=V+d*90+90/2;X.set(n[$].id,{x:Y,y:z,d})}}}else{lt=1e3,ct=800;const k=lt/2,H=ct/2,h=120,d=40;for(let n=0;n<T.length;n++){const m=T[n];if(!m||!m.length)continue;const i=d+n*h,y=m.length,F=(Number(r.layoutSeed||0)+n*97)%Math.max(1,y);for(let $=0;$<y;$++){const Y=($+F)%y,z=2*Math.PI*Y/y-Math.PI/2,dt=k+i*Math.cos(z),U=H+i*Math.sin(z);X.set(m[$].id,{x:dt,y:U,d:n})}}}}o.getAttribute("viewBox")||o.setAttribute("viewBox",`0 0 ${lt} ${ct}`),o.innerHTML="";const it=document.createElementNS("http://www.w3.org/2000/svg","defs");it.innerHTML=`
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#666"></path>
    </marker>
  `,o.appendChild(it);let mt=1/0,at=1/0,E=-1/0,I=-1/0,g=0;const K=B?String(B.value||"smart"):"smart",O=K==="all"?!0:K==="none"?!1:g<=900;for(const w of t.nodes){if(!A(w))continue;const C=X.get(w.id);C&&(mt=Math.min(mt,C.x),at=Math.min(at,C.y),E=Math.max(E,C.x),I=Math.max(I,C.y),g++)}Number.isFinite(mt)&&Number.isFinite(at)&&Number.isFinite(E)&&Number.isFinite(I)?r.layoutBounds={minX:mt,minY:at,maxX:E,maxY:I,W:lt,H:ct}:r.layoutBounds={minX:0,minY:0,maxX:lt,maxY:ct,W:lt,H:ct};const J=2200,ot=new Set(r.pathEdgeIdxs||[]);let Q=N.slice();if(Q.length>J){const w=new Set(Q.slice(0,J));for(const C of ot)w.add(C);Q=Array.from(w).sort((C,T)=>C-T)}const W=new Set;if(b!=null)for(const w of N){const C=t.edges[w];C.source===b&&W.add(C.target),C.target===b&&W.add(C.source)}for(const w of Q){const C=t.edges[w],T=X.get(C.source),V=X.get(C.target);if(!T||!V)continue;const k=document.createElementNS("http://www.w3.org/2000/svg","line");k.setAttribute("x1",T.x),k.setAttribute("y1",T.y),k.setAttribute("x2",V.x),k.setAttribute("y2",V.y);const H=ot.has(w),h=b!=null&&(C.source===b||C.target===b),d=G(C);k.setAttribute("stroke",H?"#ff006e":s(C));const m=(H?2.8:h?2.1:C.kind==="equivalence"?1.5:1.2)*(.85+.3*d);k.setAttribute("stroke-width",String(m.toFixed(2)));const i=H?.95:b!=null&&!h?.45:.85,y=S&&S.checked?.2+.8*d:1;k.setAttribute("opacity",String((i*y).toFixed(3))),C.kind==="equivalence"&&k.setAttribute("stroke-dasharray","4 4"),(C.kind==="meta_relation"||C.kind==="meta_virtual")&&k.setAttribute("stroke-dasharray","2 4"),k.setAttribute("marker-end","url(#arrow)");const F=document.createElementNS("http://www.w3.org/2000/svg","title"),$=C.confidence!=null?` (${Number(C.confidence).toFixed(3)})`:"";F.textContent=`${C.label}${$}`,k.appendChild(F),o.appendChild(k)}for(const w of t.nodes){if(!A(w))continue;const C=X.get(w.id);if(!C)continue;const T=document.createElementNS("http://www.w3.org/2000/svg","g");T.setAttribute("data-id",String(w.id)),T.style.cursor="pointer";const V=document.createElementNS("http://www.w3.org/2000/svg","circle");V.setAttribute("cx",C.x),V.setAttribute("cy",C.y);const k=w.id===b,H=W.has(w.id),h=r.highlightIds&&r.highlightIds.has(w.id),d=k?12:H||h?10:9;if(V.setAttribute("r",String(d)),V.setAttribute("fill",M(w)),V.setAttribute("stroke",_(w)),V.setAttribute("stroke-width","2.0"),V.setAttribute("opacity",b!=null&&!k&&!H?"0.65":"1.0"),k||H||h){const i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("cx",C.x),i.setAttribute("cy",C.y),i.setAttribute("r",String(d+3)),i.setAttribute("fill","none"),i.setAttribute("stroke",k?"#2b7fff":H?"#ff006e":"#ff9800"),i.setAttribute("stroke-width","2.2"),i.setAttribute("opacity",b!=null&&!k&&!H?"0.55":"0.95"),T.appendChild(i)}if(T.appendChild(V),K==="none"?k||H||h:O||k||H||h){const i=document.createElementNS("http://www.w3.org/2000/svg","text");i.setAttribute("x",C.x),i.setAttribute("y",C.y-14),i.setAttribute("text-anchor","middle"),i.setAttribute("font-size","10"),i.setAttribute("fill","#333"),i.setAttribute("stroke","#fff"),i.setAttribute("stroke-width","3.5"),i.setAttribute("paint-order","stroke"),i.setAttribute("stroke-linejoin","round");const y=R(w)||`${w.entity_type}#${w.id}`;i.textContent=y.length>24?y.slice(0,24)+"…":y,i.setAttribute("opacity",b!=null&&!k&&!H?"0.65":"1.0"),T.appendChild(i)}T.addEventListener("click",i=>rt(w.id,i.shiftKey));const m=document.createElementNS("http://www.w3.org/2000/svg","title");m.textContent=D?D(w):`${w.entity_type}#${w.id}`,T.appendChild(m),o.appendChild(T)}}return{renderGraph:Z}}async function gn(e){const{serverControlsEl:t,graph:r,ui:o,selectedIdRef:a,setLlmStatus:u,setWorldModelStatus:l,llmHistoryStorageKey:A,loadLlmHistoryForKey:c,renderLlmChat:R,draftOverlayStorageKey:D,loadDraftOverlayForKey:M,saveDraftOverlay:_,renderDraftOverlayReview:s,getLlmHistory:G,setLlmHistory:rt,getLlmHistoryKey:f,setLlmHistoryKey:S,getDraftOverlayKey:B,setDraftOverlayKey:P,pickRandomComponentNode:Z,llmStatusEl:b,wmStatusEl:j}=e;if(!t)return;const x=window.location&&window.location.protocol;if(x==="http:"||x==="https:")try{let N=function(L){const ut=new URLSearchParams(window.location.search||"");L?ut.set("snapshot",L):ut.delete("snapshot"),window.location.search=ut.toString()},p=function(L){const ut=new URLSearchParams(window.location.search||"");for(const[nt,st]of Object.entries(L))st==null||st===""?ut.delete(nt):ut.set(nt,String(st));window.location.search=ut.toString()};const[X,lt,ct]=await Promise.all([fetch("/status",{cache:"no-store"}),fetch("/snapshots",{cache:"no-store"}),fetch("/contexts",{cache:"no-store"})]);if(!X.ok||!lt.ok)return;const it=await X.json(),mt=await lt.json(),at=ct&&ct.ok?await ct.json():null;try{const L=it&&it.snapshot&&it.snapshot.accepted_snapshot_id?String(it.snapshot.accepted_snapshot_id):"";L&&localStorage.setItem("axiograph_server_accepted_snapshot_id",L)}catch{}try{const L=A(),ut=f();if(L&&L!==ut){const nt=c(L),st=G();nt.length?rt(nt):st.length&&localStorage.setItem(L,JSON.stringify(st)),S(L),R()}}catch{}try{const L=D(),ut=B();if(L&&L!==ut){const nt=M(L);nt&&nt.proposals_json?(o.draftOverlay=nt,Array.isArray(nt.proposals_json.proposals)?o.draftSelected=new Set(nt.proposals_json.proposals.map(st=>String(st&&st.proposal_id||"")).filter(Boolean)):o.draftSelected=new Set):o.draftOverlay&&localStorage.setItem(L,JSON.stringify(o.draftOverlay)),P(L),_(),s()}}catch{}it&&it.llm&&b&&(it.llm.enabled?u(`ready (${it.llm.backend})`):u("disabled")),it&&it.world_model&&j&&(it.world_model.enabled?l(`ready (${it.world_model.backend})`):l("disabled"));const E=Array.isArray(mt.snapshots)?mt.snapshots:[];if(!E.length)return;const I=mt.layer||"",g=I==="pathdb"?it.snapshot&&it.snapshot.pathdb_snapshot_id:it.snapshot&&it.snapshot.accepted_snapshot_id,O=new URLSearchParams(window.location.search||"").get("snapshot")||g||E[0].snapshot_id,J=E.findIndex(L=>L.snapshot_id===O),ot=document.createElement("span");ot.textContent="snapshot:";const Q=document.createElement("button");Q.className="btn",Q.textContent="Head",Q.addEventListener("click",()=>N(null));const W=document.createElement("button");W.className="btn",W.textContent="Newer",W.disabled=!(J>0),W.addEventListener("click",()=>{J>0&&N(E[J-1].snapshot_id)});const w=document.createElement("button");w.className="btn",w.textContent="Older",w.disabled=!(J>=0&&J+1<E.length),w.addEventListener("click",()=>{J>=0&&J+1<E.length&&N(E[J+1].snapshot_id)});const C=document.createElement("select");for(const L of E){const ut=document.createElement("option"),nt=L.message?` — ${L.message}`:"";ut.value=L.snapshot_id,ut.textContent=`${L.snapshot_id}${nt}`,C.appendChild(ut)}C.value=O,C.addEventListener("change",()=>N(C.value));const T=document.createElement("span");T.className="muted",T.textContent=`layer=${I} snapshots=${E.length}`,t.innerHTML="",t.appendChild(ot),t.appendChild(Q),t.appendChild(W),t.appendChild(w),t.appendChild(C),t.appendChild(T);const V=new URLSearchParams(window.location.search||""),k=V.get("focus_name")||"",H=V.get("focus_id")||"",h=["1","true","yes","on"].includes(String(V.get("all")||"").toLowerCase()),d=document.createElement("span");d.textContent="focus:";const n=document.createElement("input");n.placeholder="name",n.value=k||"";const m=document.createElement("input");m.placeholder="id",m.value=H||"",m.style.width="90px";const i=document.createElement("button");i.className="btn",i.textContent="go name",i.addEventListener("click",()=>{const L=(n.value||"").trim();L&&p({focus_name:L,focus_id:null,all:null})});const y=document.createElement("button");y.className="btn",y.textContent="go id",y.addEventListener("click",()=>{const L=(m.value||"").trim();L&&p({focus_id:L,focus_name:null,all:null})});const F=document.createElement("button");F.className="btn",F.textContent="focus selected",F.addEventListener("click",()=>{const L=a();L!=null&&p({focus_id:L,focus_name:null,all:null})});const $=document.createElement("button");$.className="btn",$.textContent=h?"all ✓":"all",$.addEventListener("click",()=>{p({all:"1",focus_name:null,focus_id:null})});const Y=document.createElement("button");Y.className="btn",Y.textContent="neighborhood",Y.disabled=!h,Y.addEventListener("click",()=>{p({all:null})});const z=o.components?o.components.length:0,dt=document.createElement("button");dt.className="btn",dt.textContent=z>1?`other component (${z})`:"other component",dt.disabled=z<2,dt.title=z<2?"No other components (try all view).":"Jump to a different connected component.",dt.addEventListener("click",()=>{let L=null;if(H){const st=Number(H);Number.isFinite(st)&&(L=st)}const ut=a();if(L==null&&ut!=null&&(L=ut),L==null&&r.summary&&Array.isArray(r.summary.focus_ids)&&r.summary.focus_ids.length){const st=Number(r.summary.focus_ids[0]);Number.isFinite(st)&&(L=st)}const nt=Z(L);nt!=null&&p({focus_id:nt,focus_name:null,all:null})});const U=document.createElement("select"),gt=document.createElement("span");gt.textContent="context:";const yt=document.createElement("option");yt.value="",yt.textContent="(focus)",U.appendChild(yt);const et=at&&Array.isArray(at.contexts)?at.contexts:Array.isArray(r.contexts)?r.contexts:[];for(const L of et){const ut=document.createElement("option");ut.value=String(L.id),ut.textContent=L.name?`${L.name} (#${L.id})`:`Context#${L.id}`,U.appendChild(ut)}U.addEventListener("change",()=>{const L=String(U.value||"");L&&p({focus_id:L,focus_name:null,all:null})}),t.appendChild(d),t.appendChild(n),t.appendChild(i),t.appendChild(m),t.appendChild(y),t.appendChild(F),t.appendChild($),t.appendChild(Y),t.appendChild(dt),et.length&&(t.appendChild(gt),t.appendChild(U))}catch{}}function yn(e){const{ui:t,llmStatusEl:r,llmQuestionEl:o,llmAutoCommitEl:a,llmCertifyEl:u,llmVerifyEl:l,llmRequireVerifiedEl:A,llmAskBtn:c,llmToQueryBtn:R,llmClearBtn:D,llmChatEl:M,llmCitationsEl:_,llmDebugEl:s,axqlQueryEl:G,addMessageEl:rt,addAdminTokenEl:f,selectedContextFilter:S,setActiveTab:B,setAxqlStatus:P,rerender:Z,prefillAddFromToolLoop:b,clearHighlights:j,highlightFromToolLoop:x}=e;function N(n){r&&(r.textContent=n||"")}function p(){const n=window.location&&window.location.host?window.location.host:"offline";let m="";try{const i=(localStorage.getItem("axiograph_server_accepted_snapshot_id")||"").trim();i&&(m=i)}catch{}return m||(m=(new URLSearchParams(window.location.search||"").get("snapshot")||"").trim()),m||(m="default"),`axiograph_llm_history_v2:${n}:${m}`}let X=p();function lt(){return X}function ct(n){X=n}function it(n){try{let m=localStorage.getItem(n)||"";if(!m.trim()){const y=window.location&&window.location.host?window.location.host:"offline";m=localStorage.getItem(`axiograph_llm_history_v1:${y}`)||""}if(!m.trim())return[];const i=JSON.parse(m);return Array.isArray(i)?i.map(y=>({role:String(y&&y.role||""),content:String(y&&y.content||""),public_rationale:String(y&&y.public_rationale||""),citations:Array.isArray(y&&y.citations)?y.citations.map(F=>String(F)):[],queries:Array.isArray(y&&y.queries)?y.queries.map(F=>String(F)):[],notes:Array.isArray(y&&y.notes)?y.notes.map(F=>String(F)):[]})).filter(y=>y.role&&y.content):[]}catch{return[]}}function mt(){try{localStorage.setItem(X,JSON.stringify(at))}catch{}}let at=it(X);function E(){return at}function I(n){at=n||[]}function g(n){if(_){if(n==null){_.textContent="";return}try{typeof n=="string"?_.textContent=n:_.textContent=JSON.stringify(n,null,2)}catch{_.textContent=String(n)}}}async function K(n){const m=window.location&&window.location.protocol;if(!(m==="http:"||m==="https:")){g("DocChunk lookup requires server mode (open via `axiograph db serve`).");return}const i=String(n||"").trim();if(i){g(`loading ${i}…`);try{const F=new URLSearchParams(window.location.search||"").get("snapshot"),$=new URLSearchParams;$.set("chunk_id",i),$.set("max_chars","4000"),F&&$.set("snapshot",F);const Y=await fetch(`/docchunk/get?${$.toString()}`),z=await Y.json();if(!Y.ok){g(z);return}g(z);const dt=z&&z.result&&typeof z.result.id=="number"?z.result.id:null;typeof dt=="number"&&(t.highlightIds=new Set([dt]),Z())}catch(y){g(String(y))}}}function O(){if(M){if(M.innerHTML="",!at.length){const n=document.createElement("div");n.className="muted",n.textContent="Ask a question to start a conversation.",M.appendChild(n);return}for(const n of at){const m=document.createElement("div");m.className=`llmmsg ${n.role||"unknown"}`;const i=document.createElement("div");i.className="role",i.textContent=(n.role||"unknown")+":";const y=document.createElement("div");y.className="text",y.textContent=String(n.content||""),m.appendChild(i),m.appendChild(y);const F=n&&typeof n.public_rationale=="string"?n.public_rationale.trim():"";if(F){const z=document.createElement("details");z.style.marginTop="6px";const dt=document.createElement("summary");dt.className="muted",dt.textContent="rationale";const U=document.createElement("pre");U.style.whiteSpace="pre-wrap",U.style.maxHeight="160px",U.style.overflow="auto",U.style.margin="6px 0 0 0",U.textContent=F,z.appendChild(dt),z.appendChild(U),m.appendChild(z)}const $=Array.isArray(n.citations)?n.citations.filter(Boolean):[];if($.length){const z=document.createElement("div");z.className="muted",z.style.marginTop="6px",z.textContent=`citations (${$.length}): `;for(const dt of $.slice(0,8)){const U=String(dt),gt=document.createElement("button");gt.type="button",gt.className="btn",gt.style.padding="2px 8px",gt.style.marginLeft="6px",gt.textContent=U,gt.title="Open DocChunk",gt.addEventListener("click",()=>K(U)),z.appendChild(gt)}if($.length>8){const dt=document.createElement("span");dt.className="muted",dt.textContent=` +${$.length-8} more`,z.appendChild(dt)}m.appendChild(z)}const Y=Array.isArray(n.queries)?n.queries.filter(Boolean):[];if(Y.length){const z=document.createElement("details");z.style.marginTop="6px";const dt=document.createElement("summary");dt.className="muted",dt.textContent=`queries (${Y.length})`;const U=document.createElement("pre");U.style.whiteSpace="pre-wrap",U.style.maxHeight="200px",U.style.overflow="auto",U.style.margin="6px 0 0 0",U.textContent=Y.join(`
`),z.appendChild(dt),z.appendChild(U),m.appendChild(z)}M.appendChild(m)}M.scrollTop=M.scrollHeight}}function J(n,m,i){const y=i&&typeof i=="object"?i:{};at.push({role:n,content:String(m||""),public_rationale:String(y.public_rationale||""),citations:Array.isArray(y.citations)?y.citations.map(F=>String(F)):[],queries:Array.isArray(y.queries)?y.queries.map(F=>String(F)):[],notes:Array.isArray(y.notes)?y.notes.map(F=>String(F)):[]}),at.length>40&&at.splice(0,at.length-40);for(const F of at)F&&typeof F.content=="string"&&F.content.length>2800&&(F.content=F.content.slice(0,2800)+"…");mt(),O()}O();function ot(){try{const n=localStorage.getItem("axiograph_llm_auto_commit")||"";a&&(a.checked=n==="1"||n==="true"||n==="yes"||n==="on")}catch{}}function Q(){try{if(!a)return;localStorage.setItem("axiograph_llm_auto_commit",a.checked?"1":"0")}catch{}}ot(),a&&a.addEventListener("change",Q);function W(){try{const n=localStorage.getItem("axiograph_llm_certify")||"";u&&(u.checked=n==="1"||n==="true"||n==="yes"||n==="on")}catch{}}function w(){try{if(!u)return;localStorage.setItem("axiograph_llm_certify",u.checked?"1":"0")}catch{}}function C(){try{const n=localStorage.getItem("axiograph_llm_verify")||"";l&&(l.checked=n==="1"||n==="true"||n==="yes"||n==="on")}catch{}}function T(){try{if(!l)return;localStorage.setItem("axiograph_llm_verify",l.checked?"1":"0")}catch{}}function V(){try{const n=localStorage.getItem("axiograph_llm_require_verified")||"";A&&(A.checked=n==="1"||n==="true"||n==="yes"||n==="on")}catch{}}function k(){try{if(!A)return;localStorage.setItem("axiograph_llm_require_verified",A.checked?"1":"0")}catch{}}W(),C(),V(),u&&u.addEventListener("change",w),l&&l.addEventListener("change",T),A&&A.addEventListener("change",k);function H(n){if(s)try{s.textContent=n?JSON.stringify(n,null,2):""}catch{s.textContent=String(n||"")}}async function h(){if(!o)return;const n=String(o.value||"").trim();if(!n)return;const m=window.location&&window.location.protocol;if(!(m==="http:"||m==="https:")){N("LLM requires server mode (open via `axiograph db serve`).");return}const i=at.slice(-40).map($=>({role:String($&&$.role||""),content:String($&&$.content||"")}));J("user",n),N("asking…"),H(null),g(null);const y=S(),F=[];y!=="*"&&y!=="__none__"&&F.push(y);try{const Y=new URLSearchParams(window.location.search||"").get("snapshot"),z=a&&a.checked,dt=(f&&f.value||"").trim(),U={question:n,contexts:F,history:i};Y&&(U.snapshot=Y),u&&u.checked&&(U.certify_queries=!0),l&&l.checked&&(U.verify_queries=!0,U.certify_queries=!0),A&&A.checked&&(U.require_verified_queries=!0,U.verify_queries=!0,U.certify_queries=!0),z&&(U.auto_commit=!0,rt&&String(rt.value||"").trim()?U.commit_message=String(rt.value||"").trim():U.commit_message=`llm: ${n}`);const gt={"content-type":"application/json"};dt&&(gt.authorization=`Bearer ${dt}`);const yt=await fetch("/llm/agent",{method:"POST",headers:gt,body:JSON.stringify(U)}),et=await yt.json();if(!yt.ok){N(`error (${yt.status})`),H(et),J("assistant",et&&et.error?et.error:"LLM request failed.");return}N("ok"),H(et);const L=et&&et.outcome?et.outcome:null;if(L&&L.final_answer&&L.final_answer.answer?J("assistant",L.final_answer.answer,{public_rationale:L.final_answer.public_rationale||"",citations:L.final_answer.citations||[],queries:L.final_answer.queries||[],notes:L.final_answer.notes||[]}):J("assistant","No answer."),b(L))if(z){const nt=et&&et.commit?et.commit:null;if(nt&&nt.ok&&nt.snapshot_id){J("assistant",`Committed WAL snapshot ${nt.snapshot_id}. Reloading…`);const st=new URLSearchParams(window.location.search||"");st.set("snapshot",nt.snapshot_id),window.location.search=st.toString();return}nt&&nt.error?J("assistant",`Auto-commit failed: ${nt.error}`):J("assistant","Auto-commit did not apply any changes (no generated overlay).")}else J("assistant","Review the generated overlay in the Add tab, then click commit to apply it (requires master/admin token).");y.clearHighlights(),x(L),Z()}catch($){N("error"),J("assistant",String($))}}c&&c.addEventListener("click",h);async function d(){if(!o||!G)return;const n=String(o.value||"").trim();if(!n)return;const m=window.location&&window.location.protocol;if(!(m==="http:"||m==="https:")){N("LLM requires server mode (open via `axiograph db serve`).");return}N("to_query…"),H(null);try{const y=new URLSearchParams(window.location.search||"").get("snapshot"),F={question:n};y&&(F.snapshot=y);const $=await fetch("/llm/to_query",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(F)}),Y=await $.json();if(!$.ok){N(`error (${$.status})`),H(Y);return}Y&&typeof Y.axql=="string"&&Y.axql.trim()?(G.value=Y.axql,P("filled from llm"),B("query")):P("LLM returned no query"),N("ok"),H(Y)}catch(i){N("error"),H(String(i))}}return R&&R.addEventListener("click",d),o&&o.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),h())}),D&&D.addEventListener("click",()=>{N(""),at.splice(0,at.length),mt(),O(),H(null),g(null),e.clearHighlights(),Z()}),{setLlmStatus:N,renderLlmChat:O,llmHistoryStorageKey:p,loadLlmHistoryForKey:it,saveLlmHistory:mt,getLlmHistory:E,setLlmHistory:I,getLlmHistoryKey:lt,setLlmHistoryKey:ct,setLlmDebug:H,setLlmCitations:g,highlightFromToolLoop:x}}function vn(e){const{ui:t,axqlStatusEl:r,axqlOutputEl:o,certOutputEl:a,axqlQueryEl:u,axqlRunBtn:l,axqlCertBtn:A,axqlVerifyBtn:c,selectedContextFilter:R,clearHighlights:D,highlightFromQueryResponse:M,rerender:_}=e;function s(S){r&&(r.textContent=S||"")}function G(S){if(o){if(S==null){o.textContent="";return}try{typeof S=="string"?o.textContent=S:o.textContent=JSON.stringify(S,null,2)}catch{o.textContent=String(S)}}}function rt(S){if(a){if(S==null){a.textContent="";return}try{typeof S=="string"?a.textContent=S:a.textContent=JSON.stringify(S,null,2)}catch{a.textContent=String(S)}}}async function f(S,B){if(!u)return;const P=String(u.value||"").trim();if(!P)return;const Z=window.location&&window.location.protocol;if(!(Z==="http:"||Z==="https:")){s("AxQL requires server mode (open via `axiograph db serve`).");return}s(B?"certifying+verifying…":S?"certifying…":"running…"),G(""),rt("");const b=R(),j=[];b!=="*"&&b!=="__none__"&&j.push(b);try{const N=new URLSearchParams(window.location.search||"").get("snapshot"),p={query:P,lang:"axql",show_elaboration:!0,contexts:j,certify:!!S,verify:!!B,include_anchor:!1};N&&(p.snapshot=N);const X=await fetch("/query",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(p)}),lt=await X.json();if(!X.ok){s(`error (${X.status})`),G(lt);return}s("ok"),G(lt),lt&&lt.certificate&&rt(lt.certificate),D(),M(lt),_()}catch(x){s("error"),G(String(x))}}return l&&l.addEventListener("click",()=>f(!1,!1)),A&&A.addEventListener("click",()=>f(!0,!1)),c&&c.addEventListener("click",()=>f(!0,!0)),u&&u.addEventListener("keydown",S=>{(S.ctrlKey||S.metaKey)&&S.key==="Enter"&&(S.preventDefault(),f(!1,!1))}),{setAxqlStatus:s,setAxqlOutput:G,setCertOutput:rt}}function Qt(e){const r=String(e||"").split(/[\n,;]+/g).map(u=>u.trim()).filter(u=>u.length>0),o=new Set,a=[];for(const u of r){const l=u.toLowerCase();o.has(l)||(o.add(l),a.push(u))}return a}function _n(e){const{ui:t,wmGoalsEl:r,wmMaxNewEl:o,wmSeedEl:a,wmStepsEl:u,wmRolloutsEl:l,wmGuardrailProfileEl:A,wmGuardrailPlaneEl:c,wmIncludeGuardrailEl:R,wmTaskCostsEl:D,wmAutoCommitEl:M,wmCommitStepwiseEl:_,wmProposeBtn:s,wmPlanBtn:G,reviewAdminTokenEl:rt,addAdminTokenEl:f,reviewMessageEl:S,addMessageEl:B,setDraftOverlay:P,setAddCommitOutput:Z,setReviewCommitOutput:b,setWorldModelOutput:j,setWorldModelStatus:x,clearDraftOverlay:N,isServerMode:p}=e;function X(E){const I=String(E||"").trim();if(!I)return[];const g=I.split(/\n+/g).map(O=>O.trim()).filter(Boolean),K=[];for(const O of g){const J=O.indexOf("=");if(J<=0)continue;const ot=O.slice(0,J).trim(),Q=O.slice(J+1).trim();if(!ot||!Q)continue;const W=Q.split(":").map(V=>V.trim()).filter(Boolean),w=Number(W[0]);if(!Number.isFinite(w))continue;const C=W.length>1?Number(W[1]):1,T=W.length>2?W.slice(2).join(":"):null;K.push({name:ot,value:w,weight:Number.isFinite(C)?C:1,unit:T||null})}return K}function lt(){const E=Qt(r&&r.value||""),I=o?String(o.value||"").trim():"",g=a?String(a.value||"").trim():"",K=I?Number(I):NaN,O=g?Number(g):NaN,J=A?String(A.value||"fast"):"fast",ot=c?String(c.value||"both"):"both",Q=R?!!R.checked:!0,W=X(D&&D.value||""),w={goals:E,guardrail_profile:J,guardrail_plane:ot,include_guardrail:Q,task_costs:W};return Number.isFinite(K)&&(w.max_new_proposals=Math.max(0,Math.floor(K))),Number.isFinite(O)&&(w.seed=Math.max(0,Math.floor(O))),w}function ct(){const E={"content-type":"application/json"},I=(rt&&rt.value||f&&f.value||"").trim();return I&&(E.authorization=`Bearer ${I}`),E}function it(E){if(!E||!Array.isArray(E.steps))return null;const I=[];for(const O of E.steps){const J=O&&O.proposals&&Array.isArray(O.proposals.proposals)?O.proposals.proposals:[];I.push(...J)}if(!I.length)return null;const g=E.trace_id||"world_model_plan";return{version:1,generated_at:String(E.generated_at_unix_secs||Math.floor(Date.now()/1e3)),source:{source_type:"world_model_plan",locator:g},schema_hint:null,proposals:I}}async function mt(){if(x(""),j(null),Z(null),b(null),t.reviewActionStatus="",!p()){x("requires server mode (`axiograph db serve`)");return}const E=lt(),I=u?Number(u.value||""):NaN;if(Number.isFinite(I)&&(E.horizon_steps=Math.max(1,Math.floor(I))),M?!!M.checked:!1){if(!(rt&&rt.value||f&&f.value||"").trim()){x("auto-commit requires admin token");return}E.auto_commit=!0;const O=(S&&S.value||B&&B.value||"").trim();O&&(E.commit_message=O)}try{x("running…");const K=await fetch("/world_model/propose",{method:"POST",headers:ct(),body:JSON.stringify(E)}),O=await K.json();if(j(O),!K.ok){x(`error (${K.status})`);return}if(x("ok"),O&&O.commit&&b(O.commit),O&&O.commit_steps&&b(O.commit_steps),O&&O.commit_steps&&b(O.commit_steps),O&&O.proposals){const J={proposals_json:O.proposals,chunks:[],summary:{source:"world_model_propose",trace_id:O.trace_id}};P(J,{notePrefix:"generated from world model"})}}catch(K){x("error"),j(String(K))}}async function at(){if(x(""),j(null),Z(null),b(null),t.reviewActionStatus="",!p()){x("requires server mode (`axiograph db serve`)");return}const E=lt(),I=u?Number(u.value||""):NaN,g=l?Number(l.value||""):NaN;if(Number.isFinite(I)&&(E.horizon_steps=Math.max(1,Math.floor(I))),Number.isFinite(g)&&(E.rollouts=Math.max(1,Math.floor(g))),M?!!M.checked:!1){if(!(rt&&rt.value||f&&f.value||"").trim()){x("auto-commit requires admin token");return}E.auto_commit=!0,E.commit_stepwise=_?!!_.checked:!1;const J=(S&&S.value||B&&B.value||"").trim();J&&(E.commit_message=J)}try{x("running…");const O=await fetch("/world_model/plan",{method:"POST",headers:ct(),body:JSON.stringify(E)}),J=await O.json();if(j(J),!O.ok){x(`error (${O.status})`);return}x("ok"),J&&J.commit&&b(J.commit);const ot=J&&J.report?it(J.report):null;if(ot&&ot.proposals&&ot.proposals.length){const Q={proposals_json:ot,chunks:[],summary:{source:"world_model_plan",trace_id:J.report&&J.report.trace_id}};P(Q,{notePrefix:"generated from world model plan"})}}catch(O){x("error"),j(String(O))}}return s&&s.addEventListener("click",mt),G&&G.addEventListener("click",at),{setWorldModelStatus:x,setWorldModelOutput:j,mergeWorldModelPlanProposals:it}}function wn(e){const{ui:t,addRelTypeEl:r,addSourceNameEl:o,addTargetNameEl:a,addPairingEl:u,addContextEl:l,addCtxFromFilterBtn:A,addEvidenceTextEl:c,addConfidenceEl:R,addConfidenceValEl:D,addMessageEl:M,addAdminTokenEl:_,addGenerateBtn:s,addCommitBtn:G,addDraftAxiBtn:rt,addPromoteAxiBtn:f,addAxiTextEl:S,addPromoteStatusEl:B,addStatusEl:P,reviewCommitOutputEl:Z,reviewPromoteOutputEl:b,reviewMessageEl:j,reviewAdminTokenEl:x,addOutputEl:N,addCommitOutputEl:p,addPromoteOutputEl:X,currentContextNameFromFilter:lt,setReviewCommitOutput:ct,setReviewPromoteOutput:it,setAddCommitOutput:mt,setAddPromoteOutput:at,setAddPromoteStatus:E,setAddStatus:I,setAddOutput:g,setDraftOverlay:K,clearDraftOverlay:O,setReviewActionStatus:J,isServerMode:ot,updateAddConfidenceLabel:Q,renderDraftOverlayReview:W}=e;async function w(){if(I(""),g(null),mt(null),ct(null),it(null),t.reviewActionStatus="",O(),!ot()){I("requires server mode (`axiograph db serve`)");return}const k=(r&&r.value||"").trim(),H=Qt(o&&o.value||""),h=Qt(a&&a.value||""),d=(c&&c.value||"").trim();if(!k||!H.length||!h.length){I("missing rel/source/target");return}let n=(l&&l.value||"").trim();if(!n){const i=lt();i&&(n=i,l&&(l.value=i))}const m=R?Number(R.value||"0.9"):.9;try{I("generating…");const i=H.length>1||h.length>1,y=(u&&u.value||"cartesian").trim()||"cartesian",F=i?"/proposals/relations":"/proposals/relation",$=i?{rel_type:k,source_names:H,target_names:h,pairing:y,context:n||null,confidence:m,evidence_text:d||null,evidence_locator:"viz_ui"}:{rel_type:k,source_name:H[0],target_name:h[0],context:n||null,confidence:m,evidence_text:d||null,evidence_locator:"viz_ui"},Y=await fetch(F,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify($)}),z=await Y.json();if(!Y.ok){I(`error (${Y.status})`),g(z);return}if(K(z,{notePrefix:"generated"}),z&&z.validation&&z.validation.ok===!1){const dt=z.validation.axi_typecheck&&Array.isArray(z.validation.axi_typecheck.errors)?z.validation.axi_typecheck.errors.length:0,U=z.validation.quality_delta&&z.validation.quality_delta.summary?Number(z.validation.quality_delta.summary.error_count||0):0;t.reviewActionStatus="validation failed",W(),I(`validation failed (typecheck_errors=${dt} quality_errors=${U})`)}else z&&z.validation&&z.validation.ok===!0?(t.reviewActionStatus="validated",W(),I("ok (validated)")):I("ok")}catch(i){I("error"),g(String(i))}}async function C(){if(I(""),mt(null),ct(null),t.reviewActionStatus="",W(),!ot()){I("requires server mode (`axiograph db serve`)");return}const k=currentDraftFiltered();if(!k||!k.proposals_json||!Array.isArray(k.proposals_json.proposals)||!k.proposals_json.proposals.length){I("no draft overlay selected (generate proposals first)");return}if(t.draftOverlay&&t.draftOverlay.validation&&t.draftOverlay.validation.ok===!1){I("refusing to commit: validation failed (fix proposals first)"),t.reviewActionStatus="refusing to commit: invalid",W();return}const H=(j&&j.value||M&&M.value||"").trim();let h=null;try{const i=await fetch("/status",{cache:"no-store"});if(i.ok){const y=await i.json();if(y&&y.snapshot&&y.snapshot.accepted_snapshot_id&&(h=y.snapshot.accepted_snapshot_id),y&&y.role&&String(y.role).toLowerCase()!=="master"){I("commit requires master server (role != master)"),t.reviewActionStatus="commit blocked (role != master)",W();return}}}catch{}const d={accepted_snapshot:h,chunks:Array.isArray(k.chunks)?k.chunks:[],proposals:k.proposals_json,message:H||null},n={"content-type":"application/json"},m=(x&&x.value||_&&_.value||"").trim();m&&(n.authorization=`Bearer ${m}`);try{I("committing…"),t.reviewActionStatus="committing…",W();const i=await fetch("/admin/accept/pathdb-commit",{method:"POST",headers:n,body:JSON.stringify(d)}),y=await i.json();if(mt(y),ct(y),!i.ok){I(`error (${i.status})`),t.reviewActionStatus=`commit error (${i.status})`,W();return}if(I("ok"),t.reviewActionStatus="committed",W(),y&&y.snapshot_id){O();const F=new URLSearchParams(window.location.search||"");F.set("snapshot",y.snapshot_id),window.location.search=F.toString()}}catch(i){I("error"),mt(String(i)),ct(String(i)),t.reviewActionStatus="commit error",W()}}s&&s.addEventListener("click",w),G&&G.addEventListener("click",C);async function T(){if(E(""),at(null),S&&(S.value=""),reviewAxiTextEl&&(reviewAxiTextEl.value=""),t.reviewActionStatus="",W(),!ot()){E("requires server mode (`axiograph db serve`)");return}const k=currentDraftFiltered();if(!k||!k.proposals_json||!Array.isArray(k.proposals_json.proposals)||!k.proposals_json.proposals.length){E("no draft overlay selected (generate proposals first)"),t.reviewActionStatus="no draft overlay",W();return}try{E("drafting…"),t.reviewActionStatus="drafting .axi…",W();const H={proposals:k.proposals_json,infer_constraints:!0},h=await fetch("/discover/draft-axi",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(H)}),d=await h.json();if(at(d),it(d),!h.ok){E(`error (${h.status})`),t.reviewActionStatus=`draft error (${h.status})`,W();return}S&&d&&typeof d.axi_text=="string"&&(S.value=d.axi_text),reviewAxiTextEl&&d&&typeof d.axi_text=="string"&&(reviewAxiTextEl.value=d.axi_text),E("ok"),t.reviewActionStatus="drafted .axi",W()}catch(H){E("error"),at(String(H)),it(String(H)),t.reviewActionStatus="draft error",W()}}async function V(){if(E(""),at(null),it(null),t.reviewActionStatus="",W(),!ot()){E("requires server mode (`axiograph db serve`)"),t.reviewActionStatus="requires server mode",W();return}const k=reviewAxiTextEl&&String(reviewAxiTextEl.value||"").trim()?String(reviewAxiTextEl.value||""):S?String(S.value||""):"";if(!String(k||"").trim()){E("draft .axi text is empty (click 'draft .axi' or paste)"),t.reviewActionStatus="promote blocked: empty .axi",W();return}const H=(x&&x.value||_&&_.value||"").trim();if(!H){E("promote requires admin token"),t.reviewActionStatus="promote blocked: missing token",W();return}try{const m=await fetch("/status",{cache:"no-store"});if(m.ok){const i=await m.json();if(i&&i.role&&String(i.role).toLowerCase()!=="master"){E("promote requires master server (role != master)"),t.reviewActionStatus="promote blocked (role != master)",W();return}}}catch{}const h=(j&&j.value||M&&M.value||"").trim(),d={axi_text:String(k||""),message:h||null,quality:"fast"},n={"content-type":"application/json",authorization:`Bearer ${H}`};try{E("promoting…"),t.reviewActionStatus="promoting…",W();const m=await fetch("/admin/accept/promote",{method:"POST",headers:n,body:JSON.stringify(d)}),i=await m.json();if(at(i),it(i),!m.ok){E(`error (${m.status})`),t.reviewActionStatus=`promote error (${m.status})`,W();return}E("ok"),t.reviewActionStatus="promoted",W()}catch(m){E("error"),at(String(m)),it(String(m)),t.reviewActionStatus="promote error",W()}}return rt&&rt.addEventListener("click",T),f&&f.addEventListener("click",V),{setAddStatus:I,setAddOutput:g,setAddCommitOutput:mt,setAddPromoteOutput:at,setAddPromoteStatus:E,setDraftOverlay:K,clearDraftOverlay:O,commitGeneratedOverlay:C,draftAxiFromGeneratedOverlay:T,promoteDraftAxiText:V}}function xn(e){const{addStatusEl:t,wmStatusEl:r,wmOutputEl:o,reviewStatusEl:a,reviewValidationEl:u,reviewOverlayRawEl:l,reviewCommitOutputEl:A,reviewPromoteOutputEl:c,addOutputEl:R,addCommitOutputEl:D,addPromoteOutputEl:M,addPromoteStatusEl:_}=e;function s(p){t&&(t.textContent=p||"")}function G(p){r&&(r.textContent=p||"")}function rt(p){o&&(p==null?o.textContent="":o.textContent=typeof p=="string"?p:JSON.stringify(p,null,2))}function f(p){a&&(a.innerHTML=p||"")}function S(p){u&&(p==null?u.textContent="":u.textContent=typeof p=="string"?p:JSON.stringify(p,null,2))}function B(p){l&&(p==null?l.textContent="":l.textContent=typeof p=="string"?p:JSON.stringify(p,null,2))}function P(p){A&&(p==null?A.textContent="":A.textContent=typeof p=="string"?p:JSON.stringify(p,null,2))}function Z(p){c&&(p==null?c.textContent="":c.textContent=typeof p=="string"?p:JSON.stringify(p,null,2))}function b(p){R&&(p==null?R.textContent="":R.textContent=JSON.stringify(p,null,2))}function j(p){D&&(p==null?D.textContent="":D.textContent=JSON.stringify(p,null,2))}function x(p){_&&(_.textContent=p||"")}function N(p){M&&(p==null?M.textContent="":M.textContent=JSON.stringify(p,null,2))}return{setAddStatus:s,setAddOutput:b,setAddCommitOutput:j,setAddPromoteStatus:x,setAddPromoteOutput:N,setWorldModelStatus:G,setWorldModelOutput:rt,setReviewStatusHtml:f,setReviewValidation:S,setReviewOverlayRaw:B,setReviewCommitOutput:P,setReviewPromoteOutput:Z}}function En(e){const{ui:t,reviewFilterEl:r,reviewSelectAllBtn:o,reviewSelectNoneBtn:a,reviewClearBtn:u,reviewMessageEl:l,reviewAdminTokenEl:A,reviewCommitBtn:c,reviewDraftAxiBtn:R,reviewPromoteAxiBtn:D,reviewListEl:M,reviewValidationEl:_,reviewAxiTextEl:s,reviewCommitOutputEl:G,reviewPromoteOutputEl:rt,reviewOverlayRawEl:f,addAxiTextEl:S,addMessageEl:B,addAdminTokenEl:P,setReviewStatusHtml:Z,setReviewValidation:b,setReviewOverlayRaw:j,setReviewCommitOutput:x,setReviewPromoteOutput:N,setAddPromoteOutput:p,setAddCommitOutput:X,setAddPromoteStatus:lt,setAddStatus:ct,isServerMode:it,commitGeneratedOverlay:mt,draftAxiFromGeneratedOverlay:at,promoteDraftAxiText:E}=e;function I(){const h=window.location&&window.location.host?window.location.host:"offline";let d="";try{const n=(localStorage.getItem("axiograph_server_accepted_snapshot_id")||"").trim();n&&(d=n)}catch{}return d||(d=(new URLSearchParams(window.location.search||"").get("snapshot")||"").trim()),d||(d="default"),`axiograph_draft_overlay_v1:${h}:${d}`}let g=I();function K(){return g}function O(h){g=h}function J(h){try{const d=localStorage.getItem(h)||"";if(!d.trim())return null;const n=JSON.parse(d);return!n||typeof n!="object"||!n.proposals_json?null:n}catch{return null}}function ot(){try{if(!t.draftOverlay){localStorage.removeItem(g);return}localStorage.setItem(g,JSON.stringify(t.draftOverlay))}catch{}}function Q(){t.draftOverlay=null,t.draftSelected=new Set,ot(),x(null),N(null),w()}function W(h,d){const n=h||null;if(!n||!n.proposals_json)return!1;t.draftOverlay=n;const m=n.proposals_json&&Array.isArray(n.proposals_json.proposals)?n.proposals_json.proposals:[];t.draftSelected=new Set(m.map($=>String($&&$.proposal_id||"")).filter(Boolean)),ot(),w(),setAddOutput(n),X(null),x(null),N(null),p(null),lt(""),S&&(S.value=""),s&&(s.value="");const i=d&&d.notePrefix?String(d.notePrefix):"draft overlay ready",y=n.validation&&n.validation.ok===!0,F=n.validation&&n.validation.ok===!1;return ct(F?`${i} (validation failed; review before commit)`:y?`${i} (validated; review before commit)`:`${i} (review before commit)`),setActiveTab("review"),!0}function w(){if(!M)return;M.innerHTML="";const h=t.draftOverlay;if(!h||!h.proposals_json){Z('<span class="muted">(no draft overlay)</span>'),j(""),b(""),s&&(s.value=""),M.innerHTML='<div class="proprow"><div class="main"><div class="muted">No draft overlay. Generate one in <strong>add</strong> or via <strong>llm</strong>, then review/commit here.</div></div></div>';return}const d=h.proposals_json&&Array.isArray(h.proposals_json.proposals)?h.proposals_json.proposals:[],n=t.draftSelected||new Set,m=h.validation&&h.validation.ok===!0,i=h.validation&&h.validation.ok===!1,y=m?'<span class="chip ok">validated</span>':i?'<span class="chip bad">invalid</span>':'<span class="chip">unvalidated</span>';function F(et){return String(et||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function $(){const et=t.reviewActionStatus?` <span class="muted">— ${F(t.reviewActionStatus)}</span>`:"";Z(`${n.size}/${d.length} selected ${y}${et}`)}$(),j(h),b(h.validation||"");const Y=r&&r.value?String(r.value).trim().toLowerCase():"";function z(et){const L=String(et&&et.kind||""),ut=et&&et.confidence!=null?Number(et.confidence):null,nt=ut!=null&&Number.isFinite(ut)?` conf=${ut.toFixed(2)}`:"";if(L.toLowerCase()==="entity"){const st=et.entity_type||"Entity",St=et.name||"";return`Entity ${st} "${St}"${nt}`}if(L.toLowerCase()==="relation"){const st=et.rel_type||"Relation",St=et.source||"?",kt=et.target||"?";return`Relation ${st}(${St} -> ${kt})${nt}`}return`${L||"Proposal"}${nt}`}function dt(et){if(!Y)return!0;const L=[];for(const nt of["kind","proposal_id","schema_hint","entity_type","name","entity_id","rel_type","relation_id","source","target"])et&&et[nt]!=null&&L.push(String(et[nt]));const ut=Array.isArray(et&&et.evidence)?et.evidence:[];for(const nt of ut.slice(0,4))nt&&nt.chunk_id&&L.push(String(nt.chunk_id)),nt&&nt.locator&&L.push(String(nt.locator));return L.join(" ").toLowerCase().includes(Y)}const U=d.filter(dt);if(!U.length){M.innerHTML='<div class="proprow"><div class="main"><div class="muted">No proposals match the current filter.</div></div></div>';return}const gt=250,yt=U.slice(0,gt);for(const et of yt){const L=String(et&&et.proposal_id||""),ut=document.createElement("div");ut.className="proprow";const nt=document.createElement("input");nt.type="checkbox",nt.checked=L?n.has(L):!1,nt.addEventListener("change",()=>{L&&(nt.checked?n.add(L):n.delete(L),t.draftSelected=n,$())});const st=document.createElement("div");st.className="main";const St=document.createElement("div");St.className="line",St.textContent=z(et);const kt=document.createElement("div");kt.className="sub";const It=Array.isArray(et&&et.evidence)?et.evidence:[],Ht=It.length;kt.textContent=`proposal_id=${L||"?"}${Ht?` evidence=${Ht}`:""}`;const Tt=document.createElement("details"),qt=document.createElement("summary");qt.className="muted",qt.textContent="details";const Bt=document.createElement("pre");if(Bt.style.whiteSpace="pre-wrap",Bt.style.maxHeight="220px",Bt.style.overflow="auto",Bt.style.margin="8px 0 0 0",Bt.textContent=JSON.stringify(et,null,2),Tt.appendChild(qt),Tt.appendChild(Bt),It.length){const Lt=document.createElement("div");Lt.className="muted",Lt.style.marginTop="6px",Lt.textContent="evidence:";for(const Pt of It.slice(0,6)){const Rt=Pt&&Pt.chunk_id?String(Pt.chunk_id):"";if(!Rt)continue;const Ct=document.createElement("button");Ct.type="button",Ct.className="btn",Ct.style.padding="2px 8px",Ct.style.marginLeft="6px",Ct.textContent=Rt,Ct.title="Open DocChunk",Ct.addEventListener("click",()=>openDocChunk(Rt)),Lt.appendChild(Ct)}st.appendChild(Lt)}st.appendChild(St),st.appendChild(kt),st.appendChild(Tt),ut.appendChild(nt),ut.appendChild(st),M.appendChild(ut)}if(U.length>gt){const et=document.createElement("div");et.className="proprow",et.innerHTML=`<div class="main"><div class="muted">Showing ${gt} of ${U.length} matching proposals. Narrow the filter to review more precisely.</div></div>`,M.appendChild(et)}}function C(h){t.reviewActionStatus=h||"",w()}t.draftOverlay=J(g),t.draftOverlay&&t.draftOverlay.proposals_json&&Array.isArray(t.draftOverlay.proposals_json.proposals)&&(t.draftSelected=new Set(t.draftOverlay.proposals_json.proposals.map(h=>String(h&&h.proposal_id||"")).filter(Boolean))),w();function T(){try{const h=localStorage.getItem("axiograph_admin_token")||"";P&&!P.value&&(P.value=h),A&&!A.value&&(A.value=h)}catch{}}function V(){try{const h=A&&A.value?A:P;if(!h)return;const d=(h.value||"").trim();localStorage.setItem("axiograph_admin_token",d),P&&P.value!==d&&(P.value=d),A&&A.value!==d&&(A.value=d)}catch{}}T(),P&&P.addEventListener("change",V),A&&A.addEventListener("change",V);function k(){try{const h=localStorage.getItem("axiograph_commit_message")||"";B&&!B.value&&(B.value=h),l&&!l.value&&(l.value=h)}catch{}}function H(){try{const h=l&&l.value?l:B;if(!h)return;const d=(h.value||"").trim();localStorage.setItem("axiograph_commit_message",d),B&&B.value!==d&&(B.value=d),l&&l.value!==d&&(l.value=d)}catch{}}return k(),B&&B.addEventListener("change",H),l&&l.addEventListener("change",H),r&&r.addEventListener("input",w),o&&o.addEventListener("click",()=>{!t.draftOverlay||!t.draftOverlay.proposals_json||!Array.isArray(t.draftOverlay.proposals_json.proposals)||(t.draftSelected=new Set(t.draftOverlay.proposals_json.proposals.map(h=>String(h&&h.proposal_id||"")).filter(Boolean)),w())}),a&&a.addEventListener("click",()=>{t.draftSelected=new Set,w()}),u&&u.addEventListener("click",Q),c&&c.addEventListener("click",mt),R&&R.addEventListener("click",at),D&&D.addEventListener("click",E),{draftOverlayStorageKey:I,loadDraftOverlayForKey:J,saveDraftOverlay:ot,getDraftOverlayKey:K,setDraftOverlayKey:O,clearDraftOverlay:Q,setDraftOverlay:W,setReviewActionStatus:C,renderDraftOverlayReview:w}}function Sn(e){const{ui:t,rerender:r,layoutAlgoEl:o,layoutCenterEl:a,layoutRefreshBtn:u,labelDensityEl:l}=e;function A(){try{const M=localStorage.getItem("axiograph_viz_layout_algo"),_=localStorage.getItem("axiograph_viz_layout_center");M&&(t.layoutAlgo=M),_&&(t.layoutCenter=_)}catch{}o&&(o.value=t.layoutAlgo||"radial"),a&&(a.value=t.layoutCenter||"focus")}function c(){try{localStorage.setItem("axiograph_viz_layout_algo",t.layoutAlgo||"radial"),localStorage.setItem("axiograph_viz_layout_center",t.layoutCenter||"focus")}catch{}}A(),o&&o.addEventListener("change",()=>{t.layoutAlgo=String(o.value||"radial"),c(),R(),r()}),a&&a.addEventListener("change",()=>{t.layoutCenter=String(a.value||"focus"),c(),r()}),u&&u.addEventListener("click",()=>{t.layoutSeed=Number(t.layoutSeed||0)+1>>>0,r()});function R(){const M=Array.from(document.querySelectorAll("[data-layout-preset]"));for(const _ of M){const s=_.getAttribute("data-layout-preset")||"";_.classList.toggle("active",s===t.layoutAlgo)}}const D=Array.from(document.querySelectorAll("[data-layout-preset]"));for(const M of D)M.addEventListener("click",()=>{const _=M.getAttribute("data-layout-preset")||"";_&&(o&&(o.value=_),t.layoutAlgo=_,c(),R(),r())});if(R(),l){try{const M=localStorage.getItem("axiograph_viz_label_density");M&&(l.value=M)}catch{}l.addEventListener("change",()=>{try{localStorage.setItem("axiograph_viz_label_density",String(l.value||""))}catch{}r()})}}function bn(e){const{factContexts:t,contextNameById:r,contextFilterEl:o}=e;if(!o)return;if(o.innerHTML="",!(t.size>0)){const c=document.createElement("option");c.value="*",c.textContent="(no contexts)",o.appendChild(c),o.disabled=!0;return}function u(c,R){const D=document.createElement("option");D.value=c,D.textContent=R,o.appendChild(D)}u("*","(all)"),u("__none__","(no context)");const l=new Set;for(const c of t.values())for(const R of c.values())l.add(R);const A=Array.from(l).sort((c,R)=>c-R);for(const c of A){const R=r.get(c)||`Context#${c}`;u(String(c),R)}e.updateContextBadge&&e.updateContextBadge()}function kn(e){const{contextFilterEl:t}=e;return!t||t.disabled?"*":String(t.value||"*")}function oe(e){const{contextNameById:t,contextFilterEl:r}=e;if(!r)return null;const o=r.value||"*";if(o==="*"||o==="__none__")return null;const a=Number(o);return Number.isFinite(a)&&t.get(a)||null}function Cn(e){const{contextBadgeEl:t,contextFilterEl:r,contextNameById:o}=e;if(!t||!r)return;const a=String(r.value||"*");if(a==="*"){t.style.display="none",t.textContent="";return}let u="context";if(a==="__none__")u="context: none";else{const l=Number(a);u=`context: ${Number.isFinite(l)?o.get(l)||`Context#${l}`:String(a)}`}t.textContent=u,t.style.display="inline-flex"}function bt(e){const{ui:t,pathStatusEl:r}=e;if(!r)return;const o=t.pathMessage?` — ${t.pathMessage}`:"";if(t.pathStart==null){r.textContent="";return}if(t.pathEnd==null){r.textContent=`path: start=${t.pathStart}${o}`;return}if(!t.pathEdgeIdxs.length){r.textContent=`path: ${t.pathStart} → ${t.pathEnd} (no path)${o}`;return}r.textContent=`path: ${t.pathStart} → ${t.pathEnd} (${t.pathEdgeIdxs.length} edges)${o}`}function se(e){const{ui:t}=e;t.pathStart=null,t.pathEnd=null,t.pathEdgeIdxs=[],t.pathMessage="",bt(e)}function An(e,t,r){const{graph:o,isEdgeVisible:a}=e,u=[];for(let _=0;_<o.edges.length;_++)a(o.edges[_])&&u.push(_);const l=new Map;function A(_,s,G){l.has(_)||l.set(_,[]),l.get(_).push({to:s,edgeIdx:G})}for(const _ of u){const s=o.edges[_];A(s.source,s.target,_),A(s.target,s.source,_)}const c=[],R=new Map;for(c.push(t),R.set(t,null);c.length;){const _=c.shift();if(_===r)break;const s=l.get(_)||[];for(const G of s)R.has(G.to)||(R.set(G.to,{node:_,edgeIdx:G.edgeIdx}),c.push(G.to))}if(!R.has(r))return[];const D=[];let M=r;for(;M!==t;){const _=R.get(M);if(!_)break;D.push(_.edgeIdx),M=_.node}return D.reverse(),D}function Bn(e){const{rerender:t,clearPathBtn:r}=e;r&&r.addEventListener("click",()=>{se(e),t()}),bt(e)}function $n(e){const{ui:t,graph:r,nodeById:o,runOnlyEl:a,contextFilterEl:u,show_plane_accepted:l,show_plane_evidence:A,show_plane_data:c,show_entity:R,show_fact:D,show_morphism:M,show_homotopy:_,show_meta:s,show_edge_relation:G,show_edge_equivalence:rt,show_edge_meta:f,minConfidenceEl:S,minConfidenceValEl:B,opacityByConfidenceEl:P,rerender:Z,factContexts:b,isTupleLike:j,runIdForNode:x,clamp01:N}=e;function p(){return S?N(Number(S.value)):0}function X(){B&&(B.textContent=p().toFixed(2))}function lt(E){return E.confidence==null?1:N(Number(E.confidence))}function ct(E){return E?E.kind==="equivalence"?"equivalence":typeof E.kind=="string"&&E.kind.startsWith("meta")?"meta":"relation":"relation"}function it(E){if(!E)return!1;const I=E.plane?String(E.plane):"";if(I==="accepted"&&!l.checked||I==="evidence"&&!A.checked||I==="data"&&!c.checked||E.kind==="meta"&&!s.checked||E.kind==="fact"&&!D.checked||E.kind==="morphism"&&!M.checked||E.kind==="homotopy"&&!_.checked||(!E.kind||E.kind==="entity")&&!R.checked)return!1;if(a&&a.checked&&t.activeRunId){const K=x(E);if(!K||K!==t.activeRunId)return!1}const g=u?String(u.value||"*"):"*";if(g!=="*"){if(E.entity_type==="Context")return g==="__none__"?!1:String(E.id)===g;if(j(E)){const K=b.get(E.id);if(g==="__none__")return!K||!K.size;const O=Number(g);return Number.isFinite(O)?K?K.has(O):!1:!0}}return!0}function mt(E){const I=ct(E);if(I==="equivalence"&&!rt.checked||I==="meta"&&!f.checked||I==="relation"&&!G.checked||!it(o.get(E.source))||!it(o.get(E.target)))return!1;const g=p();return!(g>0&&lt(E)<g)}function at(){const E=[];for(let I=0;I<r.edges.length;I++)mt(r.edges[I])&&E.push(I);return E}Object.assign(e,{edgeConfidence:lt,isNodeVisible:it,isEdgeVisible:mt,visibleEdgeIdxsAll:at,updateMinConfidenceLabel:X}),S&&(S.addEventListener("input",()=>{X(),Z()}),X()),P&&P.addEventListener("change",Z);for(const E of[l,A,c,R,D,M,_,s,a,G,rt,f])E&&E.addEventListener("change",Z);u&&u.addEventListener("change",()=>{e.updateContextBadge&&e.updateContextBadge(),Z()})}function In(e){let t=null;function r(){return t}function o(c){const R=e.nodesEl;if(R)for(const D of R.querySelectorAll(".node"))D.classList.toggle("selected",D.dataset.id===String(c))}function a(c,R){t=c,o(c),R&&(e.ui.pathStart==null||e.ui.pathStart!=null&&e.ui.pathEnd!=null?(e.ui.pathStart=c,e.ui.pathEnd=null,e.ui.pathEdgeIdxs=[],e.ui.pathMessage=""):e.ui.pathEnd==null&&(e.ui.pathEnd=c,e.shortestPathEdgeIdxs&&(e.ui.pathEdgeIdxs=e.shortestPathEdgeIdxs(e.ui.pathStart,e.ui.pathEnd)),e.ui.pathMessage=""),e.updatePathStatus&&e.updatePathStatus()),e.renderDetail&&e.renderDetail(c),e.renderGraph&&e.renderGraph(c),e.fetchDescribeEntity&&e.fetchDescribeEntity(c)}function u(){e.ui.highlightIds=new Set}function l(c){const R=new Set,D=c&&Array.isArray(c.rows)?c.rows:[];for(const M of D)if(!(!M||typeof M!="object"))for(const _ of Object.keys(M)){const s=M[_];s&&typeof s.id=="number"&&R.add(s.id)}e.ui.highlightIds=R}function A(c){if(!(!c||typeof c!="object")){if(c.query_result){l(c.query_result);return}if(c.query){l(c.query);return}Array.isArray(c.rows)&&l({rows:c.rows})}}return Object.assign(e,{selectNode:a,selectedIdRef:r,clearHighlights:u,highlightFromQueryResponse:l,highlightFromToolLoop:A}),{selectNode:a,selectedIdRef:r,clearHighlights:u,highlightFromQueryResponse:l,highlightFromToolLoop:A}}function Ln(e){const{ui:t,detailEl:r}=e;function o(a){const u=String(a||"overview");t.detailTab=u;const l=Array.from(r.querySelectorAll(".detailtabbtn")),A=Array.from(r.querySelectorAll(".detailtabpanel"));for(const c of l)c.classList.toggle("active",(c.dataset&&c.dataset.dtab)===u);for(const c of A)c.classList.toggle("active",(c.dataset&&c.dataset.dtab)===u)}return Object.assign(e,{setActiveDetailTab:o}),{setActiveDetailTab:o}}function Nn(e){const{nodeById:t,outEdgesBySource:r,nodeShortLabel:o,parseRelationSignatureFieldOrder:a,isTupleLike:u}=e;function l(f,S){const B=r.get(f)||[];for(const P of B)if(!(!P||P.kind!=="relation")&&String(P.label||"")===S)return P.target;return null}function A(f){if(!f||!u(f))return null;const S=f.attrs&&f.attrs.axi_relation?String(f.attrs.axi_relation):String(f.entity_type||"Tuple"),B=a(f.attrs&&f.attrs.axi_overlay_relation_signature),P=new Map;if(B)for(let x=0;x<B.length;x++)P.set(B[x],x);const Z=r.get(f.id)||[],b=[];for(const x of Z){if(!x||x.kind!=="relation")continue;const N=String(x.label||"");if(!N||N==="axi_fact_of"||N==="axi_fact_in_context"||N.startsWith("axi_"))continue;const p=t.get(x.target),X=p?o(p):String(x.target);b.push({label:N,value:X})}if(!b.length)return S;b.sort((x,N)=>{const p=P.has(x.label)?P.get(x.label):1e4,X=P.has(N.label)?P.get(N.label):1e4;return p!==X?p-X:x.label.localeCompare(N.label)});const j=b.map(x=>`${x.label}=${x.value}`);return`${S}(${j.join(", ")})`}function c(f){if(!f||f.kind!=="fact")return null;const S=f.attrs&&f.attrs.axi_relation?String(f.attrs.axi_relation):String(f.entity_type||"Fact"),B=a(f.attrs&&f.attrs.axi_overlay_relation_signature),P=new Map;if(B)for(let x=0;x<B.length;x++)P.set(B[x],x);const Z=r.get(f.id)||[],b=[];for(const x of Z){if(!x||x.kind!=="relation")continue;const N=String(x.label||"");if(!N||N==="axi_fact_of"||N==="axi_fact_in_context"||N.startsWith("axi_"))continue;const p=t.get(x.target),X=p?o(p):String(x.target);b.push({label:N,value:X})}if(!b.length)return S;b.sort((x,N)=>{const p=P.has(x.label)?P.get(x.label):1e4,X=P.has(N.label)?P.get(N.label):1e4;return p!==X?p-X:x.label.localeCompare(N.label)});const j=b.map(x=>`${x.label}=${x.value}`);return`${S}(${j.join(", ")})`}function R(f){if(!f||f.kind!=="morphism")return null;const S=f.attrs&&f.attrs.axi_relation?String(f.attrs.axi_relation):String(f.entity_type||"Morphism"),B=l(f.id,"from"),P=l(f.id,"to"),Z=B!=null?o(t.get(B)):"",b=P!=null?o(t.get(P)):"";return Z&&b?`${S}: ${Z} → ${b}`:A(f)||S}function D(f){if(!f||f.kind!=="homotopy")return null;const S=f.attrs&&f.attrs.axi_relation?String(f.attrs.axi_relation):String(f.entity_type||"Homotopy"),B=l(f.id,"lhs"),P=l(f.id,"rhs"),Z=B!=null?o(t.get(B)):"",b=P!=null?o(t.get(P)):"";return Z&&b?`${S}: ${Z} ≃ ${b}`:A(f)||S}function M(f){const S=String(f||"").trim();return S?S.length<=10?S:S.slice(0,10)+"…":""}function _(f){const S=String(f||"").trim();if(!S)return"";const P=S.replace(/[?#].*$/,"").split(/[\\/]/g).filter(Z=>Z.length>0);return P.length>=1?P[P.length-1]:S.length>36?S.slice(0,36)+"…":S}function s(f){if(!f||f.entity_type!=="ProposalRun")return null;const S=f.attrs||{},B=M(S.proposals_digest),P=String(S.schema_hint||"").trim(),Z=String(S.source_type||"").trim(),b=_(S.source_locator||S.source||""),j=P||Z||"run";return B&&b?`${j} @ ${b} (${B})`:B?`${j} (${B})`:b?`${j} @ ${b}`:j}function G(f){if(!f||f.entity_type!=="Document")return null;const S=f.attrs||{},B=_(S.document_id||f.name||"");return B?`doc ${B}`:"Document"}function rt(f){if(!f||f.entity_type!=="DocChunk")return null;const S=f.attrs||{},B=_(S.chunk_id||f.name||""),P=l(f.id,"doc_chunk_about"),Z=P!=null?o(t.get(P)):"";return B&&Z?`chunk ${B} (about ${Z})`:B?`chunk ${B}`:Z?`chunk (about ${Z})`:"chunk"}return{firstOutTargetId:l,factSummary:c,tupleFallbackSummary:A,morphismSummary:R,homotopySummary:D,shortenHash:M,shortLocator:_,proposalRunSummary:s,documentSummary:G,docChunkSummary:rt}}function On(e){const{graph:t,ui:r,runFilterEl:o,runOnlyEl:a,runClearBtn:u,runIdForNode:l,selectNode:A,rerender:c}=e;function R(M){if(r.activeRunId=M||null,!r.activeRunId)r.highlightIds=new Set;else{const _=r.runMap.get(r.activeRunId)||[];r.highlightIds=new Set(_),_.length&&A&&A(_[0],!1)}c()}function D(){if(!o)return;o.innerHTML="",r.runMap=new Map;for(const s of t.nodes||[]){const G=l(s);G&&(r.runMap.has(G)||r.runMap.set(G,[]),r.runMap.get(G).push(s.id))}const M=Array.from(r.runMap.keys());if(!M.length){const s=document.createElement("option");s.value="",s.textContent="(no runs)",o.appendChild(s),o.disabled=!0,a&&(a.disabled=!0),u&&(u.disabled=!0);return}M.sort((s,G)=>String(s).localeCompare(String(G)));const _=document.createElement("option");_.value="",_.textContent="(all runs)",o.appendChild(_);for(const s of M){const G=document.createElement("option");G.value=s;const rt=(r.runMap.get(s)||[]).length;G.textContent=rt?`${s} (${rt})`:s,o.appendChild(G)}o.disabled=!1,a&&(a.disabled=!1),u&&(u.disabled=!1),o.addEventListener("change",()=>{const s=String(o.value||"");R(s)}),u&&u.addEventListener("click",()=>{o.value="",R(null)})}return D(),Object.assign(e,{setActiveRun:R}),{setActiveRun:R}}function Mn(e){const{graph:t,ui:r,componentJumpBtn:o,componentStatusEl:a,selectedIdRef:u,selectNode:l,rerender:A}=e;function c(){const _=Array.isArray(t.nodes)?t.nodes:[],s=Array.isArray(t.edges)?t.edges:[];if(!_.length||_.length>8e4||s.length>25e4)return null;const G=new Map;for(const B of _)G.set(B.id,[]);for(const B of s)!G.has(B.source)||!G.has(B.target)||(G.get(B.source).push(B.target),G.get(B.target).push(B.source));const rt=new Set,f=[],S=new Map;for(const B of _){if(rt.has(B.id))continue;const P=[],Z=[B.id];for(rt.add(B.id);Z.length;){const b=Z.pop();P.push(b);const j=G.get(b)||[];for(const x of j)rt.has(x)||(rt.add(x),Z.push(x))}for(const b of P)S.set(b,f.length);f.push(P)}return f.sort((B,P)=>P.length-B.length),{components:f,componentByNode:S}}function R(_){if(!r.components||!r.components.length)return null;const s=_!=null&&r.componentByNode?r.componentByNode.get(_):null,G=[];for(let B=0;B<r.components.length;B++)s!=null&&B===s||G.push(B);const rt=G.length?G:r.components.map((B,P)=>P);if(!rt.length)return null;const f=rt[Math.floor(Math.random()*rt.length)],S=r.components[f];return!S||!S.length?null:S[Math.floor(Math.random()*S.length)]}const D=c();D&&(r.components=D.components,r.componentByNode=D.componentByNode);function M(){if(!o||!a)return;const _=r.components?r.components.length:0;o.disabled=_<2,o.textContent=_>1?`other component (${_})`:"other component",a.textContent=_>1?"jump to another connected component":"single component"}return o&&(o.addEventListener("click",()=>{let _=null;const s=u?u():null;s!=null&&(_=s);const G=R(_);G!=null&&(l&&l(G,!1),A())}),M()),Object.assign(e,{pickRandomComponentNode:R}),{pickRandomComponentNode:R}}function Tn(e){const{ui:t,isServerMode:r,renderDetail:o,selectedIdRef:a}=e;t.describeCache=t.describeCache||new Map;async function u(l){if(!r()||!Number.isFinite(l)||l<=0)return;const A=t.describeCache.get(l);if(!(A&&(A.status==="ok"||A.status==="loading"))){t.describeCache.set(l,{status:"loading",data:null}),a&&a()===l&&o(l);try{const c=new AbortController,R=setTimeout(()=>c.abort(),8e3),D=await fetch(`/entity/describe?id=${encodeURIComponent(String(l))}`,{cache:"no-store",signal:c.signal});clearTimeout(R);const M=await D.json();D.ok?t.describeCache.set(l,{status:"ok",data:M}):t.describeCache.set(l,{status:"error",data:M})}catch(c){t.describeCache.set(l,{status:"error",data:{error:String(c&&c.name==="AbortError"?"timeout":c)}})}a&&a()===l&&o(l)}}return Object.assign(e,{fetchDescribeEntity:u}),{fetchDescribeEntity:u}}function qn(e){return function(r,o){const a=new Map,u=[];for(const A of r||[])a.set(A,0),u.push(A);const l=new Map;for(const A of e.nodes)l.set(A.id,[]);for(const A of o||[]){const c=e.edges[A];c&&(!l.has(c.source)||!l.has(c.target)||(l.get(c.source).push(c.target),l.get(c.target).push(c.source)))}for(;u.length;){const A=u.shift(),c=a.get(A)||0,R=l.get(A)||[];for(const D of R)a.has(D)||(a.set(D,c+1),u.push(D))}return a}}function Pn(e){return function(r){if(r.kind==="equivalence")return"#999";if(r.kind&&String(r.kind).startsWith("meta"))return"#bbb";const o=e.get(r.source);return o&&o.kind==="morphism"?"#2f855a":o&&o.kind==="homotopy"?"#6b46c1":o&&o.kind==="fact"?"#8a5a00":"#666"}}function Rn(){const e=window.location&&window.location.protocol;return e==="http:"||e==="https:"}function Fn(e){const t={content:[],overlay:[],axi:[],other:[]};for(const[r,o]of Object.entries(e||{}))r==="text"||r==="search_text"||r==="markdown"?t.content.push([r,o]):r.startsWith("axi_overlay_")?t.overlay.push([r,o]):r.startsWith("axi_")?t.axi.push([r,o]):t.other.push([r,o]);return t}function Dn(e){const t=tn(),{nodesEl:r,detailEl:o,searchEl:a,svg:u,serverControlsEl:l,show_plane_accepted:A,show_plane_evidence:c,show_plane_data:R,runFilterEl:D,runOnlyEl:M,runClearBtn:_,layoutAlgoEl:s,layoutCenterEl:G,layoutRefreshBtn:rt,layoutFitBtn:f,layoutResetViewBtn:S,labelDensityEl:B,navHelpEl:P,contextFilterEl:Z,contextBadgeEl:b,componentJumpBtn:j,componentStatusEl:x,llmQuestionEl:N,llmAutoCommitEl:p,llmCertifyEl:X,llmVerifyEl:lt,llmRequireVerifiedEl:ct,llmAskBtn:it,llmToQueryBtn:mt,llmClearBtn:at,llmStatusEl:E,llmChatEl:I,llmCitationsEl:g,llmDebugEl:K,wmGoalsEl:O,wmMaxNewEl:J,wmSeedEl:ot,wmStepsEl:Q,wmRolloutsEl:W,wmGuardrailProfileEl:w,wmGuardrailPlaneEl:C,wmIncludeGuardrailEl:T,wmTaskCostsEl:V,wmAutoCommitEl:k,wmCommitStepwiseEl:H,wmProposeBtn:h,wmPlanBtn:d,wmStatusEl:n,wmOutputEl:m,axqlQueryEl:i,axqlRunBtn:y,axqlCertBtn:F,axqlVerifyBtn:$,axqlStatusEl:Y,axqlOutputEl:z,certOutputEl:dt,addRelTypeEl:U,addSourceNameEl:gt,addTargetNameEl:yt,addPairingEl:et,addContextEl:L,addCtxFromFilterBtn:ut,addEvidenceTextEl:nt,addConfidenceEl:st,addConfidenceValEl:St,addMessageEl:kt,addAdminTokenEl:It,addGenerateBtn:Ht,addCommitBtn:Tt,addStatusEl:qt,addOutputEl:Bt,addCommitOutputEl:Lt,addDraftAxiBtn:Pt,addPromoteAxiBtn:Rt,addPromoteStatusEl:Ct,addAxiTextEl:le,addPromoteOutputEl:ce,reviewFilterEl:de,reviewSelectAllBtn:ue,reviewSelectNoneBtn:me,reviewClearBtn:fe,reviewStatusEl:pe,reviewMessageEl:he,reviewAdminTokenEl:ge,reviewCommitBtn:ye,reviewDraftAxiBtn:ve,reviewPromoteAxiBtn:_e,reviewListEl:we,reviewValidationEl:xe,reviewAxiTextEl:Ee,reviewCommitOutputEl:Se,reviewPromoteOutputEl:be,reviewOverlayRawEl:ke,show_entity:Ce,show_fact:Ae,show_morphism:Be,show_homotopy:$e,show_meta:Ie,show_edge_relation:Le,show_edge_equivalence:Ne,show_edge_meta:Oe,clearPathBtn:Me,certifyPathBtn:jt,verifyPathBtn:Kt,pathStatusEl:Te,minConfidenceEl:qe,minConfidenceValEl:Pe,opacityByConfidenceEl:Re}=t,{nodeById:Yt,outEdgesBySource:Fe,inEdgesByTarget:De}=en(e),He=Pn(Yt),je=qn(e);let Vt=()=>{},Gt=()=>{};const ft={pathStart:null,pathEnd:null,pathEdgeIdxs:[],pathMessage:"",highlightIds:new Set,activeRunId:null,runMap:new Map,draftOverlay:null,draftSelected:new Set,reviewActionStatus:"",layoutAlgo:"radial",layoutCenter:"focus",layoutSeed:0,layoutBounds:null,components:null,componentByNode:null},q={graph:e,ui:ft,nodesEl:r,detailEl:o,searchEl:a,svg:u,serverControlsEl:l,nodeById:Yt,outEdgesBySource:Fe,inEdgesByTarget:De,factContexts:new Map,contextNameById:new Map,show_plane_accepted:A,show_plane_evidence:c,show_plane_data:R,runFilterEl:D,runOnlyEl:M,runClearBtn:_,layoutAlgoEl:s,layoutCenterEl:G,layoutRefreshBtn:rt,layoutFitBtn:f,layoutResetViewBtn:S,labelDensityEl:B,navHelpEl:P,contextFilterEl:Z,contextBadgeEl:b,componentJumpBtn:j,componentStatusEl:x,llmQuestionEl:N,llmAutoCommitEl:p,llmCertifyEl:X,llmVerifyEl:lt,llmRequireVerifiedEl:ct,llmAskBtn:it,llmToQueryBtn:mt,llmClearBtn:at,llmStatusEl:E,llmChatEl:I,llmCitationsEl:g,llmDebugEl:K,wmGoalsEl:O,wmMaxNewEl:J,wmSeedEl:ot,wmStepsEl:Q,wmRolloutsEl:W,wmGuardrailProfileEl:w,wmGuardrailPlaneEl:C,wmIncludeGuardrailEl:T,wmTaskCostsEl:V,wmAutoCommitEl:k,wmCommitStepwiseEl:H,wmProposeBtn:h,wmPlanBtn:d,wmStatusEl:n,wmOutputEl:m,axqlQueryEl:i,axqlRunBtn:y,axqlCertBtn:F,axqlVerifyBtn:$,axqlStatusEl:Y,axqlOutputEl:z,certOutputEl:dt,addRelTypeEl:U,addSourceNameEl:gt,addTargetNameEl:yt,addPairingEl:et,addContextEl:L,addCtxFromFilterBtn:ut,addEvidenceTextEl:nt,addConfidenceEl:st,addConfidenceValEl:St,addMessageEl:kt,addAdminTokenEl:It,addGenerateBtn:Ht,addCommitBtn:Tt,addStatusEl:qt,addOutputEl:Bt,addCommitOutputEl:Lt,addDraftAxiBtn:Pt,addPromoteAxiBtn:Rt,addPromoteStatusEl:Ct,addAxiTextEl:le,addPromoteOutputEl:ce,reviewFilterEl:de,reviewSelectAllBtn:ue,reviewSelectNoneBtn:me,reviewClearBtn:fe,reviewStatusEl:pe,reviewMessageEl:he,reviewAdminTokenEl:ge,reviewCommitBtn:ye,reviewDraftAxiBtn:ve,reviewPromoteAxiBtn:_e,reviewListEl:we,reviewValidationEl:xe,reviewAxiTextEl:Ee,reviewCommitOutputEl:Se,reviewPromoteOutputEl:be,reviewOverlayRawEl:ke,show_entity:Ce,show_fact:Ae,show_morphism:Be,show_homotopy:$e,show_meta:Ie,show_edge_relation:Le,show_edge_equivalence:Ne,show_edge_meta:Oe,clearPathBtn:Me,certifyPathBtn:jt,verifyPathBtn:Kt,pathStatusEl:Te,minConfidenceEl:qe,minConfidenceValEl:Pe,opacityByConfidenceEl:Re,isTupleLike:cn,nodeShortLabel:ln,nodeTitle:nn,nodeDisplayName:ie,effectiveTypeLabel:on,nodeColor:rn,edgeColor:He,planeStrokeColor:an,parseRelationSignatureFieldOrder:sn,parseRelationSignature:ae,runIdForNode:dn,escapeHtml:un,clamp01:mn};Object.assign(q,Nn(q)),Object.assign(q,Ln(q));const Jt=Array.from(document.querySelectorAll(".tabbtn")),Xt={explore:document.getElementById("tab_explore"),query:document.getElementById("tab_query"),llm:document.getElementById("tab_llm"),world_model:document.getElementById("tab_world_model"),review:document.getElementById("tab_review"),add:document.getElementById("tab_add")};function Wt(v){const tt=v&&Xt[v]?v:"explore";for(const ht of Jt)ht.classList.toggle("active",(ht.dataset&&ht.dataset.tab)===tt);for(const[ht,vt]of Object.entries(Xt))vt&&vt.classList.toggle("active",ht===tt);try{localStorage.setItem("axiograph_viz_sidebar_tab",tt)}catch{}}function Ke(){if(!Jt.length)return;for(const tt of Jt)tt.addEventListener("click",()=>{const ht=tt.dataset&&tt.dataset.tab||"explore";Wt(ht)});let v="explore";try{const tt=localStorage.getItem("axiograph_viz_sidebar_tab");tt&&(v=tt)}catch{}Wt(v)}if(Ke(),Array.isArray(e.contexts))for(const v of e.contexts){if(!v)continue;const tt=Number(v.id);if(!Number.isFinite(tt))continue;const ht=String(v.name||`Context#${tt}`);q.contextNameById.set(tt,ht)}for(const v of e.nodes)v.entity_type==="Context"&&q.contextNameById.set(v.id,v.name||`Context#${v.id}`);if(e.tuple_contexts&&typeof e.tuple_contexts=="object")for(const[v,tt]of Object.entries(e.tuple_contexts)){const ht=Number(v);if(!Number.isFinite(ht))continue;const vt=Array.isArray(tt)?tt:[];for(const xt of vt){const _t=Number(xt);Number.isFinite(_t)&&(q.factContexts.has(ht)||q.factContexts.set(ht,new Set),q.factContexts.get(ht).add(_t))}}else for(const v of e.edges)v.label==="axi_fact_in_context"&&(q.factContexts.has(v.source)||q.factContexts.set(v.source,new Set),q.factContexts.get(v.source).add(v.target));q.isServerMode=Rn,q.bfsDepths=je;function Zt(v){return fn(q,v)}q.categorizeAttrs=Fn;function Ft(){Zt(a.value);const v=q.selectedIdRef?q.selectedIdRef():null;if(v!=null){for(const tt of r.querySelectorAll(".node"))tt.classList.toggle("selected",tt.dataset.id===String(v));Vt(v),Gt(v)}}q.rerender=Ft,Sn(q),$n(q),q.shortestPathEdgeIdxs=(v,tt)=>An(q,v,tt),q.updatePathStatus=()=>bt(q);const Ve=In(q);Object.assign(q,Ve),Vt=pn(q).renderDetail,Gt=hn(q).renderGraph,q.renderDetail=Vt,q.renderGraph=Gt,Object.assign(q,Tn(q)),Zt(a.value),e.summary&&e.summary.focus_ids&&e.summary.focus_ids.length?q.selectNode(e.summary.focus_ids[0],!1):e.nodes.length&&q.selectNode(e.nodes[0].id,!1),Bn(q),bn(q),Object.assign(q,On(q)),Object.assign(q,Mn(q)),Object.assign(q,{setActiveTab:Wt,selectedContextFilter:()=>kn(q),currentContextNameFromFilter:()=>oe(q),updateContextBadge:()=>Cn(q),prefillAddFromToolLoop:Ge,rerender:Ft}),ut&&ut.addEventListener("click",()=>{const v=oe(q);v&&L&&(L.value=v)});function zt(){if(!st||!St)return;const v=Number(st.value||"0");St.textContent=v.toFixed(2)}st&&st.addEventListener("input",zt),zt(),q.updateAddConfidenceLabel=zt;function Ge(v){if(!v)return!1;const tt=v&&v.artifacts&&v.artifacts.generated_overlay?v.artifacts.generated_overlay:null;if(tt&&tt.proposals_json)return setDraftOverlay(tt,{notePrefix:"generated from LLM"});const ht=Array.isArray(v.steps)?v.steps:[];for(let vt=ht.length-1;vt>=0;vt--){const xt=ht[vt];if(!xt||xt.tool!=="propose_relation_proposals"&&xt.tool!=="propose_relations_proposals"&&xt.tool!=="world_model_propose"&&xt.tool!=="world_model_plan")continue;const _t=xt.result||null;if(!(!_t||!_t.proposals_json))return setDraftOverlay(_t,{notePrefix:"generated from LLM (fallback)"})}return!1}function Je(v,tt){const ht=q.visibleEdgeIdxsAll(),vt=new Map;function xt(wt,Ot,Mt){vt.has(wt)||vt.set(wt,[]),vt.get(wt).push({to:Ot,edgeIdx:Mt})}for(const wt of ht){const Ot=e.edges[wt];Ot.relation_id!=null&&xt(Ot.source,Ot.target,wt)}const _t=[],Et=new Map;for(_t.push(v),Et.set(v,null);_t.length;){const wt=_t.shift();if(wt===tt)break;const Ot=vt.get(wt)||[];for(const Mt of Ot)Et.has(Mt.to)||(Et.set(Mt.to,{node:wt,edgeIdx:Mt.edgeIdx}),_t.push(Mt.to))}if(!Et.has(tt))return[];const $t=[];let At=tt;for(;At!==v;){const wt=Et.get(At);if(!wt)break;$t.push(wt.edgeIdx),At=wt.node}return $t.reverse(),$t}async function te(v){if(ft.pathStart==null||ft.pathEnd==null){ft.pathMessage="shift-click 2 nodes first",bt(q);return}const tt=window.location&&window.location.protocol;if(!(tt==="http:"||tt==="https:")){ft.pathMessage="certification requires server mode",bt(q);return}const ht=Je(ft.pathStart,ft.pathEnd);if(!ht.length){ft.pathMessage="no directed relation path (certifiable)",bt(q);return}ft.pathEdgeIdxs=ht,bt(q),Ft();const vt=[];let xt=ft.pathStart;for(const _t of ht){const Et=e.edges[_t];if(Et.relation_id==null){ft.pathMessage="path contains non-relation edges",bt(q);return}if(Et.source!==xt){ft.pathMessage="path direction mismatch (internal)",bt(q);return}vt.push(Et.relation_id),xt=Et.target}ft.pathMessage=v?"certifying+verifying…":"certifying…",bt(q),q.setCertOutput&&q.setCertOutput("");try{const Et=new URLSearchParams(window.location.search||"").get("snapshot"),$t={start:ft.pathStart,relation_ids:vt,verify:!!v,include_anchor:!1};Et&&($t.snapshot=Et);const At=await fetch("/cert/reachability",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify($t)}),wt=await At.json();if(q.setCertOutput&&q.setCertOutput(wt),!At.ok){ft.pathMessage=`error (${At.status})`,bt(q);return}ft.pathMessage=v?wt.certificate_verified?"verified":"not verified":"ok",bt(q)}catch(_t){ft.pathMessage="error",bt(q),q.setCertOutput&&q.setCertOutput(String(_t))}}jt&&jt.addEventListener("click",()=>te(!1)),Kt&&Kt.addEventListener("click",()=>te(!0));const We=xn(q);Object.assign(q,We);const ze=En(q);Object.assign(q,ze);const Ue=vn(q);Object.assign(q,Ue);const Qe=yn(q);Object.assign(q,Qe);const Ye=_n(q);Object.assign(q,Ye);const Xe=wn(q);Object.assign(q,Xe),gn(q);function Ze(){const v=u.getAttribute("viewBox");if(!v)return{x:0,y:0,w:1e3,h:800};const tt=v.trim().split(/\s+/).map(Number);return tt.length!==4||tt.some(ht=>!Number.isFinite(ht))?{x:0,y:0,w:1e3,h:800}:{x:tt[0],y:tt[1],w:tt[2],h:tt[3]}}const pt=Ze();function Dt(){u.setAttribute("viewBox",`${pt.x} ${pt.y} ${pt.w} ${pt.h}`)}Dt();let Ut=!1,Nt=null;u.addEventListener("wheel",v=>{v.preventDefault();const tt=u.getBoundingClientRect(),ht=pt.x+(v.clientX-tt.left)*(pt.w/tt.width),vt=pt.y+(v.clientY-tt.top)*(pt.h/tt.height),xt=v.deltaY<0?.9:1.1,_t=Math.min(8e3,Math.max(200,pt.w*xt)),Et=Math.min(8e3,Math.max(200,pt.h*xt)),$t=(ht-pt.x)/pt.w,At=(vt-pt.y)/pt.h;pt.x=ht-$t*_t,pt.y=vt-At*Et,pt.w=_t,pt.h=Et,Dt()},{passive:!1}),u.addEventListener("mousedown",v=>{v.altKey&&(Ut=!0,Nt={x:v.clientX,y:v.clientY,vx:pt.x,vy:pt.y},v.preventDefault())}),window.addEventListener("mousemove",v=>{if(!Ut||!Nt)return;const tt=u.getBoundingClientRect(),ht=(v.clientX-Nt.x)*(pt.w/tt.width),vt=(v.clientY-Nt.y)*(pt.h/tt.height);pt.x=Nt.vx-ht,pt.y=Nt.vy-vt,Dt()}),window.addEventListener("mouseup",()=>{Ut=!1,Nt=null});function ee(){if(!ft.layoutBounds)return;const v=90;pt.x=ft.layoutBounds.minX-v,pt.y=ft.layoutBounds.minY-v,pt.w=Math.max(200,ft.layoutBounds.maxX-ft.layoutBounds.minX+v*2),pt.h=Math.max(200,ft.layoutBounds.maxY-ft.layoutBounds.minY+v*2),Dt()}function ne(){const v=ft.layoutBounds&&ft.layoutBounds.W?ft.layoutBounds.W:1e3,tt=ft.layoutBounds&&ft.layoutBounds.H?ft.layoutBounds.H:800;pt.x=0,pt.y=0,pt.w=v,pt.h=tt,Dt()}f&&f.addEventListener("click",ee),S&&S.addEventListener("click",ne),window.addEventListener("keydown",v=>{const tt=v.target&&v.target.tagName?String(v.target.tagName).toLowerCase():"";if(!(tt==="input"||tt==="textarea"||v.isComposing)){if(v.key==="/"&&!v.ctrlKey&&!v.metaKey&&!v.altKey){a&&a.focus(),v.preventDefault();return}if(v.key==="?"&&!v.ctrlKey&&!v.metaKey&&!v.altKey){P&&(P.open=!P.open),v.preventDefault();return}if((v.key==="r"||v.key==="R")&&!v.ctrlKey&&!v.metaKey&&!v.altKey){ft.layoutSeed=Number(ft.layoutSeed||0)+1>>>0,Ft(),v.preventDefault();return}if((v.key==="f"||v.key==="F")&&!v.ctrlKey&&!v.metaKey&&!v.altKey){ee(),v.preventDefault();return}if(v.key==="0"&&!v.ctrlKey&&!v.metaKey&&!v.altKey){ne(),v.preventDefault();return}v.key==="Escape"&&(se(q),Ft())}})}function Hn(e){var a,u;const t=document.getElementById("graph_nodes"),r=document.getElementById("graph_edges"),o=document.getElementById("graph_truncated");t&&(t.textContent=String(((a=e.nodes)==null?void 0:a.length)??0)),r&&(r.textContent=String(((u=e.edges)==null?void 0:u.length)??0)),o&&(o.textContent=String(!!e.truncated))}async function re(e){try{const t=await fetch(e,{cache:"no-store"});return t.ok?await t.json():null}catch{return null}}async function jn(){const t=new URLSearchParams(window.location.search||"").get("data"),r=window.location.protocol==="http:"||window.location.protocol==="https:";let o=null;if(t?o=await re(t):r&&(o=await re("/viz.json"+window.location.search)),!o){console.error("Axiograph viz: missing graph JSON. Use ?data=graph.json or serve from /viz.");return}Hn(o),Dn(o)}jn();
